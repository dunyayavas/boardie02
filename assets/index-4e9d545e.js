(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();const Un="modulepreload",Nn=function(r){return"/boardie02/"+r},gr={},Q=function(e,t,n){if(!t||t.length===0)return e();const s=document.getElementsByTagName("link");return Promise.all(t.map(o=>{if(o=Nn(o),o in gr)return;gr[o]=!0;const i=o.endsWith(".css"),a=i?'[rel="stylesheet"]':"";if(!!n)for(let c=s.length-1;c>=0;c--){const u=s[c];if(u.href===o&&(!i||u.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${o}"]${a}`))return;const d=document.createElement("link");if(d.rel=i?"stylesheet":Un,i||(d.as="script",d.crossOrigin=""),d.href=o,document.head.appendChild(d),i)return new Promise((c,u)=>{d.addEventListener("load",c),d.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${o}`)))})})).then(()=>e()).catch(o=>{const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=o,window.dispatchEvent(i),!i.defaultPrevented)throw o})};function Dn(){return Date.now().toString(36)+Math.random().toString(36).substring(2)}function De(r){const e=r.toLowerCase();return e.includes("twitter.com")||e.includes("x.com")?"Twitter":e.includes("youtube.com")||e.includes("youtu.be")?"YouTube":e.includes("instagram.com")?"Instagram":e.includes("linkedin.com")?"LinkedIn":e.includes("pinterest.com")?"Pinterest":e.includes("tiktok.com")||e.includes("vm.tiktok.com")?"TikTok":"Website"}function Le(r){return r?r.split(",").map(e=>e.trim()).filter(e=>e.length>0):[]}function Fe(r){const e=document.getElementById("tagFilter");if(!e)return;const t=e.value;for(;e.options.length>1;)e.remove(1);if(r&&r.length>0){[...r].sort((o,i)=>{const a=typeof o=="object"&&o!==null&&o.name?o.name.toLowerCase():String(o).toLowerCase(),l=typeof i=="object"&&i!==null&&i.name?i.name.toLowerCase():String(i).toLowerCase();return a.localeCompare(l)}).forEach(o=>{let i,a;if(typeof o=="object"&&o!==null&&o.name)i=o.name,a=JSON.stringify(o);else if(o&&String(o).trim())i=String(o),a=i;else return;const l=document.createElement("option");l.value=a,l.textContent=i,l.dataset.tagName=i,e.appendChild(l)});let s=!1;for(let o=0;o<e.options.length;o++)if(e.options[o].dataset.tagName===t){e.selectedIndex=o,s=!0;break}s||(e.selectedIndex=0)}}function Bn(r,e){const t=Fn(r);if(!t){Mn(e,"Invalid Instagram URL",r);return}const n=document.createElement("div");n.className="instagram-embed-container",n.innerHTML=`
    <blockquote 
      class="instagram-media" 
      data-instgrm-captioned 
      data-instgrm-permalink="https://www.instagram.com/p/${t}/" 
      data-instgrm-version="14">
      <a href="https://www.instagram.com/p/${t}/">View this post on Instagram</a>
    </blockquote>
  `,e.appendChild(n),qn()}function Fn(r){const e=/instagram\.com\/(?:p|reel)\/([A-Za-z0-9_-]+)/i,t=r.match(e);return t?t[1]:""}function Mn(r,e,t=null){r.innerHTML="";const n=document.createElement("div");if(n.className="p-4 bg-red-50 text-red-700 text-center",t){const s=document.createElement("a");s.href=t,s.target="_blank",s.rel="noopener noreferrer",s.className="underline hover:text-red-800",s.textContent=e+" - Open original",n.appendChild(s)}else n.textContent=e;r.appendChild(n)}function qn(){if(window.instgrm){window.instgrm.Embeds&&window.instgrm.Embeds.process&&window.instgrm.Embeds.process();return}if(!document.querySelector('script[src*="//www.instagram.com/embed.js"]')){const r=document.createElement("script");r.src="//www.instagram.com/embed.js",r.async=!0,r.defer=!0,document.body.appendChild(r),r.onload=()=>{window.instgrm&&window.instgrm.Embeds&&window.instgrm.Embeds.process&&window.instgrm.Embeds.process()}}}const fr="https://link-preview-worker.dunyayavas.workers.dev",K=new Map;async function he(r){try{if(K.has(r))return K.get(r);if(r.includes("linkedin.com")){if(he.linkedInFailures&&he.linkedInFailures>3){const e=ze(r);return K.set(r,e),e}try{const e=`${fr}?url=${encodeURIComponent(r)}`,t=new AbortController,n=setTimeout(()=>t.abort(),5e3),s=await fetch(e,{signal:t.signal});if(clearTimeout(n),!s.ok)throw he.linkedInFailures=(he.linkedInFailures||0)+1,new Error(`Failed to fetch LinkedIn metadata: ${s.status}`);const o=await s.json();if(!o.title||o.error){const i=ze(r);return K.set(r,i),i}return he.linkedInFailures=0,delete o.caption,o.realCaption=null,K.set(r,o),o}catch{const t=ze(r);return K.set(r,t),t}}else if(r.includes("pinterest.com"))try{const e=`${fr}?url=${encodeURIComponent(r)}`,t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch Pinterest metadata: ${t.status}`);const n=await t.json();if(!n.title||n.error)throw new Error("Invalid Pinterest metadata");return delete n.caption,n.realCaption=null,K.set(r,n),n}catch{const t={title:"Pinterest",description:"View this content on Pinterest",image:"https://s.pinimg.com/webapp/favicon-56d11a4a.png",url:r,siteName:"Pinterest",realCaption:null};return K.set(r,t),t}else return{title:"Web Page",description:"No metadata available for this URL",image:null,url:r,siteName:new URL(r).hostname}}catch(e){!r.includes("linkedin.com")&&!r.includes("pinterest.com")&&console.error("Error fetching metadata:",e);let t;return r.includes("linkedin.com")?t=ze(r):r.includes("pinterest.com")?t={title:"Pinterest",description:"View this content on Pinterest",image:"https://s.pinimg.com/webapp/favicon-56d11a4a.png",url:r,siteName:"Pinterest",realCaption:null}:t={title:"Web Page",description:"Error fetching metadata",image:null,url:r,siteName:new URL(r).hostname},K.set(r,t),t}}function ze(r){const e=r.toLowerCase(),t={url:r,siteName:"LinkedIn"};let n="unknown";if(e.includes("/posts/")?n="post":e.includes("/pulse/")?n="article":e.includes("/in/")?n="profile":e.includes("/company/")&&(n="company"),t.image="https://cdn-icons-png.flaticon.com/512/174/174857.png",t.caption=zn(n),t.realCaption=null,n==="profile"){const s=/linkedin\.com\/in\/([^\/\?#]+)/i,o=r.match(s);if(o&&o[1]){const i=o[1].replace(/-/g," ");t.title=`${i} | LinkedIn`,t.description=`View ${i}'s profile on LinkedIn, the world's largest professional community.`,t.image="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"}}else if(n==="company"){const s=/linkedin\.com\/company\/([^\/\?#]+)/i,o=r.match(s);if(o&&o[1]){const i=o[1].replace(/-/g," ");t.title=`${i} | LinkedIn`,t.description=`Learn about ${i}, including available jobs, company insights, and more.`,t.image="https://cdn-icons-png.flaticon.com/512/2910/2910791.png"}}else if(n==="post"){const s=/linkedin\.com\/posts\/([^\/\?#]+)/i,o=r.match(s);if(o&&o[1]){const i=o[1].replace(/-/g," ");t.title=`LinkedIn Post by ${i}`,t.description=`Check out this post on LinkedIn by ${i}.`,t.image="https://cdn-icons-png.flaticon.com/512/5968/5968884.png"}}else if(n==="article"){const s=/linkedin\.com\/pulse\/([^\/\?#]+)(?:-([^\/\?#]+))?/i,o=r.match(s);if(o){const i=o[1]?o[1].replace(/-/g," "):"Article",a=o[2]?o[2].replace(/-/g," "):"";t.title=i.charAt(0).toUpperCase()+i.slice(1),t.description=a?`Article by ${a} on LinkedIn`:"Read this article on LinkedIn",t.image="https://cdn-icons-png.flaticon.com/512/2258/2258853.png"}}else t.title="LinkedIn",t.description="View this content on LinkedIn, the world's largest professional network.";return t}function zn(r){const e={profile:"I am excited to share that I have joined a new company as a Senior Developer. Looking forward to this new journey! #NewBeginnings #CareerGrowth",company:"We are thrilled to announce our latest product launch! After months of hard work, our team has created something truly innovative. Check out the link to learn more. #ProductLaunch #Innovation",post:"Just finished an amazing project with my team. It is incredible what we can achieve when we collaborate effectively. #Teamwork #ProjectSuccess",article:"In my latest article, I discuss the future of remote work and how companies can adapt to this new normal. Read more to discover key strategies for success. #RemoteWork #FutureOfWork",unknown:"Sharing some thoughts on LinkedIn about professional development and career growth. What strategies have worked for you? #ProfessionalDevelopment"};return e[r]||e.unknown}function Hn(r,e){const t=document.createElement("div");t.className="bg-gray-100 animate-pulse p-4 h-64 flex items-center justify-center",t.innerHTML='<p class="text-gray-500">Loading Pinterest content...</p>',e.appendChild(t);const n=r.includes("/pin/"),s=r.includes("/board/")||/pinterest\.com\/([^\/]+)\/([^\/]+)\/?$/.test(r)&&!r.includes("/pin/");if(!n&&!s){yt(e,"Invalid Pinterest URL",r);return}let o="",i={username:"",boardName:""};if(n){if(o=Wn(r),!o){yt(e,"Invalid Pinterest pin URL",r);return}}else if(s&&(i=Vn(r),!i.username||!i.boardName)){yt(e,"Invalid Pinterest board URL",r);return}e.querySelectorAll(".pinterest-official-embed, .pinterest-fallback-container").forEach(c=>c.remove());const l=document.createElement("div");if(l.className="pinterest-official-embed",l.style.display="block",n){const c=document.createElement("a");c.href=r,c.setAttribute("data-pin-do","embedPin"),c.setAttribute("data-pin-width","large"),l.appendChild(c)}else if(s){const c=document.createElement("a");c.href=r,c.setAttribute("data-pin-do","embedBoard"),c.setAttribute("data-pin-board-width","180"),c.setAttribute("data-pin-scale-height","400"),c.setAttribute("data-pin-scale-width","60"),c.setAttribute("data-pin-columns","3"),l.appendChild(c)}e.appendChild(l);const d=document.createElement("div");d.className="pinterest-fallback-container",d.style.display="none",e.appendChild(d),Gn(),setTimeout(()=>{l.querySelector("iframe, span[data-pin-href]")?(d.style.display="none",l.style.display="block"):(console.log("Pinterest official embed failed to load, using fallback"),l.style.display="none",d.style.display="block",he(r).then(u=>{Kn(r,d,u,n)}).catch(u=>{console.error("Error fetching Pinterest metadata:",u),Jn(r,d,n,o,i)}))},3e3),t&&t.parentNode&&t.remove()}function Jn(r,e,t,n,s){const o=document.createElement("div");o.className="pinterest-preview-card bg-white border border-gray-200 rounded-lg overflow-hidden";const i=document.createElement("div");i.className="flex items-center p-3 bg-red-50 border-b border-gray-200",i.innerHTML=`
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-6 h-6 mr-2 text-red-600">
      <path fill="currentColor" d="M12 0a12 12 0 0 0-4.37 23.17c-.1-.94-.2-2.4.04-3.44.2-.84 1.3-5.34 1.3-5.34s-.33-.67-.33-1.66c0-1.56.9-2.73 2.02-2.73.96 0 1.42.72 1.42 1.58 0 .96-.61 2.4-.93 3.74-.26 1.1.56 2.01 1.65 2.01 1.97 0 3.5-2.08 3.5-5.09 0-2.66-1.9-4.52-4.62-4.52-3.16 0-5.01 2.36-5.01 4.8 0 .95.37 1.96.82 2.52.1.11.1.2.08.31-.1.37-.3 1.16-.34 1.32-.05.21-.18.26-.4.16-1.5-.7-2.42-2.89-2.42-4.65 0-3.77 2.74-7.25 7.9-7.25 4.14 0 7.36 2.95 7.36 6.9 0 4.11-2.59 7.43-6.18 7.43-1.21 0-2.35-.63-2.74-1.37l-.74 2.84c-.27 1.04-1 2.35-1.49 3.14A12 12 0 1 0 12 0z"/>
    </svg>
    <span class="font-semibold text-gray-800">${t?"Pinterest Pin":"Pinterest Board"}</span>
  `;const a=document.createElement("div");a.className="w-full aspect-square bg-gray-100 flex items-center justify-center",a.innerHTML=`
    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
    </svg>
  `;const l=document.createElement("div");l.className="p-4";const d=document.createElement("p");if(d.className="text-sm text-gray-600 mb-4",t)if(d.textContent="View this Pinterest pin to discover creative ideas and inspiration.",n){const h=document.createElement("p");h.className="text-xs text-gray-500 mt-2",h.textContent=`Pin ID: ${n}`,l.appendChild(d),l.appendChild(h)}else l.appendChild(d);else if(d.textContent="Explore this Pinterest board to discover a collection of related pins and ideas.",l.appendChild(d),s.username&&s.boardName){const h=document.createElement("p");h.className="text-xs text-gray-500 mt-2",h.textContent=`Board by ${s.username}: ${s.boardName.replace(/-/g," ")}`,l.appendChild(h)}const c=document.createElement("div");c.className="mt-2 text-xs text-gray-500 truncate",c.textContent=r,l.appendChild(c);const u=document.createElement("a");u.href=r,u.target="_blank",u.rel="noopener noreferrer",u.className="block w-full py-2 px-4 bg-red-600 hover:bg-red-700 text-white text-center rounded-b-lg transition-colors mt-4",u.textContent=t?"View Pin on Pinterest":"View Board on Pinterest",l.appendChild(u),o.appendChild(i),o.appendChild(a),o.appendChild(l),e.appendChild(o)}function Wn(r){const e=/pinterest\.com\/pin\/([0-9]+)/i,t=r.match(e);return t?t[1]:""}function Vn(r){let e="",t="";const n=/pinterest\.com\/([^\/]+)\/board\/([^\/]+)/i,s=r.match(n);if(s)e=s[1],t=s[2];else{const o=/pinterest\.com\/([^\/]+)\/([^\/]+)\/?$/i,i=r.match(o);i&&!r.includes("/pin/")&&(e=i[1],t=i[2])}return{username:e,boardName:t}}function Gn(){if(window.PinUtils&&window.PinUtils.build){console.log("Pinterest widgets already loaded"),window.PinUtils.build(),setTimeout(wt,500);return}if(document.getElementById("pinterest-widget-script")){console.log("Pinterest script is loading...");return}console.log("Loading Pinterest widget script");const r=document.createElement("script");r.id="pinterest-widget-script",r.async=!0,r.defer=!0,r.src="https://assets.pinterest.com/js/pinit.js",r.onload=function(){if(console.log("Pinterest widget script loaded"),window.PinUtils&&window.PinUtils.build){console.log("Building Pinterest widgets"),window.PinUtils.build(),setTimeout(wt,500);let e=0;const t=setInterval(()=>{if(e>=10){clearInterval(t);return}window.PinUtils&&window.PinUtils.build&&(console.log("Rebuilding Pinterest widgets (delayed)"),window.PinUtils.build(),wt()),e++},500)}},document.body.appendChild(r)}function wt(){console.log("Adjusting Pinterest embeds to fit properly"),document.querySelectorAll(".pinterest-official-embed").forEach(e=>{e.style.textAlign="center",e.style.width="100%",e.style.maxWidth="100%",e.style.margin="0 auto",e.querySelectorAll("iframe").forEach(o=>{o.width<300&&(o.style.minWidth="300px"),o.style.maxWidth="100%"}),e.querySelectorAll('[data-pin-do="embedPin"]').forEach(o=>{o.style.margin="0 auto",o.style.display="block"}),e.querySelectorAll('[data-pin-do="embedBoard"]').forEach(o=>{o.style.width="100%",o.style.maxWidth="100%",o.hasAttribute("data-pin-columns")||o.setAttribute("data-pin-columns","1"),o.parentNode&&(o.parentNode.style.width="100%"),e.querySelectorAll(".pinterest-board-widget").forEach(a=>{a.style.maxWidth="100%",a.style.width="100%"})})})}function Kn(r,e,t,n){const s=document.createElement("div");s.className="pinterest-preview-card bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm";let o="";t.image&&(o+=`
      <div class="pinterest-preview-image-container w-full aspect-square bg-gray-100 overflow-hidden">
        <img src="${t.image}" alt="${t.title||"Pinterest"}" class="w-full h-full object-cover">
      </div>
    `),o+=`
    <div class="flex items-center p-3 ${t.image?"border-t border-gray-200":"bg-red-50 border-b border-gray-200"}">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5 mr-2 text-red-600 flex-shrink-0">
        <path fill="currentColor" d="M12 0a12 12 0 0 0-4.37 23.17c-.1-.94-.2-2.4.04-3.44.2-.84 1.3-5.34 1.3-5.34s-.33-.67-.33-1.66c0-1.56.9-2.73 2.02-2.73.96 0 1.42.72 1.42 1.58 0 .96-.61 2.4-.93 3.74-.26 1.1.56 2.01 1.65 2.01 1.97 0 3.5-2.08 3.5-5.09 0-2.66-1.9-4.52-4.62-4.52-3.16 0-5.01 2.36-5.01 4.8 0 .95.37 1.96.82 2.52.1.11.1.2.08.31-.1.37-.3 1.16-.34 1.32-.05.21-.18.26-.4.16-1.5-.7-2.42-2.89-2.42-4.65 0-3.77 2.74-7.25 7.9-7.25 4.14 0 7.36 2.95 7.36 6.9 0 4.11-2.59 7.43-6.18 7.43-1.21 0-2.35-.63-2.74-1.37l-.74 2.84c-.27 1.04-1 2.35-1.49 3.14A12 12 0 1 0 12 0z"/>
      </svg>
      <span class="font-semibold text-gray-800 text-sm">${t.siteName||"Pinterest"}</span>
    </div>
  `,o+=`
    <div class="p-4">
      <h3 class="font-bold text-gray-900 mb-1 text-base leading-tight">${t.title||(n?"Pinterest Pin":"Pinterest Board")}</h3>
      <p class="text-sm text-gray-600 mb-2 line-clamp-2">${t.description||"View this content on Pinterest"}</p>
      <p class="text-xs text-gray-500 truncate">${r}</p>
    </div>
  `,o+=`
    <a href="${r}" target="_blank" rel="noopener noreferrer" 
       class="block w-full py-2 px-4 bg-red-600 hover:bg-red-700 text-white text-center text-sm font-medium transition-colors">
      Open in Pinterest
    </a>
  `,s.innerHTML=o,e.appendChild(s)}function yt(r,e,t=null){r.innerHTML="";const n=document.createElement("div");if(n.className="p-4 bg-red-50 text-red-700 text-center",t){const s=document.createElement("a");s.href=t,s.target="_blank",s.rel="noopener noreferrer",s.className="underline hover:text-red-800",s.textContent=e+" - Open original",n.appendChild(s)}else n.textContent=e;r.appendChild(n)}function Yn(r,e){const t=document.createElement("div");t.className="bg-gray-100 animate-pulse p-4 h-32 flex items-center justify-center",t.innerHTML='<p class="text-gray-500">Loading LinkedIn content...</p>',e.appendChild(t),he(r).then(n=>{const s=document.createElement("div");s.className="linkedin-preview bg-white rounded-lg overflow-hidden cursor-pointer",s.addEventListener("click",function(){window.open(r,"_blank","noopener,noreferrer")});let o="";n.image&&(o+=`
        <div class="linkedin-preview-image-container w-full aspect-video bg-gray-100 overflow-hidden">
          <img src="${n.image}" alt="${n.title}" class="w-full h-full object-cover">
        </div>
      `),o+=`
      <div class="linkedin-preview-content p-4">
        <div class="flex items-center mb-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5 mr-2 text-blue-700 flex-shrink-0">
            <path fill="currentColor" d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"></path>
          </svg>
          <span class="font-semibold text-gray-800 text-sm">${n.siteName}</span>
        </div>
        <h3 class="font-bold text-gray-900 mb-1 text-base leading-tight">${n.title}</h3>
        
        <!-- We're not showing any captions for LinkedIn posts to avoid mock content -->
        <!-- If we want to show captions in the future, we'll need to extract them from the actual LinkedIn posts -->
        
        <p class="text-sm text-gray-600 mb-2 line-clamp-2">${n.description}</p>
        <p class="text-xs text-gray-500 truncate">${r}</p>
      </div>
    `,s.innerHTML=o,t.remove(),e.appendChild(s)}).catch(n=>{console.error("Error fetching LinkedIn metadata:",n);const s=document.createElement("div");s.className="linkedin-preview bg-white rounded-lg overflow-hidden cursor-pointer",s.addEventListener("click",function(){window.open(r,"_blank","noopener,noreferrer")}),s.innerHTML=`
      <div class="linkedin-preview-content p-4">
        <div class="flex items-center mb-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5 mr-2 text-blue-700 flex-shrink-0">
            <path fill="currentColor" d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"></path>
          </svg>
          <span class="font-semibold text-gray-800 text-sm">LinkedIn</span>
        </div>
        <h3 class="font-bold text-gray-900 mb-1 text-base leading-tight">LinkedIn Content</h3>
        <p class="text-sm text-gray-600 mb-2">View this content on LinkedIn, the world's largest professional network.</p>
        <p class="text-xs text-gray-500 truncate">${r}</p>
      </div>
    `,t.remove(),e.appendChild(s)})}function Qn(r,e){const t=Xn(r);if(!t){Zn(e,"Invalid TikTok URL",r);return}const n=document.createElement("div");n.className="tiktok-embed-container",n.innerHTML=`
    <blockquote class="tiktok-embed" cite="${r}" 
      data-video-id="${t}" 
      style="max-width: 605px; min-width: 325px;">
      <section>
        <a target="_blank" href="https://www.tiktok.com/@tiktok">@tiktok</a>
      </section>
    </blockquote>
  `,e.appendChild(n),es()}function Xn(r){let e=/tiktok\.com\/@[\w.-]+\/video\/(\d+)/i,t=r.match(e);return t?t[1]:(e=/vm\.tiktok\.com\/[\w]+\/?/i,t=r.match(e),t?"shorturl":"")}function Zn(r,e,t){r.innerHTML=`
    <div class="bg-red-50 border border-red-200 text-red-800 rounded-lg p-4">
      <p class="font-medium">${e}</p>
      <p class="text-sm mt-2 break-all">${t}</p>
    </div>
  `}function es(){if(window.tiktokEmbedsLoaded){window.tiktokProcessEmbed&&window.tiktokProcessEmbed();return}if(!document.querySelector('script[src*="//www.tiktok.com/embed.js"]')){const r=document.createElement("script");r.src="https://www.tiktok.com/embed.js",r.async=!0,r.defer=!0,document.body.appendChild(r),window.tiktokEmbedsLoaded=!0,r.onload=()=>{window.tiktokProcessEmbed=()=>{console.log("TikTok embed script loaded")},window.tiktokProcessEmbed()}}}function ts(r,e){try{const n=new URL(r).hostname,s=n.replace(/^www\./,""),o=document.createElement("div");o.className="website-preview rounded-lg overflow-hidden cursor-pointer",o.addEventListener("click",function(){window.open(r,"_blank","noopener,noreferrer")});const a=`
      <div class="website-preview-content">
        <div class="website-preview-header p-4 pb-2 flex items-center">
          <img src="${`https://www.google.com/s2/favicons?domain=${s}&sz=128`}" class="w-6 h-6 mr-2 rounded-sm" onerror="this.style.display='none'">
          <span class="text-sm text-gray-600 truncate">${n}</span>
        </div>
        <div class="website-preview-text p-4 pt-0">
          <h3 class="text-lg font-semibold mb-2 line-clamp-2">${ns(r,s)}</h3>
          <p class="text-sm text-gray-600 mb-2 line-clamp-3">${ss(r)}</p>
        </div>
        <div class="website-preview-image bg-gray-100 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
          </svg>
        </div>
      </div>
    `;o.innerHTML=a,e.appendChild(o),rs(r,o)}catch(t){console.error("Error creating website preview:",t),os(e,"Could not create website preview",r)}}function rs(r,e){const t=`https://image.thum.io/get/width/800/crop/600/noanimate/${r}`,n=e.querySelector(".website-preview-image");if(n){const s=document.createElement("img");s.className="w-full h-full object-cover",s.alt="Website preview",s.onload=function(){n.innerHTML="",n.appendChild(s)},s.onerror=function(){},s.src=t}}function ns(r,e){const n=new URL(r).pathname.split("/").filter(s=>s.length>0);if(n.length>0){let s=n[n.length-1];if(s=s.replace(/\.(html|php|asp|jsp)$/,""),s=s.replace(/[-_]/g," "),s=s.split(" ").map(o=>o.charAt(0).toUpperCase()+o.slice(1)).join(" "),s.length>3)return s}return e.charAt(0).toUpperCase()+e.slice(1)}function ss(r){const e=new URL(r);if(e.hostname.includes("github.com")){const t=e.pathname.split("/").filter(n=>n.length>0);return t.length>=2?`GitHub repository by ${t[0]}`:"GitHub - Where the world builds software"}return e.hostname.includes("medium.com")?"Article on Medium - Where good ideas find you":e.hostname.includes("wikipedia.org")?"Wikipedia article - The Free Encyclopedia":`Web page on ${e.hostname.replace(/^www\./,"")}`}function os(r,e,t){r.innerHTML=`
    <div class="bg-red-50 border border-red-200 text-red-800 rounded-lg p-4">
      <p class="font-medium">${e}</p>
      <p class="text-sm mt-2 break-all">${t}</p>
    </div>
  `}function is(r,e){const t=document.createElement("div");t.className="bg-gray-100 animate-pulse p-4 h-48 flex items-center justify-center",t.innerHTML='<p class="text-gray-500">Loading tweet...</p>',e.appendChild(t);const n=gs(r);if(!n){It(e,"Invalid Twitter URL",r);return}const s=document.createElement("div");s.className="twitter-embed-container",e.appendChild(s);const o=()=>{window.twttr&&window.twttr.widgets?window.twttr.widgets.createTweet(n,s,{theme:"light",dnt:!0,align:"center"}).then(i=>{t.remove()}).catch(i=>{console.error("Error creating Twitter embed:",i),It(e,"Could not load tweet",r)}):setTimeout(o,1e3)};o()}function as(r,e){const t=fs(r);if(!t){It(e,"Invalid YouTube URL");return}const n=document.createElement("div");n.className="bg-gray-100 animate-pulse p-4 h-48 flex items-center justify-center",n.innerHTML='<p class="text-gray-500">Loading YouTube video...</p>',e.appendChild(n);const s=document.createElement("div");s.className="youtube-embed-container";const o=document.createElement("iframe");o.src=`https://www.youtube.com/embed/${t}?origin=${encodeURIComponent(window.location.origin)}&enablejsapi=1`,o.title="YouTube video player",o.setAttribute("frameborder","0"),o.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"),o.setAttribute("allowfullscreen",""),o.setAttribute("loading","lazy"),o.setAttribute("referrerpolicy","strict-origin-when-cross-origin"),o.addEventListener("load",()=>{n&&n.parentNode&&n.remove()}),s.appendChild(o),e.appendChild(s)}function ls(r,e){return Bn(r,e)}function cs(r,e){return Hn(r,e)}function ds(r,e){return Yn(r,e)}function us(r,e){Qn(r,e)}function hs(r,e){return ts(r,e)}function It(r,e,t=null){r.innerHTML="";const n=document.createElement("div");if(n.className="p-4 bg-red-50 text-red-700 text-center",t){const s=document.createElement("a");s.href=t,s.target="_blank",s.rel="noopener noreferrer",s.className="underline hover:text-red-800",s.textContent=e+" - Open original",n.appendChild(s)}else n.textContent=e;r.appendChild(n)}function gs(r){const e=/(?:twitter|x)\.com\/(?:#!\/)?(?:\w+)\/status(?:es)?\/(\d+)/i,t=r.match(e);if(t&&t[1])return t[1];const n=/(?:twitter|x)\.com\/(?:i\/web|intent)\/status\/(\d+)/i,s=r.match(n);return s?s[1]:""}function fs(r){const e=/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/,t=r.match(e);return t?t[1]:""}let de=null,Ae=0;const ms=5e3;function Fr(r,e=!1,t=!1){let n;typeof r=="object"&&r!==null&&r.name?n=r.name:n=String(r);const s=document.createElement("span");s.className="tag",s.dataset.tagName=n,s.dataset.tag=n,s.style.backgroundColor="transparent",s.style.borderColor="#cccccc",s.style.color="#171717",e&&(s.classList.add("cursor-pointer","hover:bg-blue-200"),s.addEventListener("click",i=>{if(i.target.tagName==="BUTTON")return;const a=s.dataset.tag;if(document.getElementById("tagFilterContainer")){const l=new CustomEvent("addTagFilter",{detail:{tag:a}});document.dispatchEvent(l)}else{const l=document.getElementById("tagFilter");if(l){let d=!1;for(let c=0;c<l.options.length;c++)if(l.options[c].value===a){d=!0;break}if(!d){const c=document.createElement("option");c.value=a,c.textContent=a,l.appendChild(c)}l.value=a,l.dispatchEvent(new Event("change"))}}}));const o=document.createElement("span");return o.textContent=n,s.appendChild(o),t&&s.addEventListener("tagDelete",i=>{}),s}function Mr(r,e,t=null){if(e.innerHTML="",!r||r.length===0){const n=document.createElement("span");n.className="text-gray-400 text-sm italic",n.textContent="No tags",e.appendChild(n);return}r.forEach(n=>{const s=Fr(n,!0,!!t);t&&s.addEventListener("tagDelete",o=>{t(o.detail.tag)}),e.appendChild(s)})}function je(r,e,t){if(e.innerHTML="",!r||r.length===0)return;const n=document.createElement("p");n.className="text-sm text-gray-500 mb-2",n.textContent="Suggested tags:",e.appendChild(n);const s=document.createElement("div");s.className="flex flex-wrap gap-1",r.forEach(o=>{const i=Fr(o,!1,!1);i.classList.add("cursor-pointer","hover:bg-blue-200"),i.addEventListener("click",()=>{t(o)}),s.appendChild(i)}),e.appendChild(s)}function se(r){const e=new Map;return r.forEach(t=>{t.tags&&Array.isArray(t.tags)&&t.tags.forEach(n=>{typeof n=="object"&&n!==null&&n.name?e.set(n.name.toLowerCase(),n):typeof n=="string"&&(e.has(n.toLowerCase())||e.set(n.toLowerCase(),n))})}),Array.from(e.values()).sort((t,n)=>{const s=typeof t=="object"&&t!==null&&t.name?t.name.toLowerCase():String(t).toLowerCase(),o=typeof n=="object"&&n!==null&&n.name?n.name.toLowerCase():String(n).toLowerCase();return s.localeCompare(o)})}function $e(r=[]){const e=Date.now(),t=!Ae||e-Ae>ms;if(r.length>0||t||!de){if(console.log("Tag cache miss, refreshing tags cache..."),r.length>0&&de&&!t){console.log("Merging additional posts with cached tags");const n=se(r),s=new Map;de.forEach(o=>{const i=typeof o=="object"&&o.name?o.name.toLowerCase():String(o).toLowerCase();s.set(i,o)}),n.forEach(o=>{const i=typeof o=="object"&&o.name?o.name.toLowerCase():String(o).toLowerCase();s.set(i,o)}),de=Array.from(s.values()).sort((o,i)=>{const a=typeof o=="object"&&o!==null&&o.name?o.name.toLowerCase():String(o).toLowerCase(),l=typeof i=="object"&&i!==null&&i.name?i.name.toLowerCase():String(i).toLowerCase();return a.localeCompare(l)})}else{console.log("Loading all posts for tags cache");const n=window.boardie.loadPosts();de=se(n)}Ae=e}else console.log("Using cached tags, cache age:",e-Ae,"ms");return de}function Te(){console.log("Invalidating tags cache"),Ae=0,de=null}function bt(r){if(!r)return"";let e=String(r).trim().toLowerCase();return e=e.replace(/\/*$/,""),e=e.replace(/^https?:\/\//,""),e=e.replace(/^www\./,""),e=e.replace(/[?&]utm_[^&]*(&|$)/g,"$1"),e=e.replace(/\/\//g,"/"),e=e.replace(/\?$/,""),e}const ps="boardie_posts_",ws="boardie_tags_",ys="boardie_active_filters_";function Jt(r){var t;const e=(t=window.boardie)==null?void 0:t.currentUser;return e&&e.id?`${r}${e.id}`:`${r}anonymous`}function oe(){return Jt(ps)}function Ze(){return Jt(ws)}function bs(){return Jt(ys)}window.boardie=window.boardie||{};function vs(r){console.log("Rendering posts to UI"),G(r),Fe(se(r)),r.length===0&&Ee()}window.boardie.renderPosts=vs;function Wt(r){if(!r||!r.id)return console.log("Invalid post object, cannot update UI"),!1;console.log("Updating single post in UI:",r.id),console.log(`Looking for post card with ID: ${r.id}`);let e=document.querySelector(`.post-card[data-id="${r.id}"]`);if(e||(e=document.querySelector(`.post-card[data-id='${r.id}']`)),!e){const t=document.querySelectorAll(".post-card");console.log(`Found ${t.length} post cards in the DOM`);for(const n of t)if(console.log(`Post card data-id: ${n.dataset.id}, attribute: ${n.getAttribute("data-id")}`),n.dataset.id===r.id||n.getAttribute("data-id")===r.id){e=n,console.log("Found post card by iterating through all cards");break}}if(!e){console.log("Post card not found in DOM after all attempts, will re-render all posts");const t=U(!0);return G(t),!0}return qr(e,r),console.log("Single post UI update complete"),!0}function qr(r,e){if(!r||!e)return;r.dataset.id=e.id,r.dataset.platform=e.platform||De(e.url),r.dataset.url=e.url,r.setAttribute("data-id",e.id);const t=r.querySelector(".post-tags");t&&(t.innerHTML="",Mr(e.tags,t,s=>{Wr(e.id,s)}),Te(),setTimeout(()=>{document.dispatchEvent(new CustomEvent("setupTagFilters"))},100));const n=r.querySelector(".post-embed");if(n){console.log(`Updating embed for post ${e.id} with URL ${e.url}`),n.innerHTML="";const s=e.platform||De(e.url),o=s==="twitter"?"500px":s==="instagram"?"600px":"300px";n.innerHTML=`
      <div class="embed-placeholder bg-gray-100 animate-pulse flex items-center justify-center" 
           style="height: ${o}">
        <p class="text-gray-500">Loading ${s} post...</p>
      </div>
    `,Jr(e.url,s,n),r.classList.remove("opacity-0"),r.classList.add("opacity-100");const i=()=>{const a=n.querySelector(".embed-placeholder");a&&a.remove()};setTimeout(()=>{const a=n.querySelectorAll("iframe"),l=n.querySelectorAll("img");a.length===0&&l.length===0?i():(a&&a.length>0&&a.forEach(d=>{var c;d.complete||((c=d.contentDocument)==null?void 0:c.readyState)==="complete"?i():d.addEventListener("load",i,{once:!0})}),l&&l.length>0&&l.forEach(d=>{d.complete?i():d.addEventListener("load",i,{once:!0})}),setTimeout(i,3e3))},100)}}window.boardie.updateSinglePostInUI=Wt;function U(r=!1){try{const e=oe();console.log(`Loading posts from storage key: ${e}`);const t=localStorage.getItem(e),n=t?JSON.parse(t):[];return r?(console.log("Explicitly rendering posts from loadPosts()"),window.boardie&&window.boardie.safeRenderPosts?window.boardie.safeRenderPosts(n):G(n)):console.log("Not rendering posts in loadPosts() - use window.boardie.safeRenderPosts() to render"),n}catch(e){return console.error("Error loading posts:",e),e instanceof SyntaxError&&(console.log("Attempting to recover from corrupted storage"),localStorage.removeItem(oe())),[]}}function _s(){try{localStorage.removeItem(oe()),localStorage.removeItem(Ze()),localStorage.removeItem(bs()),console.log("Cleared all user data from localStorage")}catch(r){console.error("Error clearing localStorage:",r)}}function Z(r){try{const e=oe();console.log(`Saving posts to storage key: ${e}`),localStorage.setItem(e,JSON.stringify(r))}catch(e){console.error("Error saving posts:",e)}}function Vt(){try{const r=Ze();console.log(`Loading tags from storage key: ${r}`);const e=localStorage.getItem(r);return e?JSON.parse(e):[]}catch(r){return console.error("Error loading tags:",r),r instanceof SyntaxError&&(console.log("Attempting to recover from corrupted tags storage"),localStorage.removeItem(Ze())),[]}}function zr(r){try{const e=Ze();console.log(`Saving tags to storage key: ${e}`),localStorage.setItem(e,JSON.stringify(r))}catch(e){console.error("Error saving tags:",e)}}function Hr(r,e=[],t=!1){let n=[];try{const l=oe();console.log(`Loading existing posts from storage key: ${l}`);const d=localStorage.getItem(l);n=d?JSON.parse(d):[]}catch(l){console.error("Error loading existing posts:",l),n=[]}const s=bt(r);if(!s)return console.error("Invalid URL provided to addPost:",r),null;const o=n.find(l=>bt(l.url)===s);if(console.log(`Checking for duplicate URL: ${r}`),console.log(`Normalized as: ${s}`),o&&(console.log(`Found duplicate: ${o.url}`),console.log(`Normalized duplicate: ${bt(o.url)}`)),o)return console.log("Post with this URL already exists:",o),null;const i=De(r),a={id:Dn(),url:r,platform:i,tags:e,dateAdded:new Date().toISOString()};return n.push(a),Z(n),Te(),t?console.log("Skipping render after adding new post"):(console.log("Rendering posts after adding new post"),Fe(se(n)),document.dispatchEvent(new CustomEvent("setupTagFilters"))),document.getElementById("noPostsMessage").classList.add("hidden"),a}async function mr(r,e=!1,t=!1){console.log(`Deleting post with ID: ${r}`);const n=et(r),o=U(!1).filter(a=>a.id!==r);Z(o),Te();const i=document.querySelector(`.post-card[data-id="${r}"]`);if(i?(console.log("Removing post element from DOM:",r),i.remove(),o.length===0&&Ee()):e||(console.log("Post element not found in DOM, re-rendering all posts"),G(o)),Fe(se(o)),setTimeout(()=>{document.dispatchEvent(new CustomEvent("setupTagFilters"))},100),!t&&window.boardie&&window.boardie.isAuthenticated)try{console.log("User is logged in, syncing deletion with Supabase...");const{deletePost:a}=await Q(()=>Promise.resolve().then(()=>ea),void 0);if(n&&n.id){const l=await a(n.id);return console.log(`Post deletion ${l?"succeeded":"failed"} in Supabase`),l}else return console.warn("Post not found in local storage, cannot sync deletion with Supabase"),!1}catch(a){return console.error("Error syncing post deletion with Supabase:",a),!1}return!0}function et(r){console.log("Getting post by ID:",r);let e=[];try{const n=oe();console.log(`Loading posts from storage key: ${n}`);const s=localStorage.getItem(n);e=s?JSON.parse(s):[],console.log("Loaded posts from localStorage:",e.length)}catch(n){return console.error("Error loading post by ID:",n),null}const t=e.find(n=>n.id===r);return t?console.log("Found post:",t):console.error("Post not found with ID:",r),t||null}function Es(r,e,t,n=!1,s=!1){console.log("Updating post:",r,"Skip render:",n,"Update UI only:",s);let o=[];try{const a=oe();console.log(`Loading posts for update from storage key: ${a}`);const l=localStorage.getItem(a);o=l?JSON.parse(l):[]}catch(a){return console.error("Error loading posts for update:",a),!1}const i=o.findIndex(a=>a.id===r);if(i!==-1){const a=De(e),l=o[i],d=l.url!==e,c=l.platform!==a;let u=!1;if(l.tags.length!==t.length?u=!0:u=t.some((h,f)=>{const w=l.tags[f];return typeof h=="object"&&h!==null&&h.name?typeof w=="object"&&w!==null&&w.name?h.name!==w.name:!0:typeof h=="string"&&typeof w=="string"?h!==w:!0}),d||c||u){console.log("Post has changed, updating...");const h={...o[i],url:e,platform:a,tags:t,updatedAt:new Date().toISOString()};if(o[i]=h,Z(o),Te(),!n){console.log("Updating only the modified post in the UI");const f=Wt(h);Fe(se(o)),!f&&!s&&(console.log("Single post update failed, falling back to re-rendering all posts"),G(o)),setTimeout(()=>{document.dispatchEvent(new CustomEvent("setupTagFilters"))},100)}return!0}else return console.log("No changes detected, skipping update"),!1}return!1}function G(r,e=!1){console.log("Rendering posts to UI");const t=document.getElementById("postsGrid"),n=document.getElementById("postTemplate");t.innerHTML="";const s=[...r].sort((i,a)=>new Date(a.dateAdded)-new Date(i.dateAdded)),o=s.map(i=>{const a=document.importNode(n.content,!0).firstElementChild;a.dataset.id=i.id,a.dataset.platform=i.platform,a.dataset.url=i.url,a.setAttribute("data-id",i.id),a.classList.add("opacity-0");const l=a.querySelector(".post-actions");if(l){const h=document.createElement("button");h.className="delete-post-btn text-red-500 hover:text-red-700 ml-2",h.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>',h.title="Delete post",h.setAttribute("data-post-id",i.id),h.setAttribute("data-action","delete-post"),l.appendChild(h)}const d=a.querySelector(".post-embed"),c=i.platform==="twitter"?"500px":i.platform==="instagram"?"600px":"300px";d.innerHTML=`
      <div class="embed-placeholder bg-gray-100 animate-pulse flex items-center justify-center" 
           style="height: ${c}">
        <p class="text-gray-500">Loading ${i.platform} post...</p>
      </div>
    `;const u=a.querySelector(".post-tags");return Mr(i.tags,u,h=>{Wr(i.id,h)}),{element:a,post:i}});o&&o.length>0&&(o.forEach(({element:i})=>{t.appendChild(i)}),o.forEach(({element:i,post:a},l)=>{setTimeout(()=>{const d=i.querySelector(".post-embed");Jr(a.url,a.platform,d);const c=()=>{const u=d.querySelector(".embed-placeholder");u&&u.remove(),i.classList.remove("opacity-0"),i.classList.add("opacity-100")};setTimeout(()=>{const u=d.querySelectorAll("iframe"),h=d.querySelectorAll("img");u.length===0&&h.length===0?c():(u&&u.length>0&&u.forEach(f=>{var w;f.complete||((w=f.contentDocument)==null?void 0:w.readyState)==="complete"?c():f.addEventListener("load",c,{once:!0})}),h&&h.length>0&&h.forEach(f=>{f.complete?c():f.addEventListener("load",c,{once:!0})}),setTimeout(c,3e3))},100)},l*100)})),s.length===0?Ee():document.getElementById("noPostsMessage").classList.add("hidden"),document.dispatchEvent(new CustomEvent("postsRendered",{detail:{count:s.length}})),console.log("Posts rendered event dispatched:",s.length,"posts")}function Jr(r,e,t){switch(e.toLowerCase()){case"twitter":case"x":is(r,t);break;case"youtube":as(r,t);break;case"instagram":ls(r,t);break;case"pinterest":cs(r,t);break;case"linkedin":ds(r,t);break;case"tiktok":us(r,t);break;default:hs(r,t)}}function pr(){const r=[],e=document.getElementById("tagFilterContainer");if(!e)return r;const t=e.querySelectorAll("[data-tag-name], [data-tag]");return!t||t.length===0||t.forEach(n=>{if(n.dataset.tagJson)try{const s=JSON.parse(n.dataset.tagJson);r.push(s)}catch{r.push(n.dataset.tagName||n.dataset.tag)}else n.dataset.tagName?r.push(n.dataset.tagName):n.dataset.tag&&r.push(n.dataset.tag)}),r}function vt(r=[]){let e=[];try{const n=oe();console.log(`Loading posts for filtering from storage key: ${n}`);const s=localStorage.getItem(n);e=s?JSON.parse(s):[]}catch(n){console.error("Error loading posts for filtering:",n),e=[]}const t=document.getElementById("clearTagFilters");if(r.length>0?t.classList.remove("hidden"):t.classList.add("hidden"),r.length===0)G(e);else{const n=e.filter(s=>!s.tags||!Array.isArray(s.tags)||s.tags.length===0?!1:r.every(o=>{const i=typeof o=="object"&&o!==null&&o.name?o.name.toLowerCase():String(o).toLowerCase();return s.tags.some(a=>(typeof a=="object"&&a!==null&&a.name?a.name.toLowerCase():String(a).toLowerCase())===i)}));G(n)}}function Wr(r,e){const t=U(!0),n=t.findIndex(s=>s.id===r);n!==-1&&(t[n].tags=t[n].tags.filter(s=>s!==e),Z(t),Te(),G(t),Fe(se(t)))}function Ee(){const r=document.getElementById("postsContainer");if(!r)return;r.innerHTML="";const e=document.createElement("div");e.id="no-posts-message",e.className="no-posts-message",e.innerHTML=`
    <div class="text-center p-8">
      <h3 class="text-xl font-semibold mb-2">No posts yet</h3>
      <p class="text-gray-600 mb-4">Add your first link by clicking the + button below</p>
      <button id="addFirstPostBtn" class="btn btn-primary">
        <i class="fas fa-plus mr-2"></i> Add Your First Link
      </button>
    </div>
  `,r.appendChild(e);const t=document.getElementById("addFirstPostBtn");t&&t.addEventListener("click",()=>{document.getElementById("addPostBtn").click()})}window.boardie.loadPosts=function(){return U(!0)};const ks=/(https?:\/\/[^\s]+)/g;let wr=0;const Ss=2e3;function Ts(r){if(!r)return null;const e=r.match(ks);return e&&e.length>0?e[0]:null}function Cs(r){if(r)try{localStorage.setItem("boardie_clipboard_url",r),localStorage.setItem("boardie_clipboard_timestamp",Date.now().toString()),console.log("Saved URL to clipboard storage:",r)}catch(e){console.error("Error saving clipboard URL to localStorage:",e)}}function Ps(){try{localStorage.removeItem("boardie_clipboard_url"),localStorage.removeItem("boardie_clipboard_timestamp")}catch(r){console.error("Error clearing saved clipboard URL:",r)}}async function Vr(){try{if(!navigator.clipboard||!navigator.clipboard.readText)return console.warn("Clipboard API not available"),null;const r=await navigator.clipboard.readText(),e=Ts(r);return e?(console.log("Found URL in clipboard:",e),Cs(e),e):null}catch(r){return console.error("Error reading from clipboard:",r),null}}async function Gr(r){if(!r||typeof r!="function")return console.error("Invalid openAddLinkModal function"),!1;const e=Date.now();if(e-wr<Ss)return console.log("Skipping clipboard check - too soon since last check"),!1;wr=e;const t=await Vr();return t?(r(t),Ps(),!0):!1}function xs(){try{const r=U(!0);if(!r||r.length===0){alert("No posts to export");return}const e={version:"0.1.0",timestamp:new Date().toISOString(),count:r.length,posts:r},t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(n),o=document.createElement("a");return o.href=s,o.download=`boardie-export-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s),!0}catch(r){return console.error("Error exporting posts:",r),alert("Failed to export posts: "+r.message),!1}}function Ls(r){return new Promise((e,t)=>{const n=new FileReader;n.onload=s=>{try{const o=JSON.parse(s.target.result);if(!o.posts||!Array.isArray(o.posts)){t(new Error("Invalid import file format"));return}const i=U(!0),a=new Set(i.map(c=>c.id)),l=o.posts.filter(c=>!a.has(c.id)),d=[...i,...l];Z(d),e({success:!0,totalImported:o.posts.length,newPostsAdded:l.length,duplicatesSkipped:o.posts.length-l.length})}catch(o){console.error("Error importing posts:",o),t(o)}},n.onerror=s=>{t(s)},n.readAsText(r)})}const Is=r=>{let e;return r?e=r:typeof fetch>"u"?e=(...t)=>Q(()=>Promise.resolve().then(()=>Ce),void 0).then(({default:n})=>n(...t)):e=fetch,(...t)=>e(...t)};class Gt extends Error{constructor(e,t="FunctionsError",n){super(e),this.name=t,this.context=n}}class As extends Gt{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class $s extends Gt{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class Os extends Gt{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var At;(function(r){r.Any="any",r.ApNortheast1="ap-northeast-1",r.ApNortheast2="ap-northeast-2",r.ApSouth1="ap-south-1",r.ApSoutheast1="ap-southeast-1",r.ApSoutheast2="ap-southeast-2",r.CaCentral1="ca-central-1",r.EuCentral1="eu-central-1",r.EuWest1="eu-west-1",r.EuWest2="eu-west-2",r.EuWest3="eu-west-3",r.SaEast1="sa-east-1",r.UsEast1="us-east-1",r.UsWest1="us-west-1",r.UsWest2="us-west-2"})(At||(At={}));var js=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(o){return o instanceof t?o:new t(function(i){i(o)})}return new(t||(t=Promise))(function(o,i){function a(c){try{d(n.next(c))}catch(u){i(u)}}function l(c){try{d(n.throw(c))}catch(u){i(u)}}function d(c){c.done?o(c.value):s(c.value).then(a,l)}d((n=n.apply(r,e||[])).next())})};class Rs{constructor(e,{headers:t={},customFetch:n,region:s=At.Any}={}){this.url=e,this.headers=t,this.region=s,this.fetch=Is(n)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var n;return js(this,void 0,void 0,function*(){try{const{headers:s,method:o,body:i}=t;let a={},{region:l}=t;l||(l=this.region),l&&l!=="any"&&(a["x-region"]=l);let d;i&&(s&&!Object.prototype.hasOwnProperty.call(s,"Content-Type")||!s)&&(typeof Blob<"u"&&i instanceof Blob||i instanceof ArrayBuffer?(a["Content-Type"]="application/octet-stream",d=i):typeof i=="string"?(a["Content-Type"]="text/plain",d=i):typeof FormData<"u"&&i instanceof FormData?d=i:(a["Content-Type"]="application/json",d=JSON.stringify(i)));const c=yield this.fetch(`${this.url}/${e}`,{method:o||"POST",headers:Object.assign(Object.assign(Object.assign({},a),this.headers),s),body:d}).catch(w=>{throw new As(w)}),u=c.headers.get("x-relay-error");if(u&&u==="true")throw new $s(c);if(!c.ok)throw new Os(c);let h=((n=c.headers.get("Content-Type"))!==null&&n!==void 0?n:"text/plain").split(";")[0].trim(),f;return h==="application/json"?f=yield c.json():h==="application/octet-stream"?f=yield c.blob():h==="text/event-stream"?f=c:h==="multipart/form-data"?f=yield c.formData():f=yield c.text(),{data:f,error:null}}catch(s){return{data:null,error:s}}})}}var H=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ua(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function Us(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(n){var s=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:function(){return r[n]}})}),t}var q={},Kt={},ot={},Me={},it={},at={},Ns=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},Se=Ns();const Ds=Se.fetch,Kr=Se.fetch.bind(Se),Yr=Se.Headers,Bs=Se.Request,Fs=Se.Response,Ce=Object.freeze(Object.defineProperty({__proto__:null,Headers:Yr,Request:Bs,Response:Fs,default:Kr,fetch:Ds},Symbol.toStringTag,{value:"Module"})),Ms=Us(Ce);var lt={};Object.defineProperty(lt,"__esModule",{value:!0});let qs=class extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}};lt.default=qs;var Qr=H&&H.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(at,"__esModule",{value:!0});const zs=Qr(Ms),Hs=Qr(lt);let Js=class{constructor(e){this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=e.headers,this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=e.shouldThrowOnError,this.signal=e.signal,this.isMaybeSingle=e.isMaybeSingle,e.fetch?this.fetch=e.fetch:typeof fetch>"u"?this.fetch=zs.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(e,t){return this.headers=Object.assign({},this.headers),this.headers[e]=t,this}then(e,t){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers["Accept-Profile"]=this.schema:this.headers["Content-Profile"]=this.schema),this.method!=="GET"&&this.method!=="HEAD"&&(this.headers["Content-Type"]="application/json");const n=this.fetch;let s=n(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async o=>{var i,a,l;let d=null,c=null,u=null,h=o.status,f=o.statusText;if(o.ok){if(this.method!=="HEAD"){const I=await o.text();I===""||(this.headers.Accept==="text/csv"||this.headers.Accept&&this.headers.Accept.includes("application/vnd.pgrst.plan+text")?c=I:c=JSON.parse(I))}const T=(i=this.headers.Prefer)===null||i===void 0?void 0:i.match(/count=(exact|planned|estimated)/),S=(a=o.headers.get("content-range"))===null||a===void 0?void 0:a.split("/");T&&S&&S.length>1&&(u=parseInt(S[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(c)&&(c.length>1?(d={code:"PGRST116",details:`Results contain ${c.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},c=null,u=null,h=406,f="Not Acceptable"):c.length===1?c=c[0]:c=null)}else{const T=await o.text();try{d=JSON.parse(T),Array.isArray(d)&&o.status===404&&(c=[],d=null,h=200,f="OK")}catch{o.status===404&&T===""?(h=204,f="No Content"):d={message:T}}if(d&&this.isMaybeSingle&&(!((l=d==null?void 0:d.details)===null||l===void 0)&&l.includes("0 rows"))&&(d=null,h=200,f="OK"),d&&this.shouldThrowOnError)throw new Hs.default(d)}return{error:d,data:c,count:u,status:h,statusText:f}});return this.shouldThrowOnError||(s=s.catch(o=>{var i,a,l;return{error:{message:`${(i=o==null?void 0:o.name)!==null&&i!==void 0?i:"FetchError"}: ${o==null?void 0:o.message}`,details:`${(a=o==null?void 0:o.stack)!==null&&a!==void 0?a:""}`,hint:"",code:`${(l=o==null?void 0:o.code)!==null&&l!==void 0?l:""}`},data:null,count:null,status:0,statusText:""}})),s.then(e,t)}returns(){return this}overrideTypes(){return this}};at.default=Js;var Ws=H&&H.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(it,"__esModule",{value:!0});const Vs=Ws(at);let Gs=class extends Vs.default{select(e){let t=!1;const n=(e??"*").split("").map(s=>/\s/.test(s)&&!t?"":(s==='"'&&(t=!t),s)).join("");return this.url.searchParams.set("select",n),this.headers.Prefer&&(this.headers.Prefer+=","),this.headers.Prefer+="return=representation",this}order(e,{ascending:t=!0,nullsFirst:n,foreignTable:s,referencedTable:o=s}={}){const i=o?`${o}.order`:"order",a=this.url.searchParams.get(i);return this.url.searchParams.set(i,`${a?`${a},`:""}${e}.${t?"asc":"desc"}${n===void 0?"":n?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:n=t}={}){const s=typeof n>"u"?"limit":`${n}.limit`;return this.url.searchParams.set(s,`${e}`),this}range(e,t,{foreignTable:n,referencedTable:s=n}={}){const o=typeof s>"u"?"offset":`${s}.offset`,i=typeof s>"u"?"limit":`${s}.limit`;return this.url.searchParams.set(o,`${e}`),this.url.searchParams.set(i,`${t-e+1}`),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.Accept="application/vnd.pgrst.object+json",this}maybeSingle(){return this.method==="GET"?this.headers.Accept="application/json":this.headers.Accept="application/vnd.pgrst.object+json",this.isMaybeSingle=!0,this}csv(){return this.headers.Accept="text/csv",this}geojson(){return this.headers.Accept="application/geo+json",this}explain({analyze:e=!1,verbose:t=!1,settings:n=!1,buffers:s=!1,wal:o=!1,format:i="text"}={}){var a;const l=[e?"analyze":null,t?"verbose":null,n?"settings":null,s?"buffers":null,o?"wal":null].filter(Boolean).join("|"),d=(a=this.headers.Accept)!==null&&a!==void 0?a:"application/json";return this.headers.Accept=`application/vnd.pgrst.plan+${i}; for="${d}"; options=${l};`,i==="json"?this:this}rollback(){var e;return((e=this.headers.Prefer)!==null&&e!==void 0?e:"").trim().length>0?this.headers.Prefer+=",tx=rollback":this.headers.Prefer="tx=rollback",this}returns(){return this}};it.default=Gs;var Ks=H&&H.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(Me,"__esModule",{value:!0});const Ys=Ks(it);let Qs=class extends Ys.default{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}in(e,t){const n=Array.from(new Set(t)).map(s=>typeof s=="string"&&new RegExp("[,()]").test(s)?`"${s}"`:`${s}`).join(",");return this.url.searchParams.append(e,`in.(${n})`),this}contains(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return typeof t=="string"?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:n,type:s}={}){let o="";s==="plain"?o="pl":s==="phrase"?o="ph":s==="websearch"&&(o="w");const i=n===void 0?"":`(${n})`;return this.url.searchParams.append(e,`${o}fts${i}.${t}`),this}match(e){return Object.entries(e).forEach(([t,n])=>{this.url.searchParams.append(t,`eq.${n}`)}),this}not(e,t,n){return this.url.searchParams.append(e,`not.${t}.${n}`),this}or(e,{foreignTable:t,referencedTable:n=t}={}){const s=n?`${n}.or`:"or";return this.url.searchParams.append(s,`(${e})`),this}filter(e,t,n){return this.url.searchParams.append(e,`${t}.${n}`),this}};Me.default=Qs;var Xs=H&&H.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(ot,"__esModule",{value:!0});const Ie=Xs(Me);let Zs=class{constructor(e,{headers:t={},schema:n,fetch:s}){this.url=e,this.headers=t,this.schema=n,this.fetch=s}select(e,{head:t=!1,count:n}={}){const s=t?"HEAD":"GET";let o=!1;const i=(e??"*").split("").map(a=>/\s/.test(a)&&!o?"":(a==='"'&&(o=!o),a)).join("");return this.url.searchParams.set("select",i),n&&(this.headers.Prefer=`count=${n}`),new Ie.default({method:s,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}insert(e,{count:t,defaultToNull:n=!0}={}){const s="POST",o=[];if(this.headers.Prefer&&o.push(this.headers.Prefer),t&&o.push(`count=${t}`),n||o.push("missing=default"),this.headers.Prefer=o.join(","),Array.isArray(e)){const i=e.reduce((a,l)=>a.concat(Object.keys(l)),[]);if(i.length>0){const a=[...new Set(i)].map(l=>`"${l}"`);this.url.searchParams.set("columns",a.join(","))}}return new Ie.default({method:s,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}upsert(e,{onConflict:t,ignoreDuplicates:n=!1,count:s,defaultToNull:o=!0}={}){const i="POST",a=[`resolution=${n?"ignore":"merge"}-duplicates`];if(t!==void 0&&this.url.searchParams.set("on_conflict",t),this.headers.Prefer&&a.push(this.headers.Prefer),s&&a.push(`count=${s}`),o||a.push("missing=default"),this.headers.Prefer=a.join(","),Array.isArray(e)){const l=e.reduce((d,c)=>d.concat(Object.keys(c)),[]);if(l.length>0){const d=[...new Set(l)].map(c=>`"${c}"`);this.url.searchParams.set("columns",d.join(","))}}return new Ie.default({method:i,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}update(e,{count:t}={}){const n="PATCH",s=[];return this.headers.Prefer&&s.push(this.headers.Prefer),t&&s.push(`count=${t}`),this.headers.Prefer=s.join(","),new Ie.default({method:n,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}delete({count:e}={}){const t="DELETE",n=[];return e&&n.push(`count=${e}`),this.headers.Prefer&&n.unshift(this.headers.Prefer),this.headers.Prefer=n.join(","),new Ie.default({method:t,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}};ot.default=Zs;var ct={},dt={};Object.defineProperty(dt,"__esModule",{value:!0});dt.version=void 0;dt.version="0.0.0-automated";Object.defineProperty(ct,"__esModule",{value:!0});ct.DEFAULT_HEADERS=void 0;const eo=dt;ct.DEFAULT_HEADERS={"X-Client-Info":`postgrest-js/${eo.version}`};var Xr=H&&H.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(Kt,"__esModule",{value:!0});const to=Xr(ot),ro=Xr(Me),no=ct;let so=class Zr{constructor(e,{headers:t={},schema:n,fetch:s}={}){this.url=e,this.headers=Object.assign(Object.assign({},no.DEFAULT_HEADERS),t),this.schemaName=n,this.fetch=s}from(e){const t=new URL(`${this.url}/${e}`);return new to.default(t,{headers:Object.assign({},this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new Zr(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:n=!1,get:s=!1,count:o}={}){let i;const a=new URL(`${this.url}/rpc/${e}`);let l;n||s?(i=n?"HEAD":"GET",Object.entries(t).filter(([c,u])=>u!==void 0).map(([c,u])=>[c,Array.isArray(u)?`{${u.join(",")}}`:`${u}`]).forEach(([c,u])=>{a.searchParams.append(c,u)})):(i="POST",l=t);const d=Object.assign({},this.headers);return o&&(d.Prefer=`count=${o}`),new ro.default({method:i,url:a,headers:d,schema:this.schemaName,body:l,fetch:this.fetch,allowEmpty:!1})}};Kt.default=so;var Pe=H&&H.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(q,"__esModule",{value:!0});q.PostgrestError=q.PostgrestBuilder=q.PostgrestTransformBuilder=q.PostgrestFilterBuilder=q.PostgrestQueryBuilder=q.PostgrestClient=void 0;const en=Pe(Kt);q.PostgrestClient=en.default;const tn=Pe(ot);q.PostgrestQueryBuilder=tn.default;const rn=Pe(Me);q.PostgrestFilterBuilder=rn.default;const nn=Pe(it);q.PostgrestTransformBuilder=nn.default;const sn=Pe(at);q.PostgrestBuilder=sn.default;const on=Pe(lt);q.PostgrestError=on.default;var oo=q.default={PostgrestClient:en.default,PostgrestQueryBuilder:tn.default,PostgrestFilterBuilder:rn.default,PostgrestTransformBuilder:nn.default,PostgrestBuilder:sn.default,PostgrestError:on.default};const{PostgrestClient:io,PostgrestQueryBuilder:qa,PostgrestFilterBuilder:za,PostgrestTransformBuilder:Ha,PostgrestBuilder:Ja,PostgrestError:Wa}=oo,ao="2.11.2",lo={"X-Client-Info":`realtime-js/${ao}`},co="1.0.0",an=1e4,uo=1e3;var ke;(function(r){r[r.connecting=0]="connecting",r[r.open=1]="open",r[r.closing=2]="closing",r[r.closed=3]="closed"})(ke||(ke={}));var z;(function(r){r.closed="closed",r.errored="errored",r.joined="joined",r.joining="joining",r.leaving="leaving"})(z||(z={}));var W;(function(r){r.close="phx_close",r.error="phx_error",r.join="phx_join",r.reply="phx_reply",r.leave="phx_leave",r.access_token="access_token"})(W||(W={}));var $t;(function(r){r.websocket="websocket"})($t||($t={}));var ge;(function(r){r.Connecting="connecting",r.Open="open",r.Closing="closing",r.Closed="closed"})(ge||(ge={}));class ho{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t(typeof e=="string"?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),n=new TextDecoder;return this._decodeBroadcast(e,t,n)}_decodeBroadcast(e,t,n){const s=t.getUint8(1),o=t.getUint8(2);let i=this.HEADER_LENGTH+2;const a=n.decode(e.slice(i,i+s));i=i+s;const l=n.decode(e.slice(i,i+o));i=i+o;const d=JSON.parse(n.decode(e.slice(i,e.byteLength)));return{ref:null,topic:a,event:l,payload:d}}}class ln{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var P;(function(r){r.abstime="abstime",r.bool="bool",r.date="date",r.daterange="daterange",r.float4="float4",r.float8="float8",r.int2="int2",r.int4="int4",r.int4range="int4range",r.int8="int8",r.int8range="int8range",r.json="json",r.jsonb="jsonb",r.money="money",r.numeric="numeric",r.oid="oid",r.reltime="reltime",r.text="text",r.time="time",r.timestamp="timestamp",r.timestamptz="timestamptz",r.timetz="timetz",r.tsrange="tsrange",r.tstzrange="tstzrange"})(P||(P={}));const yr=(r,e,t={})=>{var n;const s=(n=t.skipTypes)!==null&&n!==void 0?n:[];return Object.keys(e).reduce((o,i)=>(o[i]=go(i,r,e,s),o),{})},go=(r,e,t,n)=>{const s=e.find(a=>a.name===r),o=s==null?void 0:s.type,i=t[r];return o&&!n.includes(o)?cn(o,i):Ot(i)},cn=(r,e)=>{if(r.charAt(0)==="_"){const t=r.slice(1,r.length);return wo(e,t)}switch(r){case P.bool:return fo(e);case P.float4:case P.float8:case P.int2:case P.int4:case P.int8:case P.numeric:case P.oid:return mo(e);case P.json:case P.jsonb:return po(e);case P.timestamp:return yo(e);case P.abstime:case P.date:case P.daterange:case P.int4range:case P.int8range:case P.money:case P.reltime:case P.text:case P.time:case P.timestamptz:case P.timetz:case P.tsrange:case P.tstzrange:return Ot(e);default:return Ot(e)}},Ot=r=>r,fo=r=>{switch(r){case"t":return!0;case"f":return!1;default:return r}},mo=r=>{if(typeof r=="string"){const e=parseFloat(r);if(!Number.isNaN(e))return e}return r},po=r=>{if(typeof r=="string")try{return JSON.parse(r)}catch(e){return console.log(`JSON parse error: ${e}`),r}return r},wo=(r,e)=>{if(typeof r!="string")return r;const t=r.length-1,n=r[t];if(r[0]==="{"&&n==="}"){let o;const i=r.slice(1,t);try{o=JSON.parse("["+i+"]")}catch{o=i?i.split(","):[]}return o.map(a=>cn(e,a))}return r},yo=r=>typeof r=="string"?r.replace(" ","T"):r,dn=r=>{let e=r;return e=e.replace(/^ws/i,"http"),e=e.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),e.replace(/\/+$/,"")};class _t{constructor(e,t,n={},s=an){this.channel=e,this.event=t,this.payload=n,this.timeout=s,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var n;return this._hasReceived(e)&&t((n=this.receivedResp)===null||n===void 0?void 0:n.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(n=>n.status===e).forEach(n=>n.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var br;(function(r){r.SYNC="sync",r.JOIN="join",r.LEAVE="leave"})(br||(br={}));class Re{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const n=(t==null?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(n.state,{},s=>{const{onJoin:o,onLeave:i,onSync:a}=this.caller;this.joinRef=this.channel._joinRef(),this.state=Re.syncState(this.state,s,o,i),this.pendingDiffs.forEach(l=>{this.state=Re.syncDiff(this.state,l,o,i)}),this.pendingDiffs=[],a()}),this.channel._on(n.diff,{},s=>{const{onJoin:o,onLeave:i,onSync:a}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(s):(this.state=Re.syncDiff(this.state,s,o,i),a())}),this.onJoin((s,o,i)=>{this.channel._trigger("presence",{event:"join",key:s,currentPresences:o,newPresences:i})}),this.onLeave((s,o,i)=>{this.channel._trigger("presence",{event:"leave",key:s,currentPresences:o,leftPresences:i})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,n,s){const o=this.cloneDeep(e),i=this.transformState(t),a={},l={};return this.map(o,(d,c)=>{i[d]||(l[d]=c)}),this.map(i,(d,c)=>{const u=o[d];if(u){const h=c.map(S=>S.presence_ref),f=u.map(S=>S.presence_ref),w=c.filter(S=>f.indexOf(S.presence_ref)<0),T=u.filter(S=>h.indexOf(S.presence_ref)<0);w.length>0&&(a[d]=w),T.length>0&&(l[d]=T)}else a[d]=c}),this.syncDiff(o,{joins:a,leaves:l},n,s)}static syncDiff(e,t,n,s){const{joins:o,leaves:i}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return n||(n=()=>{}),s||(s=()=>{}),this.map(o,(a,l)=>{var d;const c=(d=e[a])!==null&&d!==void 0?d:[];if(e[a]=this.cloneDeep(l),c.length>0){const u=e[a].map(f=>f.presence_ref),h=c.filter(f=>u.indexOf(f.presence_ref)<0);e[a].unshift(...h)}n(a,c,l)}),this.map(i,(a,l)=>{let d=e[a];if(!d)return;const c=l.map(u=>u.presence_ref);d=d.filter(u=>c.indexOf(u.presence_ref)<0),e[a]=d,s(a,d,l),d.length===0&&delete e[a]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(n=>t(n,e[n]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,n)=>{const s=e[n];return"metas"in s?t[n]=s.metas.map(o=>(o.presence_ref=o.phx_ref,delete o.phx_ref,delete o.phx_ref_prev,o)):t[n]=s,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var vr;(function(r){r.ALL="*",r.INSERT="INSERT",r.UPDATE="UPDATE",r.DELETE="DELETE"})(vr||(vr={}));var _r;(function(r){r.BROADCAST="broadcast",r.PRESENCE="presence",r.POSTGRES_CHANGES="postgres_changes",r.SYSTEM="system"})(_r||(_r={}));var Y;(function(r){r.SUBSCRIBED="SUBSCRIBED",r.TIMED_OUT="TIMED_OUT",r.CLOSED="CLOSED",r.CHANNEL_ERROR="CHANNEL_ERROR"})(Y||(Y={}));class Yt{constructor(e,t={config:{}},n){this.topic=e,this.params=t,this.socket=n,this.bindings={},this.state=z.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:""},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new _t(this,W.join,this.params,this.timeout),this.rejoinTimer=new ln(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=z.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(s=>s.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=z.closed,this.socket._remove(this)}),this._onError(s=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,s),this.state=z.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=z.errored,this.rejoinTimer.scheduleTimeout())}),this._on(W.reply,{},(s,o)=>{this._trigger(this._replyEventName(o),s)}),this.presence=new Re(this),this.broadcastEndpointURL=dn(this.socket.endPoint)+"/api/broadcast",this.private=this.params.config.private||!1}subscribe(e,t=this.timeout){var n,s;if(this.socket.isConnected()||this.socket.connect(),this.joinedOnce)throw"tried to subscribe multiple times. 'subscribe' can only be called a single time per channel instance";{const{config:{broadcast:o,presence:i,private:a}}=this.params;this._onError(c=>e==null?void 0:e(Y.CHANNEL_ERROR,c)),this._onClose(()=>e==null?void 0:e(Y.CLOSED));const l={},d={broadcast:o,presence:i,postgres_changes:(s=(n=this.bindings.postgres_changes)===null||n===void 0?void 0:n.map(c=>c.filter))!==null&&s!==void 0?s:[],private:a};this.socket.accessTokenValue&&(l.access_token=this.socket.accessTokenValue),this.updateJoinPayload(Object.assign({config:d},l)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:c})=>{var u;if(this.socket.setAuth(),c===void 0){e==null||e(Y.SUBSCRIBED);return}else{const h=this.bindings.postgres_changes,f=(u=h==null?void 0:h.length)!==null&&u!==void 0?u:0,w=[];for(let T=0;T<f;T++){const S=h[T],{filter:{event:I,schema:N,table:O,filter:x}}=S,j=c&&c[T];if(j&&j.event===I&&j.schema===N&&j.table===O&&j.filter===x)w.push(Object.assign(Object.assign({},S),{id:j.id}));else{this.unsubscribe(),e==null||e(Y.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=w,e&&e(Y.SUBSCRIBED);return}}).receive("error",c=>{e==null||e(Y.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(c).join(", ")||"error")))}).receive("timeout",()=>{e==null||e(Y.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,n){return this._on(e,t,n)}async send(e,t={}){var n,s;if(!this._canPush()&&e.type==="broadcast"){const{event:o,payload:i}=e,l={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:o,payload:i,private:this.private}]})};try{const d=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(n=t.timeout)!==null&&n!==void 0?n:this.timeout);return await((s=d.body)===null||s===void 0?void 0:s.cancel()),d.ok?"ok":"error"}catch(d){return d.name==="AbortError"?"timed out":"error"}}else return new Promise(o=>{var i,a,l;const d=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((l=(a=(i=this.params)===null||i===void 0?void 0:i.config)===null||a===void 0?void 0:a.broadcast)===null||l===void 0)&&l.ack)&&o("ok"),d.receive("ok",()=>o("ok")),d.receive("error",()=>o("error")),d.receive("timeout",()=>o("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=z.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(W.close,"leave",this._joinRef())};return this.rejoinTimer.reset(),this.joinPush.destroy(),new Promise(n=>{const s=new _t(this,W.leave,{},e);s.receive("ok",()=>{t(),n("ok")}).receive("timeout",()=>{t(),n("timed out")}).receive("error",()=>{n("error")}),s.send(),this._canPush()||s.trigger("ok",{})})}async _fetchWithTimeout(e,t,n){const s=new AbortController,o=setTimeout(()=>s.abort(),n),i=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:s.signal}));return clearTimeout(o),i}_push(e,t,n=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let s=new _t(this,e,t,n);return this._canPush()?s.send():(s.startTimeout(),this.pushBuffer.push(s)),s}_onMessage(e,t,n){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,n){var s,o;const i=e.toLocaleLowerCase(),{close:a,error:l,leave:d,join:c}=W;if(n&&[a,l,d,c].indexOf(i)>=0&&n!==this._joinRef())return;let h=this._onMessage(i,t,n);if(t&&!h)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(i)?(s=this.bindings.postgres_changes)===null||s===void 0||s.filter(f=>{var w,T,S;return((w=f.filter)===null||w===void 0?void 0:w.event)==="*"||((S=(T=f.filter)===null||T===void 0?void 0:T.event)===null||S===void 0?void 0:S.toLocaleLowerCase())===i}).map(f=>f.callback(h,n)):(o=this.bindings[i])===null||o===void 0||o.filter(f=>{var w,T,S,I,N,O;if(["broadcast","presence","postgres_changes"].includes(i))if("id"in f){const x=f.id,j=(w=f.filter)===null||w===void 0?void 0:w.event;return x&&((T=t.ids)===null||T===void 0?void 0:T.includes(x))&&(j==="*"||(j==null?void 0:j.toLocaleLowerCase())===((S=t.data)===null||S===void 0?void 0:S.type.toLocaleLowerCase()))}else{const x=(N=(I=f==null?void 0:f.filter)===null||I===void 0?void 0:I.event)===null||N===void 0?void 0:N.toLocaleLowerCase();return x==="*"||x===((O=t==null?void 0:t.event)===null||O===void 0?void 0:O.toLocaleLowerCase())}else return f.type.toLocaleLowerCase()===i}).map(f=>{if(typeof h=="object"&&"ids"in h){const w=h.data,{schema:T,table:S,commit_timestamp:I,type:N,errors:O}=w;h=Object.assign(Object.assign({},{schema:T,table:S,commit_timestamp:I,eventType:N,new:{},old:{},errors:O}),this._getPayloadRecords(w))}f.callback(h,n)})}_isClosed(){return this.state===z.closed}_isJoined(){return this.state===z.joined}_isJoining(){return this.state===z.joining}_isLeaving(){return this.state===z.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,n){const s=e.toLocaleLowerCase(),o={type:s,filter:t,callback:n};return this.bindings[s]?this.bindings[s].push(o):this.bindings[s]=[o],this}_off(e,t){const n=e.toLocaleLowerCase();return this.bindings[n]=this.bindings[n].filter(s=>{var o;return!(((o=s.type)===null||o===void 0?void 0:o.toLocaleLowerCase())===n&&Yt.isEqual(s.filter,t))}),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(e[n]!==t[n])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(W.close,{},e)}_onError(e){this._on(W.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=z.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=yr(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=yr(e.columns,e.old_record)),t}}const bo=()=>{},vo=typeof WebSocket<"u",_o=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class Eo{constructor(e,t){var n;this.accessTokenValue=null,this.apiKey=null,this.channels=[],this.endPoint="",this.httpEndpoint="",this.headers=lo,this.params={},this.timeout=an,this.heartbeatIntervalMs=3e4,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.ref=0,this.logger=bo,this.conn=null,this.sendBuffer=[],this.serializer=new ho,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._resolveFetch=o=>{let i;return o?i=o:typeof fetch>"u"?i=(...a)=>Q(()=>Promise.resolve().then(()=>Ce),void 0).then(({default:l})=>l(...a)):i=fetch,(...a)=>i(...a)},this.endPoint=`${e}/${$t.websocket}`,this.httpEndpoint=dn(e),t!=null&&t.transport?this.transport=t.transport:this.transport=null,t!=null&&t.params&&(this.params=t.params),t!=null&&t.headers&&(this.headers=Object.assign(Object.assign({},this.headers),t.headers)),t!=null&&t.timeout&&(this.timeout=t.timeout),t!=null&&t.logger&&(this.logger=t.logger),t!=null&&t.heartbeatIntervalMs&&(this.heartbeatIntervalMs=t.heartbeatIntervalMs);const s=(n=t==null?void 0:t.params)===null||n===void 0?void 0:n.apikey;if(s&&(this.accessTokenValue=s,this.apiKey=s),this.reconnectAfterMs=t!=null&&t.reconnectAfterMs?t.reconnectAfterMs:o=>[1e3,2e3,5e3,1e4][o-1]||1e4,this.encode=t!=null&&t.encode?t.encode:(o,i)=>i(JSON.stringify(o)),this.decode=t!=null&&t.decode?t.decode:this.serializer.decode.bind(this.serializer),this.reconnectTimer=new ln(async()=>{this.disconnect(),this.connect()},this.reconnectAfterMs),this.fetch=this._resolveFetch(t==null?void 0:t.fetch),t!=null&&t.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.worker=(t==null?void 0:t.worker)||!1,this.workerUrl=t==null?void 0:t.workerUrl}this.accessToken=(t==null?void 0:t.accessToken)||null}connect(){if(!this.conn){if(this.transport){this.conn=new this.transport(this.endpointURL(),void 0,{headers:this.headers});return}if(vo){this.conn=new WebSocket(this.endpointURL()),this.setupConnection();return}this.conn=new ko(this.endpointURL(),void 0,{close:()=>{this.conn=null}}),Q(()=>import("./browser-92c8d37d.js").then(e=>e.b),[]).then(({default:e})=>{this.conn=new e(this.endpointURL(),void 0,{headers:this.headers}),this.setupConnection()})}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:co}))}disconnect(e,t){this.conn&&(this.conn.onclose=function(){},e?this.conn.close(e,t??""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset())}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.disconnect(),e}log(e,t,n){this.logger(e,t,n)}connectionState(){switch(this.conn&&this.conn.readyState){case ke.connecting:return ge.Connecting;case ke.open:return ge.Open;case ke.closing:return ge.Closing;default:return ge.Closed}}isConnected(){return this.connectionState()===ge.Open}channel(e,t={config:{}}){const n=new Yt(`realtime:${e}`,t,this);return this.channels.push(n),n}push(e){const{topic:t,event:n,payload:s,ref:o}=e,i=()=>{this.encode(e,a=>{var l;(l=this.conn)===null||l===void 0||l.send(a)})};this.log("push",`${t} ${n} (${o})`,s),this.isConnected()?i():this.sendBuffer.push(i)}async setAuth(e=null){let t=e||this.accessToken&&await this.accessToken()||this.accessTokenValue;if(t){let n=null;try{n=JSON.parse(atob(t.split(".")[1]))}catch{}if(n&&n.exp&&!(Math.floor(Date.now()/1e3)-n.exp<0))return this.log("auth",`InvalidJWTToken: Invalid value for JWT claim "exp" with value ${n.exp}`),Promise.reject(`InvalidJWTToken: Invalid value for JWT claim "exp" with value ${n.exp}`);this.accessTokenValue=t,this.channels.forEach(s=>{t&&s.updateJoinPayload({access_token:t}),s.joinedOnce&&s._isJoined()&&s._push(W.access_token,{access_token:t})})}}async sendHeartbeat(){var e;if(this.isConnected()){if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),(e=this.conn)===null||e===void 0||e.close(uo,"hearbeat timeout");return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.setAuth()}}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(n=>n.topic===e&&(n._isJoined()||n._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t._joinRef()!==e._joinRef())}setupConnection(){this.conn&&(this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_onConnMessage(e){this.decode(e.data,t=>{let{topic:n,event:s,payload:o,ref:i}=t;i&&i===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null),this.log("receive",`${o.status||""} ${n} ${s} ${i&&"("+i+")"||""}`,o),this.channels.filter(a=>a._isMember(n)).forEach(a=>a._trigger(s,o,i)),this.stateChangeCallbacks.message.forEach(a=>a(t))})}async _onConnOpen(){if(this.log("transport",`connected to ${this.endpointURL()}`),this.flushSendBuffer(),this.reconnectTimer.reset(),!this.worker)this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs);else{this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this.workerRef.terminate()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}this.stateChangeCallbacks.open.forEach(e=>e())}_onConnClose(e){this.log("transport","close",e),this._triggerChanError(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(t=>t(e))}_onConnError(e){this.log("transport",e.message),this._triggerChanError(),this.stateChangeCallbacks.error.forEach(t=>t(e))}_triggerChanError(){this.channels.forEach(e=>e._trigger(W.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const n=e.match(/\?/)?"&":"?",s=new URLSearchParams(t);return`${e}${n}${s}`}_workerObjectUrl(e){let t;if(e)t=e;else{const n=new Blob([_o],{type:"application/javascript"});t=URL.createObjectURL(n)}return t}}class ko{constructor(e,t,n){this.binaryType="arraybuffer",this.onclose=()=>{},this.onerror=()=>{},this.onmessage=()=>{},this.onopen=()=>{},this.readyState=ke.connecting,this.send=()=>{},this.url=null,this.url=e,this.close=n.close}}class Qt extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function R(r){return typeof r=="object"&&r!==null&&"__isStorageError"in r}class So extends Qt{constructor(e,t){super(e),this.name="StorageApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class jt extends Qt{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}var To=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(o){return o instanceof t?o:new t(function(i){i(o)})}return new(t||(t=Promise))(function(o,i){function a(c){try{d(n.next(c))}catch(u){i(u)}}function l(c){try{d(n.throw(c))}catch(u){i(u)}}function d(c){c.done?o(c.value):s(c.value).then(a,l)}d((n=n.apply(r,e||[])).next())})};const un=r=>{let e;return r?e=r:typeof fetch>"u"?e=(...t)=>Q(()=>Promise.resolve().then(()=>Ce),void 0).then(({default:n})=>n(...t)):e=fetch,(...t)=>e(...t)},Co=()=>To(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield Q(()=>Promise.resolve().then(()=>Ce),void 0)).Response:Response}),Rt=r=>{if(Array.isArray(r))return r.map(t=>Rt(t));if(typeof r=="function"||r!==Object(r))return r;const e={};return Object.entries(r).forEach(([t,n])=>{const s=t.replace(/([-_][a-z])/gi,o=>o.toUpperCase().replace(/[-_]/g,""));e[s]=Rt(n)}),e};var me=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(o){return o instanceof t?o:new t(function(i){i(o)})}return new(t||(t=Promise))(function(o,i){function a(c){try{d(n.next(c))}catch(u){i(u)}}function l(c){try{d(n.throw(c))}catch(u){i(u)}}function d(c){c.done?o(c.value):s(c.value).then(a,l)}d((n=n.apply(r,e||[])).next())})};const Et=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),Po=(r,e,t)=>me(void 0,void 0,void 0,function*(){const n=yield Co();r instanceof n&&!(t!=null&&t.noResolveJson)?r.json().then(s=>{e(new So(Et(s),r.status||500))}).catch(s=>{e(new jt(Et(s),s))}):e(new jt(Et(r),r))}),xo=(r,e,t,n)=>{const s={method:r,headers:(e==null?void 0:e.headers)||{}};return r==="GET"?s:(s.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),n&&(s.body=JSON.stringify(n)),Object.assign(Object.assign({},s),t))};function qe(r,e,t,n,s,o){return me(this,void 0,void 0,function*(){return new Promise((i,a)=>{r(t,xo(e,n,s,o)).then(l=>{if(!l.ok)throw l;return n!=null&&n.noResolveJson?l:l.json()}).then(l=>i(l)).catch(l=>Po(l,a,n))})})}function tt(r,e,t,n){return me(this,void 0,void 0,function*(){return qe(r,"GET",e,t,n)})}function re(r,e,t,n,s){return me(this,void 0,void 0,function*(){return qe(r,"POST",e,n,s,t)})}function Lo(r,e,t,n,s){return me(this,void 0,void 0,function*(){return qe(r,"PUT",e,n,s,t)})}function Io(r,e,t,n){return me(this,void 0,void 0,function*(){return qe(r,"HEAD",e,Object.assign(Object.assign({},t),{noResolveJson:!0}),n)})}function hn(r,e,t,n,s){return me(this,void 0,void 0,function*(){return qe(r,"DELETE",e,n,s,t)})}var M=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(o){return o instanceof t?o:new t(function(i){i(o)})}return new(t||(t=Promise))(function(o,i){function a(c){try{d(n.next(c))}catch(u){i(u)}}function l(c){try{d(n.throw(c))}catch(u){i(u)}}function d(c){c.done?o(c.value):s(c.value).then(a,l)}d((n=n.apply(r,e||[])).next())})};const Ao={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Er={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class $o{constructor(e,t={},n,s){this.url=e,this.headers=t,this.bucketId=n,this.fetch=un(s)}uploadOrUpdate(e,t,n,s){return M(this,void 0,void 0,function*(){try{let o;const i=Object.assign(Object.assign({},Er),s);let a=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(i.upsert)});const l=i.metadata;typeof Blob<"u"&&n instanceof Blob?(o=new FormData,o.append("cacheControl",i.cacheControl),l&&o.append("metadata",this.encodeMetadata(l)),o.append("",n)):typeof FormData<"u"&&n instanceof FormData?(o=n,o.append("cacheControl",i.cacheControl),l&&o.append("metadata",this.encodeMetadata(l))):(o=n,a["cache-control"]=`max-age=${i.cacheControl}`,a["content-type"]=i.contentType,l&&(a["x-metadata"]=this.toBase64(this.encodeMetadata(l)))),s!=null&&s.headers&&(a=Object.assign(Object.assign({},a),s.headers));const d=this._removeEmptyFolders(t),c=this._getFinalPath(d),u=yield this.fetch(`${this.url}/object/${c}`,Object.assign({method:e,body:o,headers:a},i!=null&&i.duplex?{duplex:i.duplex}:{})),h=yield u.json();return u.ok?{data:{path:d,id:h.Id,fullPath:h.Key},error:null}:{data:null,error:h}}catch(o){if(R(o))return{data:null,error:o};throw o}})}upload(e,t,n){return M(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,n)})}uploadToSignedUrl(e,t,n,s){return M(this,void 0,void 0,function*(){const o=this._removeEmptyFolders(e),i=this._getFinalPath(o),a=new URL(this.url+`/object/upload/sign/${i}`);a.searchParams.set("token",t);try{let l;const d=Object.assign({upsert:Er.upsert},s),c=Object.assign(Object.assign({},this.headers),{"x-upsert":String(d.upsert)});typeof Blob<"u"&&n instanceof Blob?(l=new FormData,l.append("cacheControl",d.cacheControl),l.append("",n)):typeof FormData<"u"&&n instanceof FormData?(l=n,l.append("cacheControl",d.cacheControl)):(l=n,c["cache-control"]=`max-age=${d.cacheControl}`,c["content-type"]=d.contentType);const u=yield this.fetch(a.toString(),{method:"PUT",body:l,headers:c}),h=yield u.json();return u.ok?{data:{path:o,fullPath:h.Key},error:null}:{data:null,error:h}}catch(l){if(R(l))return{data:null,error:l};throw l}})}createSignedUploadUrl(e,t){return M(this,void 0,void 0,function*(){try{let n=this._getFinalPath(e);const s=Object.assign({},this.headers);t!=null&&t.upsert&&(s["x-upsert"]="true");const o=yield re(this.fetch,`${this.url}/object/upload/sign/${n}`,{},{headers:s}),i=new URL(this.url+o.url),a=i.searchParams.get("token");if(!a)throw new Qt("No token returned by API");return{data:{signedUrl:i.toString(),path:e,token:a},error:null}}catch(n){if(R(n))return{data:null,error:n};throw n}})}update(e,t,n){return M(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,n)})}move(e,t,n){return M(this,void 0,void 0,function*(){try{return{data:yield re(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:n==null?void 0:n.destinationBucket},{headers:this.headers}),error:null}}catch(s){if(R(s))return{data:null,error:s};throw s}})}copy(e,t,n){return M(this,void 0,void 0,function*(){try{return{data:{path:(yield re(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:n==null?void 0:n.destinationBucket},{headers:this.headers})).Key},error:null}}catch(s){if(R(s))return{data:null,error:s};throw s}})}createSignedUrl(e,t,n){return M(this,void 0,void 0,function*(){try{let s=this._getFinalPath(e),o=yield re(this.fetch,`${this.url}/object/sign/${s}`,Object.assign({expiresIn:t},n!=null&&n.transform?{transform:n.transform}:{}),{headers:this.headers});const i=n!=null&&n.download?`&download=${n.download===!0?"":n.download}`:"";return o={signedUrl:encodeURI(`${this.url}${o.signedURL}${i}`)},{data:o,error:null}}catch(s){if(R(s))return{data:null,error:s};throw s}})}createSignedUrls(e,t,n){return M(this,void 0,void 0,function*(){try{const s=yield re(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),o=n!=null&&n.download?`&download=${n.download===!0?"":n.download}`:"";return{data:s.map(i=>Object.assign(Object.assign({},i),{signedUrl:i.signedURL?encodeURI(`${this.url}${i.signedURL}${o}`):null})),error:null}}catch(s){if(R(s))return{data:null,error:s};throw s}})}download(e,t){return M(this,void 0,void 0,function*(){const s=typeof(t==null?void 0:t.transform)<"u"?"render/image/authenticated":"object",o=this.transformOptsToQueryString((t==null?void 0:t.transform)||{}),i=o?`?${o}`:"";try{const a=this._getFinalPath(e);return{data:yield(yield tt(this.fetch,`${this.url}/${s}/${a}${i}`,{headers:this.headers,noResolveJson:!0})).blob(),error:null}}catch(a){if(R(a))return{data:null,error:a};throw a}})}info(e){return M(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const n=yield tt(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:Rt(n),error:null}}catch(n){if(R(n))return{data:null,error:n};throw n}})}exists(e){return M(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield Io(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(n){if(R(n)&&n instanceof jt){const s=n.originalError;if([400,404].includes(s==null?void 0:s.status))return{data:!1,error:n}}throw n}})}getPublicUrl(e,t){const n=this._getFinalPath(e),s=[],o=t!=null&&t.download?`download=${t.download===!0?"":t.download}`:"";o!==""&&s.push(o);const a=typeof(t==null?void 0:t.transform)<"u"?"render/image":"object",l=this.transformOptsToQueryString((t==null?void 0:t.transform)||{});l!==""&&s.push(l);let d=s.join("&");return d!==""&&(d=`?${d}`),{data:{publicUrl:encodeURI(`${this.url}/${a}/public/${n}${d}`)}}}remove(e){return M(this,void 0,void 0,function*(){try{return{data:yield hn(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(R(t))return{data:null,error:t};throw t}})}list(e,t,n){return M(this,void 0,void 0,function*(){try{const s=Object.assign(Object.assign(Object.assign({},Ao),t),{prefix:e||""});return{data:yield re(this.fetch,`${this.url}/object/list/${this.bucketId}`,s,{headers:this.headers},n),error:null}}catch(s){if(R(s))return{data:null,error:s};throw s}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const Oo="2.7.1",jo={"X-Client-Info":`storage-js/${Oo}`};var we=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(o){return o instanceof t?o:new t(function(i){i(o)})}return new(t||(t=Promise))(function(o,i){function a(c){try{d(n.next(c))}catch(u){i(u)}}function l(c){try{d(n.throw(c))}catch(u){i(u)}}function d(c){c.done?o(c.value):s(c.value).then(a,l)}d((n=n.apply(r,e||[])).next())})};class Ro{constructor(e,t={},n){this.url=e,this.headers=Object.assign(Object.assign({},jo),t),this.fetch=un(n)}listBuckets(){return we(this,void 0,void 0,function*(){try{return{data:yield tt(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(R(e))return{data:null,error:e};throw e}})}getBucket(e){return we(this,void 0,void 0,function*(){try{return{data:yield tt(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(R(t))return{data:null,error:t};throw t}})}createBucket(e,t={public:!1}){return we(this,void 0,void 0,function*(){try{return{data:yield re(this.fetch,`${this.url}/bucket`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(n){if(R(n))return{data:null,error:n};throw n}})}updateBucket(e,t){return we(this,void 0,void 0,function*(){try{return{data:yield Lo(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(n){if(R(n))return{data:null,error:n};throw n}})}emptyBucket(e){return we(this,void 0,void 0,function*(){try{return{data:yield re(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(R(t))return{data:null,error:t};throw t}})}deleteBucket(e){return we(this,void 0,void 0,function*(){try{return{data:yield hn(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(R(t))return{data:null,error:t};throw t}})}}class Uo extends Ro{constructor(e,t={},n){super(e,t,n)}from(e){return new $o(this.url,this.headers,e,this.fetch)}}const No="2.49.4";let Oe="";typeof Deno<"u"?Oe="deno":typeof document<"u"?Oe="web":typeof navigator<"u"&&navigator.product==="ReactNative"?Oe="react-native":Oe="node";const Do={"X-Client-Info":`supabase-js-${Oe}/${No}`},Bo={headers:Do},Fo={schema:"public"},Mo={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},qo={};var zo=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(o){return o instanceof t?o:new t(function(i){i(o)})}return new(t||(t=Promise))(function(o,i){function a(c){try{d(n.next(c))}catch(u){i(u)}}function l(c){try{d(n.throw(c))}catch(u){i(u)}}function d(c){c.done?o(c.value):s(c.value).then(a,l)}d((n=n.apply(r,e||[])).next())})};const Ho=r=>{let e;return r?e=r:typeof fetch>"u"?e=Kr:e=fetch,(...t)=>e(...t)},Jo=()=>typeof Headers>"u"?Yr:Headers,Wo=(r,e,t)=>{const n=Ho(t),s=Jo();return(o,i)=>zo(void 0,void 0,void 0,function*(){var a;const l=(a=yield e())!==null&&a!==void 0?a:r;let d=new s(i==null?void 0:i.headers);return d.has("apikey")||d.set("apikey",r),d.has("Authorization")||d.set("Authorization",`Bearer ${l}`),n(o,Object.assign(Object.assign({},i),{headers:d}))})};var Vo=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(o){return o instanceof t?o:new t(function(i){i(o)})}return new(t||(t=Promise))(function(o,i){function a(c){try{d(n.next(c))}catch(u){i(u)}}function l(c){try{d(n.throw(c))}catch(u){i(u)}}function d(c){c.done?o(c.value):s(c.value).then(a,l)}d((n=n.apply(r,e||[])).next())})};function Go(r){return r.replace(/\/$/,"")}function Ko(r,e){const{db:t,auth:n,realtime:s,global:o}=r,{db:i,auth:a,realtime:l,global:d}=e,c={db:Object.assign(Object.assign({},i),t),auth:Object.assign(Object.assign({},a),n),realtime:Object.assign(Object.assign({},l),s),global:Object.assign(Object.assign({},d),o),accessToken:()=>Vo(this,void 0,void 0,function*(){return""})};return r.accessToken?c.accessToken=r.accessToken:delete c.accessToken,c}const gn="2.69.1",ve=30*1e3,Ut=3,kt=Ut*ve,Yo="http://localhost:9999",Qo="supabase.auth.token",Xo={"X-Client-Info":`gotrue-js/${gn}`},Nt="X-Supabase-Api-Version",fn={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},Zo=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,ei=6e5;class Xt extends Error{constructor(e,t,n){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=n}}function E(r){return typeof r=="object"&&r!==null&&"__isAuthError"in r}class ti extends Xt{constructor(e,t,n){super(e,t,n),this.name="AuthApiError",this.status=t,this.code=n}}function ri(r){return E(r)&&r.name==="AuthApiError"}class mn extends Xt{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class ae extends Xt{constructor(e,t,n,s){super(e,n,s),this.name=t,this.status=n}}class ee extends ae{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function ni(r){return E(r)&&r.name==="AuthSessionMissingError"}class St extends ae{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class He extends ae{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class Je extends ae{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function si(r){return E(r)&&r.name==="AuthImplicitGrantRedirectError"}class kr extends ae{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class Dt extends ae{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function Tt(r){return E(r)&&r.name==="AuthRetryableFetchError"}class Sr extends ae{constructor(e,t,n){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=n}}class Ue extends ae{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const Tr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),Cr=` 	
\r=`.split(""),oi=(()=>{const r=new Array(128);for(let e=0;e<r.length;e+=1)r[e]=-1;for(let e=0;e<Cr.length;e+=1)r[Cr[e].charCodeAt(0)]=-2;for(let e=0;e<Tr.length;e+=1)r[Tr[e].charCodeAt(0)]=e;return r})();function pn(r,e,t){const n=oi[r];if(n>-1)for(e.queue=e.queue<<6|n,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(n===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(r)}"`)}}function Pr(r){const e=[],t=i=>{e.push(String.fromCodePoint(i))},n={utf8seq:0,codepoint:0},s={queue:0,queuedBits:0},o=i=>{li(i,n,t)};for(let i=0;i<r.length;i+=1)pn(r.charCodeAt(i),s,o);return e.join("")}function ii(r,e){if(r<=127){e(r);return}else if(r<=2047){e(192|r>>6),e(128|r&63);return}else if(r<=65535){e(224|r>>12),e(128|r>>6&63),e(128|r&63);return}else if(r<=1114111){e(240|r>>18),e(128|r>>12&63),e(128|r>>6&63),e(128|r&63);return}throw new Error(`Unrecognized Unicode codepoint: ${r.toString(16)}`)}function ai(r,e){for(let t=0;t<r.length;t+=1){let n=r.charCodeAt(t);if(n>55295&&n<=56319){const s=(n-55296)*1024&65535;n=(r.charCodeAt(t+1)-56320&65535|s)+65536,t+=1}ii(n,e)}}function li(r,e,t){if(e.utf8seq===0){if(r<=127){t(r);return}for(let n=1;n<6;n+=1)if(!(r>>7-n&1)){e.utf8seq=n;break}if(e.utf8seq===2)e.codepoint=r&31;else if(e.utf8seq===3)e.codepoint=r&15;else if(e.utf8seq===4)e.codepoint=r&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(r<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|r&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function ci(r){const e=[],t={queue:0,queuedBits:0},n=s=>{e.push(s)};for(let s=0;s<r.length;s+=1)pn(r.charCodeAt(s),t,n);return new Uint8Array(e)}function di(r){const e=[];return ai(r,t=>e.push(t)),new Uint8Array(e)}function ui(r){return Math.round(Date.now()/1e3)+r}function hi(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){const e=Math.random()*16|0;return(r=="x"?e:e&3|8).toString(16)})}const V=()=>typeof window<"u"&&typeof document<"u",ce={tested:!1,writable:!1},Ne=()=>{if(!V())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(ce.tested)return ce.writable;const r=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(r,r),globalThis.localStorage.removeItem(r),ce.tested=!0,ce.writable=!0}catch{ce.tested=!0,ce.writable=!1}return ce.writable};function gi(r){const e={},t=new URL(r);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((s,o)=>{e[o]=s})}catch{}return t.searchParams.forEach((n,s)=>{e[s]=n}),e}const wn=r=>{let e;return r?e=r:typeof fetch>"u"?e=(...t)=>Q(()=>Promise.resolve().then(()=>Ce),void 0).then(({default:n})=>n(...t)):e=fetch,(...t)=>e(...t)},fi=r=>typeof r=="object"&&r!==null&&"status"in r&&"ok"in r&&"json"in r&&typeof r.json=="function",yn=async(r,e,t)=>{await r.setItem(e,JSON.stringify(t))},We=async(r,e)=>{const t=await r.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},Ve=async(r,e)=>{await r.removeItem(e)};class ut{constructor(){this.promise=new ut.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}ut.promiseConstructor=Promise;function Ct(r){const e=r.split(".");if(e.length!==3)throw new Ue("Invalid JWT structure");for(let n=0;n<e.length;n++)if(!Zo.test(e[n]))throw new Ue("JWT not in base64url format");return{header:JSON.parse(Pr(e[0])),payload:JSON.parse(Pr(e[1])),signature:ci(e[2]),raw:{header:e[0],payload:e[1]}}}async function mi(r){return await new Promise(e=>{setTimeout(()=>e(null),r)})}function pi(r,e){return new Promise((n,s)=>{(async()=>{for(let o=0;o<1/0;o++)try{const i=await r(o);if(!e(o,null,i)){n(i);return}}catch(i){if(!e(o,i)){s(i);return}}})()})}function wi(r){return("0"+r.toString(16)).substr(-2)}function yi(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",n=t.length;let s="";for(let o=0;o<56;o++)s+=t.charAt(Math.floor(Math.random()*n));return s}return crypto.getRandomValues(e),Array.from(e,wi).join("")}async function bi(r){const t=new TextEncoder().encode(r),n=await crypto.subtle.digest("SHA-256",t),s=new Uint8Array(n);return Array.from(s).map(o=>String.fromCharCode(o)).join("")}async function vi(r){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),r;const t=await bi(r);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function ye(r,e,t=!1){const n=yi();let s=n;t&&(s+="/PASSWORD_RECOVERY"),await yn(r,`${e}-code-verifier`,s);const o=await vi(n);return[o,n===o?"plain":"s256"]}const _i=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function Ei(r){const e=r.headers.get(Nt);if(!e||!e.match(_i))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function ki(r){if(!r)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(r<=e)throw new Error("JWT has expired")}function Si(r){switch(r){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}var Ti=globalThis&&globalThis.__rest||function(r,e){var t={};for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,n=Object.getOwnPropertySymbols(r);s<n.length;s++)e.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(r,n[s])&&(t[n[s]]=r[n[s]]);return t};const ue=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),Ci=[502,503,504];async function xr(r){var e;if(!fi(r))throw new Dt(ue(r),0);if(Ci.includes(r.status))throw new Dt(ue(r),r.status);let t;try{t=await r.json()}catch(o){throw new mn(ue(o),o)}let n;const s=Ei(r);if(s&&s.getTime()>=fn["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?n=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(n=t.error_code),n){if(n==="weak_password")throw new Sr(ue(t),r.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(n==="session_not_found")throw new ee}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((o,i)=>o&&typeof i=="string",!0))throw new Sr(ue(t),r.status,t.weak_password.reasons);throw new ti(ue(t),r.status||500,n)}const Pi=(r,e,t,n)=>{const s={method:r,headers:(e==null?void 0:e.headers)||{}};return r==="GET"?s:(s.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),s.body=JSON.stringify(n),Object.assign(Object.assign({},s),t))};async function C(r,e,t,n){var s;const o=Object.assign({},n==null?void 0:n.headers);o[Nt]||(o[Nt]=fn["2024-01-01"].name),n!=null&&n.jwt&&(o.Authorization=`Bearer ${n.jwt}`);const i=(s=n==null?void 0:n.query)!==null&&s!==void 0?s:{};n!=null&&n.redirectTo&&(i.redirect_to=n.redirectTo);const a=Object.keys(i).length?"?"+new URLSearchParams(i).toString():"",l=await xi(r,e,t+a,{headers:o,noResolveJson:n==null?void 0:n.noResolveJson},{},n==null?void 0:n.body);return n!=null&&n.xform?n==null?void 0:n.xform(l):{data:Object.assign({},l),error:null}}async function xi(r,e,t,n,s,o){const i=Pi(e,n,s,o);let a;try{a=await r(t,Object.assign({},i))}catch(l){throw console.error(l),new Dt(ue(l),0)}if(a.ok||await xr(a),n!=null&&n.noResolveJson)return a;try{return await a.json()}catch(l){await xr(l)}}function te(r){var e;let t=null;$i(r)&&(t=Object.assign({},r),r.expires_at||(t.expires_at=ui(r.expires_in)));const n=(e=r.user)!==null&&e!==void 0?e:r;return{data:{session:t,user:n},error:null}}function Lr(r){const e=te(r);return!e.error&&r.weak_password&&typeof r.weak_password=="object"&&Array.isArray(r.weak_password.reasons)&&r.weak_password.reasons.length&&r.weak_password.message&&typeof r.weak_password.message=="string"&&r.weak_password.reasons.reduce((t,n)=>t&&typeof n=="string",!0)&&(e.data.weak_password=r.weak_password),e}function ne(r){var e;return{data:{user:(e=r.user)!==null&&e!==void 0?e:r},error:null}}function Li(r){return{data:r,error:null}}function Ii(r){const{action_link:e,email_otp:t,hashed_token:n,redirect_to:s,verification_type:o}=r,i=Ti(r,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),a={action_link:e,email_otp:t,hashed_token:n,redirect_to:s,verification_type:o},l=Object.assign({},i);return{data:{properties:a,user:l},error:null}}function Ai(r){return r}function $i(r){return r.access_token&&r.refresh_token&&r.expires_in}var Oi=globalThis&&globalThis.__rest||function(r,e){var t={};for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,n=Object.getOwnPropertySymbols(r);s<n.length;s++)e.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(r,n[s])&&(t[n[s]]=r[n[s]]);return t};class ji{constructor({url:e="",headers:t={},fetch:n}){this.url=e,this.headers=t,this.fetch=wn(n),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(e,t="global"){try{return await C(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(n){if(E(n))return{data:null,error:n};throw n}}async inviteUserByEmail(e,t={}){try{return await C(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:ne})}catch(n){if(E(n))return{data:{user:null},error:n};throw n}}async generateLink(e){try{const{options:t}=e,n=Oi(e,["options"]),s=Object.assign(Object.assign({},n),t);return"newEmail"in n&&(s.new_email=n==null?void 0:n.newEmail,delete s.newEmail),await C(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:s,headers:this.headers,xform:Ii,redirectTo:t==null?void 0:t.redirectTo})}catch(t){if(E(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await C(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:ne})}catch(t){if(E(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,n,s,o,i,a,l;try{const d={nextPage:null,lastPage:0,total:0},c=await C(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(n=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:"",per_page:(o=(s=e==null?void 0:e.perPage)===null||s===void 0?void 0:s.toString())!==null&&o!==void 0?o:""},xform:Ai});if(c.error)throw c.error;const u=await c.json(),h=(i=c.headers.get("x-total-count"))!==null&&i!==void 0?i:0,f=(l=(a=c.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return f.length>0&&(f.forEach(w=>{const T=parseInt(w.split(";")[0].split("=")[1].substring(0,1)),S=JSON.parse(w.split(";")[1].split("=")[1]);d[`${S}Page`]=T}),d.total=parseInt(h)),{data:Object.assign(Object.assign({},u),d),error:null}}catch(d){if(E(d))return{data:{users:[]},error:d};throw d}}async getUserById(e){try{return await C(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:ne})}catch(t){if(E(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){try{return await C(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:ne})}catch(n){if(E(n))return{data:{user:null},error:n};throw n}}async deleteUser(e,t=!1){try{return await C(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:ne})}catch(n){if(E(n))return{data:{user:null},error:n};throw n}}async _listFactors(e){try{const{data:t,error:n}=await C(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:s=>({data:{factors:s},error:null})});return{data:t,error:n}}catch(t){if(E(t))return{data:null,error:t};throw t}}async _deleteFactor(e){try{return{data:await C(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(E(t))return{data:null,error:t};throw t}}}const Ri={getItem:r=>Ne()?globalThis.localStorage.getItem(r):null,setItem:(r,e)=>{Ne()&&globalThis.localStorage.setItem(r,e)},removeItem:r=>{Ne()&&globalThis.localStorage.removeItem(r)}};function Ir(r={}){return{getItem:e=>r[e]||null,setItem:(e,t)=>{r[e]=t},removeItem:e=>{delete r[e]}}}function Ui(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}const be={debug:!!(globalThis&&Ne()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class bn extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class Ni extends bn{}async function Di(r,e,t){be.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",r,e);const n=new globalThis.AbortController;return e>0&&setTimeout(()=>{n.abort(),be.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",r)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(r,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:n.signal},async s=>{if(s){be.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",r,s.name);try{return await t()}finally{be.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",r,s.name)}}else{if(e===0)throw be.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",r),new Ni(`Acquiring an exclusive Navigator LockManager lock "${r}" immediately failed`);if(be.debug)try{const o=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(o,null,"  "))}catch(o){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",o)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}Ui();const Bi={url:Yo,storageKey:Qo,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:Xo,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1};async function Ar(r,e,t){return await t()}class Be{constructor(e){var t,n;this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=Be.nextInstanceID,Be.nextInstanceID+=1,this.instanceID>0&&V()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const s=Object.assign(Object.assign({},Bi),e);if(this.logDebugMessages=!!s.debug,typeof s.debug=="function"&&(this.logger=s.debug),this.persistSession=s.persistSession,this.storageKey=s.storageKey,this.autoRefreshToken=s.autoRefreshToken,this.admin=new ji({url:s.url,headers:s.headers,fetch:s.fetch}),this.url=s.url,this.headers=s.headers,this.fetch=wn(s.fetch),this.lock=s.lock||Ar,this.detectSessionInUrl=s.detectSessionInUrl,this.flowType=s.flowType,this.hasCustomAuthorizationHeader=s.hasCustomAuthorizationHeader,s.lock?this.lock=s.lock:V()&&(!((t=globalThis==null?void 0:globalThis.navigator)===null||t===void 0)&&t.locks)?this.lock=Di:this.lock=Ar,this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER,this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?s.storage?this.storage=s.storage:Ne()?this.storage=Ri:(this.memoryStorage={},this.storage=Ir(this.memoryStorage)):(this.memoryStorage={},this.storage=Ir(this.memoryStorage)),V()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(o){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",o)}(n=this.broadcastChannel)===null||n===void 0||n.addEventListener("message",async o=>{this._debug("received broadcast notification from other tab or client",o),await this._notifyAllSubscribers(o.data.event,o.data.session,!1)})}this.initialize()}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${gn}) ${new Date().toISOString()}`,...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{const t=gi(window.location.href);let n="none";if(this._isImplicitGrantCallback(t)?n="implicit":await this._isPKCECallback(t)&&(n="pkce"),V()&&this.detectSessionInUrl&&n!=="none"){const{data:s,error:o}=await this._getSessionFromURL(t,n);if(o){if(this._debug("#_initialize()","error detecting session from URL",o),si(o)){const l=(e=o.details)===null||e===void 0?void 0:e.code;if(l==="identity_already_exists"||l==="identity_not_found"||l==="single_identity_not_deletable")return{error:o}}return await this._removeSession(),{error:o}}const{session:i,redirectType:a}=s;return this._debug("#_initialize()","detected session in URL",i,"redirect type",a),await this._saveSession(i),setTimeout(async()=>{a==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",i):await this._notifyAllSubscribers("SIGNED_IN",i)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return E(t)?{error:t}:{error:new mn("Unexpected error during initialization",t)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,n,s;try{const o=await C(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(n=(t=e==null?void 0:e.options)===null||t===void 0?void 0:t.data)!==null&&n!==void 0?n:{},gotrue_meta_security:{captcha_token:(s=e==null?void 0:e.options)===null||s===void 0?void 0:s.captchaToken}},xform:te}),{data:i,error:a}=o;if(a||!i)return{data:{user:null,session:null},error:a};const l=i.session,d=i.user;return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",l)),{data:{user:d,session:l},error:null}}catch(o){if(E(o))return{data:{user:null,session:null},error:o};throw o}}async signUp(e){var t,n,s;try{let o;if("email"in e){const{email:c,password:u,options:h}=e;let f=null,w=null;this.flowType==="pkce"&&([f,w]=await ye(this.storage,this.storageKey)),o=await C(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:h==null?void 0:h.emailRedirectTo,body:{email:c,password:u,data:(t=h==null?void 0:h.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:h==null?void 0:h.captchaToken},code_challenge:f,code_challenge_method:w},xform:te})}else if("phone"in e){const{phone:c,password:u,options:h}=e;o=await C(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:c,password:u,data:(n=h==null?void 0:h.data)!==null&&n!==void 0?n:{},channel:(s=h==null?void 0:h.channel)!==null&&s!==void 0?s:"sms",gotrue_meta_security:{captcha_token:h==null?void 0:h.captchaToken}},xform:te})}else throw new He("You must provide either an email or phone number and a password");const{data:i,error:a}=o;if(a||!i)return{data:{user:null,session:null},error:a};const l=i.session,d=i.user;return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",l)),{data:{user:d,session:l},error:null}}catch(o){if(E(o))return{data:{user:null,session:null},error:o};throw o}}async signInWithPassword(e){try{let t;if("email"in e){const{email:o,password:i,options:a}=e;t=await C(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:o,password:i,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:Lr})}else if("phone"in e){const{phone:o,password:i,options:a}=e;t=await C(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:o,password:i,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:Lr})}else throw new He("You must provide either an email or phone number and a password");const{data:n,error:s}=t;return s?{data:{user:null,session:null},error:s}:!n||!n.session||!n.user?{data:{user:null,session:null},error:new St}:(n.session&&(await this._saveSession(n.session),await this._notifyAllSubscribers("SIGNED_IN",n.session)),{data:Object.assign({user:n.user,session:n.session},n.weak_password?{weakPassword:n.weak_password}:null),error:s})}catch(t){if(E(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOAuth(e){var t,n,s,o;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(n=e.options)===null||n===void 0?void 0:n.scopes,queryParams:(s=e.options)===null||s===void 0?void 0:s.queryParams,skipBrowserRedirect:(o=e.options)===null||o===void 0?void 0:o.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async _exchangeCodeForSession(e){const t=await We(this.storage,`${this.storageKey}-code-verifier`),[n,s]=(t??"").split("/");try{const{data:o,error:i}=await C(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:n},xform:te});if(await Ve(this.storage,`${this.storageKey}-code-verifier`),i)throw i;return!o||!o.session||!o.user?{data:{user:null,session:null,redirectType:null},error:new St}:(o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",o.session)),{data:Object.assign(Object.assign({},o),{redirectType:s??null}),error:i})}catch(o){if(E(o))return{data:{user:null,session:null,redirectType:null},error:o};throw o}}async signInWithIdToken(e){try{const{options:t,provider:n,token:s,access_token:o,nonce:i}=e,a=await C(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:n,id_token:s,access_token:o,nonce:i,gotrue_meta_security:{captcha_token:t==null?void 0:t.captchaToken}},xform:te}),{data:l,error:d}=a;return d?{data:{user:null,session:null},error:d}:!l||!l.session||!l.user?{data:{user:null,session:null},error:new St}:(l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),{data:l,error:d})}catch(t){if(E(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOtp(e){var t,n,s,o,i;try{if("email"in e){const{email:a,options:l}=e;let d=null,c=null;this.flowType==="pkce"&&([d,c]=await ye(this.storage,this.storageKey));const{error:u}=await C(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:a,data:(t=l==null?void 0:l.data)!==null&&t!==void 0?t:{},create_user:(n=l==null?void 0:l.shouldCreateUser)!==null&&n!==void 0?n:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},code_challenge:d,code_challenge_method:c},redirectTo:l==null?void 0:l.emailRedirectTo});return{data:{user:null,session:null},error:u}}if("phone"in e){const{phone:a,options:l}=e,{data:d,error:c}=await C(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:a,data:(s=l==null?void 0:l.data)!==null&&s!==void 0?s:{},create_user:(o=l==null?void 0:l.shouldCreateUser)!==null&&o!==void 0?o:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},channel:(i=l==null?void 0:l.channel)!==null&&i!==void 0?i:"sms"}});return{data:{user:null,session:null,messageId:d==null?void 0:d.message_id},error:c}}throw new He("You must provide either an email or phone number.")}catch(a){if(E(a))return{data:{user:null,session:null},error:a};throw a}}async verifyOtp(e){var t,n;try{let s,o;"options"in e&&(s=(t=e.options)===null||t===void 0?void 0:t.redirectTo,o=(n=e.options)===null||n===void 0?void 0:n.captchaToken);const{data:i,error:a}=await C(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:o}}),redirectTo:s,xform:te});if(a)throw a;if(!i)throw new Error("An error occurred on token verification.");const l=i.session,d=i.user;return l!=null&&l.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),{data:{user:d,session:l},error:null}}catch(s){if(E(s))return{data:{user:null,session:null},error:s};throw s}}async signInWithSSO(e){var t,n,s;try{let o=null,i=null;return this.flowType==="pkce"&&([o,i]=await ye(this.storage,this.storageKey)),await C(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(n=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&n!==void 0?n:void 0}),!((s=e==null?void 0:e.options)===null||s===void 0)&&s.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:o,code_challenge_method:i}),headers:this.headers,xform:Li})}catch(o){if(E(o))return{data:null,error:o};throw o}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:n}=e;if(n)throw n;if(!t)throw new ee;const{error:s}=await C(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:s}})}catch(e){if(E(e))return{data:{user:null,session:null},error:e};throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:n,type:s,options:o}=e,{error:i}=await C(this.fetch,"POST",t,{headers:this.headers,body:{email:n,type:s,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},redirectTo:o==null?void 0:o.emailRedirectTo});return{data:{user:null,session:null},error:i}}else if("phone"in e){const{phone:n,type:s,options:o}=e,{data:i,error:a}=await C(this.fetch,"POST",t,{headers:this.headers,body:{phone:n,type:s,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}}});return{data:{user:null,session:null,messageId:i==null?void 0:i.message_id},error:a}}throw new He("You must provide either an email or phone number and a type")}catch(t){if(E(t))return{data:{user:null,session:null},error:t};throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const n=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),s=(async()=>(await n,await t()))();return this.pendingInLock.push((async()=>{try{await s}catch{}})()),s}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const n=t();for(this.pendingInLock.push((async()=>{try{await n}catch{}})()),await n;this.pendingInLock.length;){const s=[...this.pendingInLock];await Promise.all(s),this.pendingInLock.splice(0,s.length)}return await n}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await We(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const n=e.expires_at?e.expires_at*1e3-Date.now()<kt:!1;if(this._debug("#__loadSession()",`session has${n?"":" not"} expired`,"expires_at",e.expires_at),!n){if(this.storage.isServer){let i=this.suppressGetSessionWarning;e=new Proxy(e,{get:(l,d,c)=>(!i&&d==="user"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),i=!0,this.suppressGetSessionWarning=!0),Reflect.get(l,d,c))})}return{data:{session:e},error:null}}const{session:s,error:o}=await this._callRefreshToken(e.refresh_token);return o?{data:{session:null},error:o}:{data:{session:s},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await C(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:ne}):await this._useSession(async t=>{var n,s,o;const{data:i,error:a}=t;if(a)throw a;return!(!((n=i.session)===null||n===void 0)&&n.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new ee}:await C(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(o=(s=i.session)===null||s===void 0?void 0:s.access_token)!==null&&o!==void 0?o:void 0,xform:ne})})}catch(t){if(E(t))return ni(t)&&(await this._removeSession(),await Ve(this.storage,`${this.storageKey}-code-verifier`)),{data:{user:null},error:t};throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async n=>{const{data:s,error:o}=n;if(o)throw o;if(!s.session)throw new ee;const i=s.session;let a=null,l=null;this.flowType==="pkce"&&e.email!=null&&([a,l]=await ye(this.storage,this.storageKey));const{data:d,error:c}=await C(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t==null?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:a,code_challenge_method:l}),jwt:i.access_token,xform:ne});if(c)throw c;return i.user=d.user,await this._saveSession(i),await this._notifyAllSubscribers("USER_UPDATED",i),{data:{user:i.user},error:null}})}catch(n){if(E(n))return{data:{user:null},error:n};throw n}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new ee;const t=Date.now()/1e3;let n=t,s=!0,o=null;const{payload:i}=Ct(e.access_token);if(i.exp&&(n=i.exp,s=n<=t),s){const{session:a,error:l}=await this._callRefreshToken(e.refresh_token);if(l)return{data:{user:null,session:null},error:l};if(!a)return{data:{user:null,session:null},error:null};o=a}else{const{data:a,error:l}=await this._getUser(e.access_token);if(l)throw l;o={access_token:e.access_token,refresh_token:e.refresh_token,user:a.user,token_type:"bearer",expires_in:n-t,expires_at:n},await this._saveSession(o),await this._notifyAllSubscribers("SIGNED_IN",o)}return{data:{user:o.user,session:o},error:null}}catch(t){if(E(t))return{data:{session:null,user:null},error:t};throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var n;if(!e){const{data:i,error:a}=t;if(a)throw a;e=(n=i.session)!==null&&n!==void 0?n:void 0}if(!(e!=null&&e.refresh_token))throw new ee;const{session:s,error:o}=await this._callRefreshToken(e.refresh_token);return o?{data:{user:null,session:null},error:o}:s?{data:{user:s.user,session:s},error:null}:{data:{user:null,session:null},error:null}})}catch(t){if(E(t))return{data:{user:null,session:null},error:t};throw t}}async _getSessionFromURL(e,t){try{if(!V())throw new Je("No browser detected.");if(e.error||e.error_description||e.error_code)throw new Je(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new kr("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new Je("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new kr("No code detected.");const{data:N,error:O}=await this._exchangeCodeForSession(e.code);if(O)throw O;const x=new URL(window.location.href);return x.searchParams.delete("code"),window.history.replaceState(window.history.state,"",x.toString()),{data:{session:N.session,redirectType:null},error:null}}const{provider_token:n,provider_refresh_token:s,access_token:o,refresh_token:i,expires_in:a,expires_at:l,token_type:d}=e;if(!o||!a||!i||!d)throw new Je("No session defined in URL");const c=Math.round(Date.now()/1e3),u=parseInt(a);let h=c+u;l&&(h=parseInt(l));const f=h-c;f*1e3<=ve&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${f}s, should have been closer to ${u}s`);const w=h-u;c-w>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",w,h,c):c-w<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",w,h,c);const{data:T,error:S}=await this._getUser(o);if(S)throw S;const I={provider_token:n,provider_refresh_token:s,access_token:o,expires_in:u,expires_at:h,refresh_token:i,token_type:d,user:T.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:I,redirectType:e.type},error:null}}catch(n){if(E(n))return{data:{session:null,redirectType:null},error:n};throw n}}_isImplicitGrantCallback(e){return!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await We(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var n;const{data:s,error:o}=t;if(o)return{error:o};const i=(n=s.session)===null||n===void 0?void 0:n.access_token;if(i){const{error:a}=await this.admin.signOut(i,e);if(a&&!(ri(a)&&(a.status===404||a.status===401||a.status===403)))return{error:a}}return e!=="others"&&(await this._removeSession(),await Ve(this.storage,`${this.storageKey}-code-verifier`)),{error:null}})}onAuthStateChange(e){const t=hi(),n={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,n),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:n}}}async _emitInitialSession(e){return await this._useSession(async t=>{var n,s;try{const{data:{session:o},error:i}=t;if(i)throw i;await((n=this.stateChangeEmitters.get(e))===null||n===void 0?void 0:n.callback("INITIAL_SESSION",o)),this._debug("INITIAL_SESSION","callback id",e,"session",o)}catch(o){await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",o),console.error(o)}})}async resetPasswordForEmail(e,t={}){let n=null,s=null;this.flowType==="pkce"&&([n,s]=await ye(this.storage,this.storageKey,!0));try{return await C(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:n,code_challenge_method:s,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(o){if(E(o))return{data:null,error:o};throw o}}async getUserIdentities(){var e;try{const{data:t,error:n}=await this.getUser();if(n)throw n;return{data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null}}catch(t){if(E(t))return{data:null,error:t};throw t}}async linkIdentity(e){var t;try{const{data:n,error:s}=await this._useSession(async o=>{var i,a,l,d,c;const{data:u,error:h}=o;if(h)throw h;const f=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(i=e.options)===null||i===void 0?void 0:i.redirectTo,scopes:(a=e.options)===null||a===void 0?void 0:a.scopes,queryParams:(l=e.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await C(this.fetch,"GET",f,{headers:this.headers,jwt:(c=(d=u.session)===null||d===void 0?void 0:d.access_token)!==null&&c!==void 0?c:void 0})});if(s)throw s;return V()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(n==null?void 0:n.url),{data:{provider:e.provider,url:n==null?void 0:n.url},error:null}}catch(n){if(E(n))return{data:{provider:e.provider,url:null},error:n};throw n}}async unlinkIdentity(e){try{return await this._useSession(async t=>{var n,s;const{data:o,error:i}=t;if(i)throw i;return await C(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(s=(n=o.session)===null||n===void 0?void 0:n.access_token)!==null&&s!==void 0?s:void 0})})}catch(t){if(E(t))return{data:null,error:t};throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const n=Date.now();return await pi(async s=>(s>0&&await mi(200*Math.pow(2,s-1)),this._debug(t,"refreshing attempt",s),await C(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:te})),(s,o)=>{const i=200*Math.pow(2,s);return o&&Tt(o)&&Date.now()+i-n<ve})}catch(n){if(this._debug(t,"error",n),E(n))return{data:{session:null,user:null},error:n};throw n}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const n=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",n),V()&&!t.skipBrowserRedirect&&window.location.assign(n),{data:{provider:e,url:n},error:null}}async _recoverAndRefresh(){var e;const t="#_recoverAndRefresh()";this._debug(t,"begin");try{const n=await We(this.storage,this.storageKey);if(this._debug(t,"session from storage",n),!this._isValidSession(n)){this._debug(t,"session is not valid"),n!==null&&await this._removeSession();return}const s=((e=n.expires_at)!==null&&e!==void 0?e:1/0)*1e3-Date.now()<kt;if(this._debug(t,`session has${s?"":" not"} expired with margin of ${kt}s`),s){if(this.autoRefreshToken&&n.refresh_token){const{error:o}=await this._callRefreshToken(n.refresh_token);o&&(console.error(o),Tt(o)||(this._debug(t,"refresh failed with a non-retryable error, removing the session",o),await this._removeSession()))}}else await this._notifyAllSubscribers("SIGNED_IN",n)}catch(n){this._debug(t,"error",n),console.error(n);return}finally{this._debug(t,"end")}}async _callRefreshToken(e){var t,n;if(!e)throw new ee;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const s=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(s,"begin");try{this.refreshingDeferred=new ut;const{data:o,error:i}=await this._refreshAccessToken(e);if(i)throw i;if(!o.session)throw new ee;await this._saveSession(o.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",o.session);const a={session:o.session,error:null};return this.refreshingDeferred.resolve(a),a}catch(o){if(this._debug(s,"error",o),E(o)){const i={session:null,error:o};return Tt(o)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(i),i}throw(n=this.refreshingDeferred)===null||n===void 0||n.reject(o),o}finally{this.refreshingDeferred=null,this._debug(s,"end")}}async _notifyAllSubscribers(e,t,n=!0){const s=`#_notifyAllSubscribers(${e})`;this._debug(s,"begin",t,`broadcast = ${n}`);try{this.broadcastChannel&&n&&this.broadcastChannel.postMessage({event:e,session:t});const o=[],i=Array.from(this.stateChangeEmitters.values()).map(async a=>{try{await a.callback(e,t)}catch(l){o.push(l)}});if(await Promise.all(i),o.length>0){for(let a=0;a<o.length;a+=1)console.error(o[a]);throw o[0]}}finally{this._debug(s,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await yn(this.storage,this.storageKey,e)}async _removeSession(){this._debug("#_removeSession()"),await Ve(this.storage,this.storageKey),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&V()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),ve);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:n}}=t;if(!n||!n.refresh_token||!n.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const s=Math.floor((n.expires_at*1e3-e)/ve);this._debug("#_autoRefreshTokenTick()",`access token expires in ${s} ticks, a tick lasts ${ve}ms, refresh threshold is ${Ut} ticks`),s<=Ut&&await this._callRefreshToken(n.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof bn)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!V()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,n){const s=[`provider=${encodeURIComponent(t)}`];if(n!=null&&n.redirectTo&&s.push(`redirect_to=${encodeURIComponent(n.redirectTo)}`),n!=null&&n.scopes&&s.push(`scopes=${encodeURIComponent(n.scopes)}`),this.flowType==="pkce"){const[o,i]=await ye(this.storage,this.storageKey),a=new URLSearchParams({code_challenge:`${encodeURIComponent(o)}`,code_challenge_method:`${encodeURIComponent(i)}`});s.push(a.toString())}if(n!=null&&n.queryParams){const o=new URLSearchParams(n.queryParams);s.push(o.toString())}return n!=null&&n.skipBrowserRedirect&&s.push(`skip_http_redirect=${n.skipBrowserRedirect}`),`${e}?${s.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var n;const{data:s,error:o}=t;return o?{data:null,error:o}:await C(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(n=s==null?void 0:s.session)===null||n===void 0?void 0:n.access_token})})}catch(t){if(E(t))return{data:null,error:t};throw t}}async _enroll(e){try{return await this._useSession(async t=>{var n,s;const{data:o,error:i}=t;if(i)return{data:null,error:i};const a=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:{issuer:e.issuer}),{data:l,error:d}=await C(this.fetch,"POST",`${this.url}/factors`,{body:a,headers:this.headers,jwt:(n=o==null?void 0:o.session)===null||n===void 0?void 0:n.access_token});return d?{data:null,error:d}:(e.factorType==="totp"&&(!((s=l==null?void 0:l.totp)===null||s===void 0)&&s.qr_code)&&(l.totp.qr_code=`data:image/svg+xml;utf-8,${l.totp.qr_code}`),{data:l,error:null})})}catch(t){if(E(t))return{data:null,error:t};throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var n;const{data:s,error:o}=t;if(o)return{data:null,error:o};const{data:i,error:a}=await C(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:(n=s==null?void 0:s.session)===null||n===void 0?void 0:n.access_token});return a?{data:null,error:a}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+i.expires_in},i)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",i),{data:i,error:a})})}catch(t){if(E(t))return{data:null,error:t};throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var n;const{data:s,error:o}=t;return o?{data:null,error:o}:await C(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:{channel:e.channel},headers:this.headers,jwt:(n=s==null?void 0:s.session)===null||n===void 0?void 0:n.access_token})})}catch(t){if(E(t))return{data:null,error:t};throw t}})}async _challengeAndVerify(e){const{data:t,error:n}=await this._challenge({factorId:e.factorId});return n?{data:null,error:n}:await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){const{data:{user:e},error:t}=await this.getUser();if(t)return{data:null,error:t};const n=(e==null?void 0:e.factors)||[],s=n.filter(i=>i.factor_type==="totp"&&i.status==="verified"),o=n.filter(i=>i.factor_type==="phone"&&i.status==="verified");return{data:{all:n,totp:s,phone:o},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async e=>{var t,n;const{data:{session:s},error:o}=e;if(o)return{data:null,error:o};if(!s)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:i}=Ct(s.access_token);let a=null;i.aal&&(a=i.aal);let l=a;((n=(t=s.user.factors)===null||t===void 0?void 0:t.filter(u=>u.status==="verified"))!==null&&n!==void 0?n:[]).length>0&&(l="aal2");const c=i.amr||[];return{data:{currentLevel:a,nextLevel:l,currentAuthenticationMethods:c},error:null}}))}async fetchJwk(e,t={keys:[]}){let n=t.keys.find(i=>i.kid===e);if(n||(n=this.jwks.keys.find(i=>i.kid===e),n&&this.jwks_cached_at+ei>Date.now()))return n;const{data:s,error:o}=await C(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(o)throw o;if(!s.keys||s.keys.length===0)throw new Ue("JWKS is empty");if(this.jwks=s,this.jwks_cached_at=Date.now(),n=s.keys.find(i=>i.kid===e),!n)throw new Ue("No matching signing key found in JWKS");return n}async getClaims(e,t={keys:[]}){try{let n=e;if(!n){const{data:f,error:w}=await this.getSession();if(w||!f.session)return{data:null,error:w};n=f.session.access_token}const{header:s,payload:o,signature:i,raw:{header:a,payload:l}}=Ct(n);if(ki(o.exp),!s.kid||s.alg==="HS256"||!("crypto"in globalThis&&"subtle"in globalThis.crypto)){const{error:f}=await this.getUser(n);if(f)throw f;return{data:{claims:o,header:s,signature:i},error:null}}const d=Si(s.alg),c=await this.fetchJwk(s.kid,t),u=await crypto.subtle.importKey("jwk",c,d,!0,["verify"]);if(!await crypto.subtle.verify(d,u,i,di(`${a}.${l}`)))throw new Ue("Invalid JWT signature");return{data:{claims:o,header:s,signature:i},error:null}}catch(n){if(E(n))return{data:null,error:n};throw n}}}Be.nextInstanceID=0;const Fi=Be;class Mi extends Fi{constructor(e){super(e)}}var qi=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(o){return o instanceof t?o:new t(function(i){i(o)})}return new(t||(t=Promise))(function(o,i){function a(c){try{d(n.next(c))}catch(u){i(u)}}function l(c){try{d(n.throw(c))}catch(u){i(u)}}function d(c){c.done?o(c.value):s(c.value).then(a,l)}d((n=n.apply(r,e||[])).next())})};class zi{constructor(e,t,n){var s,o,i;if(this.supabaseUrl=e,this.supabaseKey=t,!e)throw new Error("supabaseUrl is required.");if(!t)throw new Error("supabaseKey is required.");const a=Go(e);this.realtimeUrl=`${a}/realtime/v1`.replace(/^http/i,"ws"),this.authUrl=`${a}/auth/v1`,this.storageUrl=`${a}/storage/v1`,this.functionsUrl=`${a}/functions/v1`;const l=`sb-${new URL(this.authUrl).hostname.split(".")[0]}-auth-token`,d={db:Fo,realtime:qo,auth:Object.assign(Object.assign({},Mo),{storageKey:l}),global:Bo},c=Ko(n??{},d);this.storageKey=(s=c.auth.storageKey)!==null&&s!==void 0?s:"",this.headers=(o=c.global.headers)!==null&&o!==void 0?o:{},c.accessToken?(this.accessToken=c.accessToken,this.auth=new Proxy({},{get:(u,h)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(h)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((i=c.auth)!==null&&i!==void 0?i:{},this.headers,c.global.fetch),this.fetch=Wo(t,this._getAccessToken.bind(this),c.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},c.realtime)),this.rest=new io(`${a}/rest/v1`,{headers:this.headers,schema:c.db.schema,fetch:this.fetch}),c.accessToken||this._listenForAuthEvents()}get functions(){return new Rs(this.functionsUrl,{headers:this.headers,customFetch:this.fetch})}get storage(){return new Uo(this.storageUrl,this.headers,this.fetch)}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},n={}){return this.rest.rpc(e,t,n)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return qi(this,void 0,void 0,function*(){if(this.accessToken)return yield this.accessToken();const{data:n}=yield this.auth.getSession();return(t=(e=n.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:null})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:n,storage:s,storageKey:o,flowType:i,lock:a,debug:l},d,c){const u={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new Mi({url:this.authUrl,headers:Object.assign(Object.assign({},u),d),storageKey:o,autoRefreshToken:e,persistSession:t,detectSessionInUrl:n,storage:s,flowType:i,lock:a,debug:l,fetch:c,hasCustomAuthorizationHeader:"Authorization"in this.headers})}_initRealtimeClient(e){return new Eo(this.realtimeUrl,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,n)=>{this._handleTokenChanged(t,"CLIENT",n==null?void 0:n.access_token)})}_handleTokenChanged(e,t,n){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==n?this.changedAccessToken=n:e==="SIGNED_OUT"&&(this.realtime.setAuth(),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const Hi=(r,e,t)=>new zi(r,e,t),Ji="https://fvbafecdoqslcvmyxqjf.supabase.co",Wi="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2YmFmZWNkb3FzbGN2bXl4cWpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5NDg3MjYsImV4cCI6MjA1OTUyNDcyNn0.TfhLP9BBhokuAPVaxFQy4dg-MvZlsJDquVFPF-OWjOM",g=Hi(Ji,Wi);async function Qe(){const{data:{user:r}}=await g.auth.getUser();return r}async function Vi(r,e){const{data:t,error:n}=await g.auth.signUp({email:r,password:e});if(n)throw n;return t}async function Gi(r,e){const{data:t,error:n}=await g.auth.signInWithPassword({email:r,password:e});if(n)throw n;return t}async function Ki(){const{error:r}=await g.auth.signOut();if(r)throw r}function Yi(r){const{data:e}=g.auth.onAuthStateChange((t,n)=>{r(t,n)});return e.subscription.unsubscribe}async function ht(){try{const{data:{user:r}}=await g.auth.getUser();if(!r)throw new Error("No user logged in");const{data:e,error:t}=await g.from("posts").select(`
        *,
        tags:post_tags(
          tag:tags(*)
        )
      `).eq("user_id",r.id).order("created_at",{ascending:!1});if(t)throw t;return e||[]}catch(r){return console.error("Error getting posts:",r),[]}}async function Qi(r){try{const{data:{user:e}}=await g.auth.getUser();if(!e)throw new Error("No user logged in");const{data:t,error:n}=await g.from("posts").select(`
        *,
        tags:post_tags(
          tag:tags(*)
        )
      `).eq("id",r).eq("user_id",e.id).single();if(n)throw n;return t}catch(e){throw console.error("Error getting post by ID:",e),e}}async function Zt(r){try{const{data:{user:e}}=await g.auth.getUser(),{data:{session:t}}=await g.auth.getSession();if(!e)throw new Error("No user logged in");if(!t)throw new Error("No valid session found. Please log in again.");if(t.expires_at&&new Date(t.expires_at*1e3)<new Date){console.log("Session expired, attempting to refresh...");const{data:i,error:a}=await g.auth.refreshSession();if(a)throw console.error("Error refreshing session:",a),new Error("Session expired and could not be refreshed. Please log in again.");console.log("Session refreshed successfully")}const n={user_id:e.id,url:r.url,title:r.title||"",description:r.description||"",platform:r.platform||"",created_at:r.dateAdded||new Date().toISOString(),updated_at:r.lastUpdated||new Date().toISOString()};console.log("Creating new post with data:",n);const{data:s,error:o}=await g.from("posts").insert([n]).select();if(o)throw console.error("Supabase insert error:",o),o;if(!s||s.length===0)throw new Error("Post creation returned no data");return console.log("Post created successfully with ID:",s[0].id),s[0]}catch(e){throw console.error("Error creating post:",e),e}}async function er(r,e){try{const{data:{user:t}}=await g.auth.getUser(),{data:{session:n}}=await g.auth.getSession();if(!t)throw new Error("No user logged in");if(!n)throw new Error("No valid session found. Please log in again.");if(n.expires_at&&new Date(n.expires_at*1e3)<new Date){console.log("Session expired, attempting to refresh...");const{data:d,error:c}=await g.auth.refreshSession();if(c)throw console.error("Error refreshing session:",c),new Error("Session expired and could not be refreshed. Please log in again.");console.log("Session refreshed successfully")}const{data:s,error:o}=await g.from("posts").select("id").eq("id",r).eq("user_id",t.id).single();if(o)throw console.error("Error verifying post ownership:",o),o;if(!s)throw new Error("Post not found or does not belong to user");const i={...e,user_id:t.id,updated_at:new Date().toISOString()};console.log(`Updating post ${r} with data:`,i);const{data:a,error:l}=await g.from("posts").update(i).eq("id",r).select();if(l)throw console.error("Supabase update error:",l),l;if(!a||a.length===0)throw new Error("Post update returned no data");return a[0]}catch(t){throw console.error("Error updating post:",t),t}}async function Xi(r){try{const{data:{user:e}}=await g.auth.getUser(),{data:{session:t}}=await g.auth.getSession();if(!e)throw new Error("No user logged in");if(!t)throw new Error("No valid session found. Please log in again.");if(t.expires_at&&new Date(t.expires_at*1e3)<new Date){console.log("Session expired, attempting to refresh...");const{data:a,error:l}=await g.auth.refreshSession();if(l)throw console.error("Error refreshing session:",l),new Error("Session expired and could not be refreshed. Please log in again.");console.log("Session refreshed successfully")}const{data:n,error:s}=await g.from("posts").select("id").eq("id",r).eq("user_id",e.id).single();if(s&&s.code!=="PGRST116")throw console.error("Error verifying post ownership:",s),s;if(!n)return console.warn(`Post ${r} not found or does not belong to user ${e.id}`),!1;console.log(`Deleting post ${r} and its associations`);const{error:o}=await g.from("post_tags").delete().eq("post_id",r);if(o)throw console.error("Error deleting post tags:",o),o;const{error:i}=await g.from("posts").delete().eq("id",r).eq("user_id",e.id);if(i)throw console.error("Error deleting post:",i),i;return console.log(`Post ${r} successfully deleted from Supabase`),!0}catch(e){throw console.error("Error deleting post:",e),e}}async function Zi(r){try{const{data:{user:e}}=await g.auth.getUser();if(!e)throw new Error("No user logged in");const{data:t,error:n}=await g.from("post_tags").select(`
        post:posts(*),
        tag:tags(*)
      `).eq("tag_id",r).eq("post.user_id",e.id);if(n)throw n;return t.map(s=>({...s.post,tag:s.tag}))}catch(e){throw console.error("Error getting posts by tag:",e),e}}async function tr(r){try{const{data:{user:e}}=await g.auth.getUser();if(!e)throw new Error("No user logged in");const{data:t,error:n}=await g.from("posts").select("*").eq("url",r).eq("user_id",e.id);return{data:t,error:n}}catch(e){return console.error("Error finding post by URL:",e),{data:null,error:e}}}const ea=Object.freeze(Object.defineProperty({__proto__:null,createPost:Zt,deletePost:Xi,findPostByUrl:tr,getPostById:Qi,getPosts:ht,getPostsByTag:Zi,updatePost:er},Symbol.toStringTag,{value:"Module"}));async function vn(){try{const{data:{user:r}}=await g.auth.getUser();if(!r)throw new Error("No user logged in");const{data:e,error:t}=await g.from("tags").select("*").eq("user_id",r.id);if(t)throw t;return e||[]}catch(r){return console.error("Error getting tags:",r),[]}}async function _n(r){try{const{data:{user:e}}=await g.auth.getUser();if(!e)throw new Error("No user logged in");const{data:t,error:n}=await g.from("tags").insert([{user_id:e.id,name:r.name,color:r.color||"#cccccc"}]).select();if(n)throw n;return t[0]}catch(e){throw console.error("Error creating tag:",e),e}}async function ta(r){try{const{data:{user:e}}=await g.auth.getUser();if(!e)throw new Error("No user logged in");const{data:t,error:n}=await g.from("post_tags").select(`
        *,
        tag:tags(*)
      `).eq("post_id",r);if(n)throw n;return t||[]}catch(e){return console.error("Error getting post tags:",e),[]}}async function ra(){try{const{data:{user:r}}=await g.auth.getUser();if(!r)throw new Error("No user logged in");const{data:e,error:t}=await g.from("post_tags").select(`
        *,
        post:posts!inner(*),
        tag:tags!inner(*)
      `).eq("post.user_id",r.id);if(t)throw t;return e||[]}catch(r){return console.error("Error getting all post tags:",r),[]}}async function Pt(r,e){try{const{data:{user:t}}=await g.auth.getUser();if(!t)throw new Error("No user logged in");const n=(e||[]).filter(d=>d!=null);if(!r||n.length===0)return console.log("No valid post ID or tag IDs to associate"),!1;const{data:s,error:o}=await g.from("posts").select("id").eq("id",r).eq("user_id",t.id).single();if(o)throw console.error("Error verifying post ownership:",o),o;if(!s)return console.error("Post not found or does not belong to user"),!1;const i=n.map(d=>({post_id:r,tag_id:d})),{error:a}=await g.from("post_tags").delete().eq("post_id",r);if(a)throw console.error("Error removing existing post_tags:",a),a;const{error:l}=await g.from("post_tags").insert(i);if(l)throw console.error("Error inserting post_tags:",l),l;return!0}catch(t){throw console.error("Error in associateTagsWithPost:",t),t}}const rt={isSyncing:!1,lastSyncTime:null,pendingChanges:[],syncErrors:[],startSync(){this.isSyncing=!0,console.log("Sync started")},endSync(r=!0,e=null){this.isSyncing=!1,r?(this.lastSyncTime=new Date,console.log("Sync completed successfully at",this.lastSyncTime)):e&&(this.syncErrors.push({timestamp:new Date,error:e.message||"Unknown error"}),console.error("Sync failed:",e))},addPendingChange(r){if(!r||!r.entity||!r.type){console.error("Invalid change object:",r);return}this.pendingChanges.push({...r,timestamp:new Date}),console.log("Added pending change:",r)},clearPendingChanges(){const r=this.pendingChanges.length;this.pendingChanges=[],console.log(`Cleared ${r} pending changes`)},getStatus(){return{isSyncing:this.isSyncing,lastSyncTime:this.lastSyncTime,pendingChangesCount:this.pendingChanges.length,hasErrors:this.syncErrors.length>0}},isSyncInProgress(){return this.isSyncing},getLastSyncTime(){return this.lastSyncTime}};function na(r){if(!r)return null;const e={id:r.id,url:r.url,platform:r.platform,title:r.title||"",description:r.description||"",dateAdded:r.created_at,lastUpdated:r.updated_at,tags:[]};return e.imageUrl="",r.local_embed_html?e.embedHtml=r.local_embed_html:e.embedHtml="",e}function nt(r){if(!r)return null;const e={url:r.url,platform:r.platform,title:r.title||"",description:r.description||"",updated_at:r.lastUpdated||new Date().toISOString()};return r.dateAdded&&(e.created_at=r.dateAdded),r.user_id&&(e.user_id=r.user_id),console.log("Formatted post for Supabase:",e),e}function Bt(r){const e={};return!r||!Array.isArray(r)||r.forEach(t=>{t&&t.url&&(e[t.url]=t)}),e}function Ft(r){const e={};return!r||!Array.isArray(r)||r.forEach(t=>{t&&t.name&&(e[t.name.toLowerCase()]=t)}),e}function En(r){return typeof r=="object"&&r!==null&&r.name?{name:r.name,color:r.color||"#cccccc"}:typeof r=="string"?{name:r,color:"#cccccc"}:null}function sa(r){if(!r||!Array.isArray(r))return[];console.log("Processing tags:",JSON.stringify(r)),console.log("Tags types:",r.map(t=>typeof t));const e=[];for(let t=0;t<r.length;t++){const n=r[t];console.log(`Processing tag ${t}:`,n,"Type:",typeof n);const s=En(n);s&&e.push(s)}return console.log("Normalized tag objects:",e.length,JSON.stringify(e)),e}async function kn(r){try{if(console.log("syncTagsToCloud called"),!r||!Array.isArray(r)||r.length===0)return console.log("No posts to sync tags for"),{};const{data:{user:e}}=await g.auth.getUser(),{data:{session:t}}=await g.auth.getSession();if(!e)throw console.error("No user logged in"),new Error("No user logged in");if(!t)throw console.error("No valid session found"),new Error("No valid session found. Please log in again.");if(t.expires_at&&new Date(t.expires_at*1e3)<new Date){console.log("Session expired, attempting to refresh...");const{data:l,error:d}=await g.auth.refreshSession();if(d)throw console.error("Error refreshing session:",d),new Error("Session expired and could not be refreshed. Please log in again.");console.log("Session refreshed successfully")}const n=Vt();console.log("Local tags count:",n.length);const s=await vn();console.log("Cloud tags count:",s.length);const o=Ft(s),i=[];if(n.forEach(l=>{if(l&&l.name){const d=En(l);d&&!o[d.name.toLowerCase()]&&i.push(d)}}),i.length>0){console.log("Creating missing tags in cloud:",i.length);const l=await Promise.all(i.map(async d=>{try{const c=await _n(d);return c&&c.id?(o[d.name.toLowerCase()]=c,c):null}catch(c){return console.error("Error creating tag:",c),null}}));console.log("Created tags count:",l.filter(d=>d!==null).length)}else console.log("No new tags to create in cloud");const a=n.map(l=>{if(l&&l.name){const d=o[l.name.toLowerCase()];if(d&&d.id)return{...l,id:d.id}}return l});return zr(a),o}catch(e){throw console.error("Error syncing tags to cloud:",e),e}}async function Mt(r,e,t){try{if(console.log("syncPostTags called for post ID:",r),!r){console.error("Invalid post ID provided to syncPostTags");return}if(!e||!Array.isArray(e)||e.length===0){console.log("No local tags to sync for post:",r);try{await Pt(r,[]),console.log("Cleared all tags for post with no tags")}catch(l){console.error("Error clearing tags for post:",l)}return}console.log("Local tags count:",e.length),console.log("Local tags:",JSON.stringify(e));const n=sa(e);if(n.length===0){console.log("No valid local tags to sync for post:",r);return}console.log("Normalized tags:",JSON.stringify(n));const s=await ta(r);console.log("Existing post tags count:",s.length);const o=new Set(n.map(l=>l.name.toLowerCase())),i=new Set(s.map(l=>l.tag&&l.tag.name?l.tag.name.toLowerCase():null).filter(l=>l!==null));if(console.log("Local tag names:",Array.from(o)),console.log("Cloud tag names:",Array.from(i)),o.size===i.size&&Array.from(o).every(l=>i.has(l))){console.log("Tags are already in sync, no changes needed");return}const a=[];for(const l of n){const d=l.name.toLowerCase();if(t[d])console.log(`Tag '${l.name}' exists in cloud with ID: ${t[d].id}`),a.push(t[d].id);else try{console.log(`Creating new tag '${l.name}' in Supabase`);const c=await _n({name:l.name,color:l.color||"#cccccc"});c&&c.id?(console.log(`Created tag '${l.name}' with ID: ${c.id}`),t[d]=c,a.push(c.id)):console.error(`Failed to create tag '${l.name}'`)}catch(c){console.error(`Error creating tag '${l.name}':`,c)}}if(a.length>0){console.log(`Associating ${a.length} tags with post ${r}:`,a);try{await Pt(r,a)?console.log("Successfully associated tags with post"):console.error("Failed to associate tags with post")}catch(l){console.error("Error associating tags with post:",l)}}else{console.log("No tags to associate with post");try{await Pt(r,[]),console.log("Cleared all tags for post")}catch(l){console.error("Error clearing tags for post:",l)}}console.log("Post tags sync completed for post ID:",r)}catch(n){throw console.error("Error syncing post tags:",n),n}}async function Sn(){try{console.log("Starting local to cloud post sync");const r=U(!0);if(console.log(`Local posts: ${r.length}`),r.length===0){console.log("No local posts to sync");return}const e=await kn(U(!0));console.log("Cloud tags prepared for post sync");for(const t of r)try{const{data:n,error:s}=await tr(t.url);if(s){console.error("Error finding post by URL:",s);continue}if(n&&n.length>0){const o=n[0];console.log(`Updating existing post in cloud: ${o.id}`);const i=nt(t);await er(o.id,i),t.tags&&t.tags.length>0&&await Mt(o.id,t.tags,e)}else{console.log(`Creating new post in cloud: ${t.url}`);const o=nt(t),i=await Zt(o);i&&i.id&&(console.log(`Post created with ID: ${i.id}`),t.id=i.id,t.tags&&t.tags.length>0&&await Mt(i.id,t.tags,e))}}catch(n){console.error(`Error syncing post ${t.url}:`,n)}Z(r),console.log("Local to cloud post sync completed")}catch(r){throw console.error("Error in syncLocalToCloud:",r),r}}async function Tn(r=!1){try{console.log("Starting cloud to local post sync");const e=await ht();if(console.log(`Cloud posts: ${e.length}`),e.length===0)return console.log("No cloud posts to sync"),[];const t=U(!0);console.log(`Local posts: ${t.length}`);const n=Bt(t),s=await ra();console.log(`Post-tag associations: ${s.length}`);const o={};s.forEach(a=>{o[a.post_id]||(o[a.post_id]=[]),o[a.post_id].push(a)});const i=[];for(const a of e){const l=na(a),d=o[a.id]||[];d.length>0?l.tags=d.map(u=>u.tag?{id:u.tag.id,name:u.tag.name,color:u.tag.color||"#cccccc"}:null).filter(u=>u!==null):l.tags=[];const c=n[a.url];c?(c.id=a.id,c.title=l.title,c.description=l.description,c.imageUrl=l.imageUrl,c.embedHtml=l.embedHtml,c.dateAdded=l.dateAdded,c.lastUpdated=l.lastUpdated,c.tags=l.tags,i.push(c)):i.push(l)}return Z(i),console.log("Cloud to local post sync completed"),r||(console.log("Dispatching cloudDataReady event"),window.boardie.cloudPosts=i,window.boardie.cloudDataReady=!0,document.dispatchEvent(new CustomEvent("cloudDataReady",{detail:{posts:i}}))),i}catch(e){throw console.error("Error in syncCloudToLocal:",e),e}}async function oa(r){try{if(!r||!r.url)return console.error("Invalid post object, cannot sync"),null;console.log(`Syncing single post to cloud: ${r.url}`),console.log("Post tags:",JSON.stringify(r.tags));const{data:{user:e}}=await g.auth.getUser(),{data:{session:t}}=await g.auth.getSession();if(!e)throw new Error("No user logged in");if(!t)throw new Error("No valid session found. Please log in again.");if(t.expires_at&&new Date(t.expires_at*1e3)<new Date){console.log("Session expired, attempting to refresh...");const{data:a,error:l}=await g.auth.refreshSession();if(l)throw console.error("Error refreshing session:",l),new Error("Session expired and could not be refreshed. Please log in again.");console.log("Session refreshed successfully")}r.user_id||(r.user_id=e.id),r.tags&&Array.isArray(r.tags)&&(r.tags=r.tags.map(a=>typeof a=="string"?{name:a,color:"#cccccc"}:typeof a=="object"&&a!==null?{name:a.name||"",color:a.color||"#cccccc"}:null).filter(a=>a!==null&&a.name));const n=await kn([r]),{data:s,error:o}=await tr(r.url);if(o)throw console.error("Error finding post by URL:",o),o;let i;if(s&&s.length>0){const a=s[0];console.log(`Updating existing post in cloud: ${a.id}`);const l=nt(r);l.user_id=e.id,i=await er(a.id,l),r.id=a.id}else{console.log(`Creating new post in cloud: ${r.url}`);const a=nt(r);a.user_id=e.id;const l=await Zt(a);i=l,l&&l.id&&(console.log(`Post created with ID: ${l.id}`),r.id=l.id)}return r.tags&&r.tags.length>0&&r.id&&(console.log(`Syncing ${r.tags.length} tags for post ${r.id}`),await Mt(r.id,r.tags,n)),i}catch(e){throw console.error("Error syncing single post to cloud:",e),e}}async function ia(){try{console.log("Initializing smart sync with cloud priority...");const{data:{user:r}}=await g.auth.getUser();if(!r){console.log("No user logged in, cannot perform smart sync");return}console.log("Fetching cloud data...");const e=await ht();console.log(`Cloud posts: ${e.length}`),e.length>0?(console.log("Using cloud data as source of truth"),await Tn(),console.log("Smart sync completed with cloud priority")):U(!0).length>0?(console.log("No cloud data found, but local data exists. Syncing local to cloud..."),await Sn(),console.log("Smart sync completed with local priority")):console.log("No data found in cloud or local storage, nothing to sync")}catch(r){throw console.error("Error in smart sync:",r),r}}async function _e(r=!1){console.log("Forcing sync operation...",r?"(skip rendering)":""),rt.isSyncing=!1;try{console.log("Syncing local to cloud..."),await Sn(),console.log("Syncing cloud to local..."),await Tn(r),rt.lastSyncTime=new Date,console.log("Forced sync completed")}catch(e){throw console.error("Error during forced sync:",e),e}}function qt(){return rt.isSyncInProgress()}function zt(){return rt.getLastSyncTime()}async function aa(){try{console.log("Starting migration to new sync system...");const r=U(!0),e=Vt();console.log(`Local data: ${r.length} posts, ${e.length} tags`);const t=await ht(),n=await vn();console.log(`Cloud data: ${t.length} posts, ${n.length} tags`);const s=Bt(r),o=Bt(t),i=Ft(e),a=Ft(n);for(const l in s){const d=s[l],c=o[l];c&&c.id&&(d.id=c.id)}for(const l in i){const d=i[l],c=a[l];c&&c.id&&(d.id=c.id)}return Z(r,!0),zr(e),localStorage.setItem("boardie_migration_completed","true"),console.log("Migration to new sync system completed successfully"),!0}catch(r){return console.error("Error during migration:",r),!1}}async function la(){try{if(localStorage.getItem("boardie_migration_completed")==="true")return console.log("Migration already completed according to localStorage"),!1;const e="../syncService.js";try{const t=await Q(()=>import(e),[]);if(t&&typeof t.forceSync=="function")return console.log("Old sync service detected, migration needed"),!0}catch{const n=localStorage.getItem("boardie_posts");if(n)try{const s=JSON.parse(n);if(Array.isArray(s)&&s.length>0)return console.log("Found old format data in localStorage, migration may be needed"),!0}catch{}return console.log("Could not import old sync service and no old format data found, assuming migration not needed"),!1}return!1}catch(r){return console.error("Error checking if migration is needed:",r),!1}}class ca{constructor(){this.pendingRenders=new Set,this.isRendering=!1,this.debounceTimer=null,this.renderDelay=50}scheduleRender(e=null){e?this.pendingRenders.add(e):(this.pendingRenders.clear(),this.pendingRenders.add("all")),this.debounceRender()}debounceRender(){this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.executeRender()},this.renderDelay)}async executeRender(){if(!this.isRendering){this.isRendering=!0;try{if(console.log("Executing render operation"),this.pendingRenders.has("all")){console.log("Performing full render");const e=U(!0);window.boardie.renderPosts(e)}else{console.log(`Performing partial render for ${this.pendingRenders.size} posts`);for(const e of this.pendingRenders){const t=et(e);t&&Wt(t)}}}catch(e){console.error("Error during render:",e)}finally{this.pendingRenders.clear(),this.isRendering=!1}}}renderPost(e){!e||!e.id||this.scheduleRender(e.id)}renderAllPosts(e=!1){e?(this.pendingRenders.clear(),this.pendingRenders.add("all"),this.executeRender()):this.scheduleRender()}}const da=new ca;function rr(r){const e=document.getElementById("addLinkModal"),t=document.getElementById("linkUrl");if(!e||!t){console.error("Add Link modal or URL input not found");return}clearSavedClipboardUrl(),e.classList.remove("hidden"),document.body.classList.add("overflow-hidden"),t.value=r,t.focus();const n=document.getElementById("linkTags");if(n){const s=$e();s&&s.length>0?je(n,s):se().then(o=>{je(n,o)})}console.log("Opened Add Link modal with URL:",r)}let $r=!1;function ua(){if($r){console.log("Event listeners already initialized, skipping setup");return}$r=!0,console.log("Setting up event listeners..."),j();const r=document.getElementById("filterDropdownBtn"),e=document.getElementById("filterDropdown");if(r&&e){const m=r.cloneNode(!0);r.parentNode.replaceChild(m,r),m.addEventListener("click",v=>{v.stopPropagation(),e.classList.toggle("hidden")}),document.addEventListener("click",v=>{!m.contains(v.target)&&!e.contains(v.target)&&e.classList.add("hidden")})}const t=document.getElementById("clearTagFilters"),n=document.getElementById("mobileClearTagFilters");t&&t.addEventListener("click",()=>mt(!1)),n&&n.addEventListener("click",()=>mt(!0));let s=null;document.addEventListener("setupTagFilters",()=>{s&&clearTimeout(s),s=setTimeout(()=>{console.log("Debounced setupTagFilters event"),j(),s=null},300)});const o=document.getElementById("addLinkBtn"),i=document.getElementById("addLinkModal"),a=document.getElementById("closeModalBtn"),l=document.getElementById("cancelAddLink"),d=document.getElementById("linkForm"),c=document.getElementById("editLinkModal"),u=document.getElementById("closeEditModalBtn"),h=document.getElementById("cancelEditLink"),f=document.getElementById("deletePostBtn"),w=document.getElementById("editLinkForm");document.getElementById("tagFilter");const T=document.getElementById("exportBtn"),S=document.getElementById("importFile"),I=document.getElementById("syncDataBtn"),N=document.getElementById("emptyStateAddBtn");o.addEventListener("click",async()=>{clearSavedClipboardUrl();const m=await Vr();m?rr(m):(i.classList.remove("hidden"),document.body.classList.add("overflow-hidden"),document.getElementById("linkUrl").focus());const v=$e(),y=document.getElementById("tagSuggestions");je(v,y,p=>{const _=document.getElementById("linkTags"),k=Le(_.value);let b;if(typeof p=="object"&&p!==null&&p.name?(b=p.name,console.log("Selected tag object in add form:",p,"Using name:",b)):(b=String(p),console.log("Selected tag string in add form:",b)),!k.includes(b)){const A=k.length>0?", ":"";_.value+=A+b}})}),a.addEventListener("click",()=>{O()}),i.addEventListener("click",m=>{m.target===i&&O()}),l.addEventListener("click",()=>{O()});function O(){i.classList.add("hidden"),document.body.classList.remove("overflow-hidden"),d.reset(),document.getElementById("tagSuggestions").innerHTML=""}function x(){c.classList.add("hidden"),document.body.classList.remove("overflow-hidden"),w.reset(),document.getElementById("editTagSuggestions").innerHTML=""}function j(){Te();const m=$e();lr(m,"availableTagsContainer","tagFilterContainer"),lr(m,"mobileAvailableTagsContainer","mobileTagFilterContainer")}function lr(m,v,y){const p=document.getElementById(v);p&&(p.innerHTML="",m.forEach(_=>{let k,b,A;typeof _=="object"&&_!==null&&_.name?(k=_.name,b=_.color||"#cccccc",A=_):(k=String(_),b="#cccccc",A={name:k,color:b});const L=document.createElement("span");L.className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium",L.dataset.tagName=k,L.dataset.tag=k,L.dataset.tagJson=JSON.stringify(A),L.textContent=k,L.style.backgroundColor="transparent",L.style.border=`1px solid ${b}`,L.style.color="#171717",L.addEventListener("click",()=>{ft(A,y)}),p.appendChild(L)}))}function ft(m,v="tagFilterContainer"){const y=document.getElementById(v);if(!y)return;let p,_;if(typeof m=="object"&&m!==null&&m.name?(p=m.name,_=m.color):(p=String(m),_="#e5e7eb"),Array.from(y.children).find(pe=>pe.dataset.tagName===p||pe.dataset.tag===p))return;const b=document.createElement("span");b.className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium",b.dataset.tagName=p,b.dataset.tag=p,b.style.backgroundColor="transparent",b.style.border=`1px solid ${_}`,b.style.color="#171717",b.innerHTML=`
      ${p}
      <button class="ml-1 text-gray-500 hover:text-gray-700 focus:outline-none">
        <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
      </button>
    `,b.querySelector("button").addEventListener("click",()=>{On(p,v)}),y.appendChild(b);const L=v==="mobileTagFilterContainer",$=document.getElementById(L?"mobileClearTagFilters":"clearTagFilters");$&&$.classList.remove("hidden");const J=L?"mobileAvailableTagsContainer":"availableTagsContainer",F=document.getElementById(J);if(F){const pe=F.querySelector(`[data-tag-name="${p}"], [data-tag="${p}"]`);pe&&pe.classList.add("hidden")}const xe=L?"tagFilterContainer":"mobileTagFilterContainer",D=document.getElementById(xe);D&&(Array.from(D.children).find(hr=>hr.dataset.tagName===p||hr.dataset.tag===p)||ft(m,xe)),pt();const le=pr();vt(le)}function On(m,v="tagFilterContainer"){const y=document.getElementById(v);if(!y)return;let p;typeof m=="object"&&m!==null&&m.name?p=m.name:p=String(m);const _=y.querySelector(`[data-tag-name="${p}"], [data-tag="${p}"]`);_&&_.remove();const k=v==="mobileTagFilterContainer",b=k?"mobileAvailableTagsContainer":"availableTagsContainer",A=document.getElementById(b);if(A){const F=A.querySelector(`[data-tag-name="${p}"], [data-tag="${p}"]`);F&&F.classList.remove("hidden")}if(y.children.length===0){const F=document.getElementById(k?"mobileClearTagFilters":"clearTagFilters");F&&F.classList.add("hidden")}const L=k?"tagFilterContainer":"mobileTagFilterContainer",$=document.getElementById(L);if($){const F=$.querySelector(`[data-tag-name="${p}"], [data-tag="${p}"]`);if(F){F.remove();const xe=k?"availableTagsContainer":"mobileAvailableTagsContainer",D=document.getElementById(xe);if(D){const le=D.querySelector(`[data-tag-name="${p}"], [data-tag="${p}"]`);le&&le.classList.remove("hidden")}if($.children.length===0){const le=document.getElementById(k?"clearTagFilters":"mobileClearTagFilters");le&&le.classList.add("hidden")}}}pt();const J=pr();vt(J)}function mt(m=!1){const v=document.getElementById(m?"mobileTagFilterContainer":"tagFilterContainer"),y=document.getElementById(m?"mobileAvailableTagsContainer":"availableTagsContainer");if(!v)return;v.innerHTML="",y&&y.querySelectorAll("[data-tag-name], [data-tag]").forEach(k=>{k.classList.remove("hidden")});const p=document.getElementById(m?"mobileClearTagFilters":"clearTagFilters");if(p&&p.classList.add("hidden"),!m){const _=document.getElementById("mobileTagFilterContainer");_&&(_.innerHTML="");const k=document.getElementById("mobileAvailableTagsContainer");k&&k.querySelectorAll("[data-tag-name], [data-tag]").forEach(L=>{L.classList.remove("hidden")});const b=document.getElementById("mobileClearTagFilters");b&&b.classList.add("hidden")}pt(),vt([])}function pt(){const m=document.getElementById("filterDropdownBtn"),v=document.getElementById("tagFilterContainer");if(!m||!v)return;const y=v.children.length,p=m.querySelector("span");p&&(y===0?p.textContent="Filter by tags":p.textContent=`Filtered by ${y} tag${y>1?"s":""}`)}let cr="",dr=0;const jn=2e3;d.addEventListener("submit",async m=>{m.preventDefault();const v=document.getElementById("linkUrl").value.trim(),y=document.getElementById("linkTags").value.trim(),p=Le(y),_=Date.now(),k=v.toLowerCase();if(k===cr&&_-dr<jn){console.log("Preventing duplicate submission of the same URL");return}cr=k,dr=_;const b=p.map(A=>{const L=`#${Math.floor(Math.random()*16777215).toString(16).padStart(6,"0")}`;return{name:A,color:L}});if(v){const A=d.querySelector('button[type="submit"]'),L=A.textContent;A.innerHTML='<span class="inline-block animate-spin mr-2">↻</span> Saving...',A.disabled=!0;try{const $=await Hr(v,b,!0);if(!$){console.log("Duplicate URL detected, not adding post"),alert("This URL has already been added to your collection."),O();return}console.log("Adding new post to UI without re-rendering all posts");const J=document.getElementById("postsGrid"),F=document.getElementById("postTemplate");if(J&&F){const D=document.importNode(F.content,!0).firstElementChild;D.dataset.id=$.id,D.dataset.platform=$.platform,D.dataset.url=$.url,D.setAttribute("data-id",$.id),J.firstChild?J.insertBefore(D,J.firstChild):J.appendChild(D),qr(D,$),document.dispatchEvent(new CustomEvent("setupTagFilters"))}if(await Qe())try{console.log("Syncing new post with tags to Supabase..."),ur($.id)}catch(D){console.error("Error syncing after adding post:",D)}clearSavedClipboardUrl(),document.getElementById("linkUrl").value="",document.getElementById("linkTags").value="",O()}catch($){console.error("Error adding post:",$),alert(`Error adding post: ${$.message}`)}finally{A.innerHTML=L,A.disabled=!1}}}),j(),document.getElementById("clearTagFilters").addEventListener("click",()=>{mt()}),document.addEventListener("addTagFilter",m=>{m.detail&&m.detail.tag&&ft(m.detail.tag)}),document.addEventListener("click",m=>{var p;const v=m.target.closest(".edit-post");if(v){console.log("Edit button clicked");const _=v.closest(".post-card");_&&_.dataset.id?(console.log("Opening edit modal for post ID:",_.dataset.id),Rn(_.dataset.id)):console.error("Could not find post card or post ID")}const y=m.target.closest(".delete-post-btn");if(y){const _=y.getAttribute("data-post-id")||((p=y.closest(".post-card"))==null?void 0:p.dataset.id);_?(console.log("Delete button clicked for post ID:",_),confirm("Are you sure you want to delete this post? This action cannot be undone.")?(console.log("Deletion confirmed for post ID:",_),mr(_,!1,!1).then(k=>{k?(console.log("Post deleted successfully"),window.boardie&&window.boardie.isAuthenticated&&(console.log("Syncing with Supabase after post deletion..."),_e().catch(b=>{console.error("Error syncing with Supabase after post deletion:",b)}))):console.error("Failed to delete post")}).catch(k=>{console.error("Error deleting post:",k)})):console.log("Post deletion cancelled by user")):console.error("Could not find post ID for deletion")}}),document.addEventListener("postsRendered",()=>{console.log("Posts rendered event received, ensuring edit buttons are working")});function Rn(m){console.log("Opening edit modal for post ID:",m);const v=et(m);if(!v){console.error("Post not found with ID:",m);return}console.log("Post found:",v),document.getElementById("editPostId").value=v.id,document.getElementById("editLinkUrl").value=v.url;const y=v.tags.map(b=>typeof b=="object"&&b!==null&&b.name?b.name:b);document.getElementById("editLinkTags").value=y.join(", ");const p=document.getElementById("editLinkModal");if(!p){console.error("Edit link modal element not found!");return}console.log("Showing edit modal"),p.classList.remove("hidden"),document.body.classList.add("overflow-hidden"),document.getElementById("editLinkUrl").focus();const _=$e([v]),k=document.getElementById("editTagSuggestions");je(_,k,b=>{const A=document.getElementById("editLinkTags"),L=Le(A.value);let $;if(typeof b=="object"&&b!==null&&b.name?($=b.name,console.log("Selected tag object:",b,"Using name:",$)):($=String(b),console.log("Selected tag string:",$)),!L.includes($)){const J=L.length>0?", ":"";A.value+=J+$}})}u.addEventListener("click",()=>{x()}),c.addEventListener("click",m=>{m.target===c&&x()}),h.addEventListener("click",()=>{x()}),f.addEventListener("click",()=>{const m=document.getElementById("editPostId").value;m&&confirm("Are you sure you want to delete this post?")&&(mr(m),x())}),w.addEventListener("submit",m=>{m.preventDefault();const v=document.getElementById("editPostId").value,y=document.getElementById("editLinkUrl").value.trim(),p=document.getElementById("editLinkTags").value.trim(),k=Le(p).map(b=>{const A=`#${Math.floor(Math.random()*16777215).toString(16).padStart(6,"0")}`;return{name:b,color:A}});v&&y&&(console.log("Updating post with tags:",k),Es(v,y,k,!1,!0),x(),ur(v))}),T?T.addEventListener("click",()=>{const m=document.getElementById("userMenu");m&&m.classList.add("hidden"),xs()}):console.log("Export button not found in DOM"),S?S.addEventListener("change",m=>{if(m.target.files.length>0){const v=m.target.files[0];Ls(v).then(y=>{alert(`Import successful! Added ${y.newPostsAdded} new posts. Skipped ${y.duplicatesSkipped} duplicates.`),window.location.reload()}).catch(y=>{alert("Import failed: "+y.message)}).finally(()=>{m.target.value=""})}}):console.log("Import file input not found in DOM");function ur(m){Qe().then(async v=>{if(v){if(console.log("User is logged in, syncing post with Supabase..."),qt()){console.log("Sync already in progress, will sync this post when current sync completes");return}try{if(m){const p=et(m);p?(console.log("Syncing specific post to cloud:",m),await oa(p),console.log("Post sync completed")):(console.log("Post not found, falling back to full sync"),await _e(!0))}else console.log("No specific post ID, performing full sync"),await _e(!0);const y=zt();y&&console.log("Last sync time:",y.toLocaleString())}catch(y){console.error("Error syncing with Supabase:",y)}}else console.log("User not logged in, skipping sync")})}I?I.addEventListener("click",async()=>{const m=document.getElementById("userMenu");if(m&&m.classList.add("hidden"),!await Qe()){alert("You need to log in to sync your data with the cloud.");return}if(qt()){alert("Sync is already in progress. Please wait.");return}const y=I.textContent;I.innerHTML='<span class="inline-block animate-spin mr-2">↻</span> Syncing...',I.disabled=!0;try{await _e(!1),alert("Data sync completed successfully!");const p=zt();if(p){const _=document.getElementById("syncStatus");_&&(_.textContent=`Last synced: ${p.toLocaleString()}`)}}catch(p){console.error("Sync error:",p),alert(`Sync failed: ${p.message}`)}finally{I.innerHTML=y,I.disabled=!1}}):console.log("Sync data button not found in DOM"),N&&N.addEventListener("click",()=>{i.classList.remove("hidden"),document.body.classList.add("overflow-hidden"),document.getElementById("linkUrl").focus();const m=$e(),v=document.getElementById("tagSuggestions");je(m,v,y=>{const p=document.getElementById("linkTags"),_=Le(p.value);let k;if(typeof y=="object"&&y!==null&&y.name?(k=y.name,console.log("Selected tag object in empty state:",y,"Using name:",k)):(k=String(y),console.log("Selected tag string in empty state:",k)),!_.includes(k)){const b=_.length>0?", ":"";p.value+=b+k}})})}let fe=null,X=!1,ie=null,Xe=[],Ge=null;async function ha(){try{X=!0,B(),fe=await Qe(),Ge&&(console.log("Cleaning up previous auth listener"),Ge(),Ge=null),Ge=Yi((r,e)=>{var t;switch(console.log("Auth state change event:",r),fe=(e==null?void 0:e.user)||null,r){case"SIGNED_IN":console.log("User signed in:",(t=e==null?void 0:e.user)==null?void 0:t.email);break;case"SIGNED_OUT":console.log("User signed out");break;case"USER_UPDATED":console.log("User updated");break;case"PASSWORD_RECOVERY":console.log("Password recovery requested");break;default:break}return B(),!1})}catch(r){console.error("Error initializing auth:",r),ie=r.message}finally{X=!1,B()}}async function ga(r,e){try{X=!0,ie=null,B();const{user:t,session:n}=await Gi(r,e);return fe=t,B(),{user:t,session:n}}catch(t){throw console.error("Error signing in:",t),ie=t.message,B(),t}finally{X=!1,B()}}async function fa(r,e){try{X=!0,ie=null,B();const{user:t,session:n}=await Vi(r,e);return t&&(fe=t),B(),{user:t,session:n}}catch(t){throw console.error("Error signing up:",t),ie=t.message,B(),t}finally{X=!1,B()}}async function ma(){try{X=!0,ie=null,B(),await Ki(),fe=null,B()}catch(r){throw console.error("Error signing out:",r),ie=r.message,B(),r}finally{X=!1,B()}}function gt(){return{user:fe,loading:X,error:ie,isAuthenticated:!!fe}}function Cn(r){if(typeof r!="function")throw new Error("Auth listener must be a function");return Xe.push(r),r(gt()),()=>{Xe=Xe.filter(e=>e!==r)}}function B(){const r=gt();[...Xe].forEach(t=>{try{const n=t(r);n&&typeof n.then=="function"&&console.warn("Auth listener returned a Promise. This may cause issues with Supabase auth state change handling.")}catch(n){console.error("Error in auth listener:",n)}})}function pa(){const r=document.createElement("div");r.className="auth-form-container bg-white p-6 rounded-lg shadow-md max-w-md mx-auto";const e=document.createElement("form");e.className="space-y-4",e.id="loginForm";const t=document.createElement("h2");t.className="text-2xl font-bold text-center text-gray-800 mb-6",t.textContent="Log in to Boardie";const n=document.createElement("div"),s=document.createElement("label");s.htmlFor="email",s.className="block text-sm font-medium text-gray-700 mb-1",s.textContent="Email";const o=document.createElement("input");o.type="email",o.id="email",o.name="email",o.required=!0,o.className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",o.placeholder="you@example.com",n.appendChild(s),n.appendChild(o);const i=document.createElement("div"),a=document.createElement("label");a.htmlFor="password",a.className="block text-sm font-medium text-gray-700 mb-1",a.textContent="Password";const l=document.createElement("input");l.type="password",l.id="password",l.name="password",l.required=!0,l.className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",l.placeholder="••••••••",i.appendChild(a),i.appendChild(l);const d=document.createElement("button");d.type="submit",d.className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200",d.textContent="Sign in";const c=document.createElement("div");c.className="text-red-600 text-sm hidden",c.id="loginError";const u=document.createElement("div");return u.className="text-center mt-4 text-sm",u.innerHTML=`Don't have an account? <a href="#" id="showRegisterForm" class="text-blue-600 hover:text-blue-800">Sign up</a>`,e.appendChild(t),e.appendChild(n),e.appendChild(i),e.appendChild(c),e.appendChild(d),e.appendChild(u),r.appendChild(e),e.addEventListener("submit",async h=>{h.preventDefault();const f=o.value,w=l.value;c.textContent="",c.classList.add("hidden"),d.disabled=!0,d.innerHTML='<span class="inline-block animate-spin mr-2">↻</span> Signing in...';try{const T=await ga(f,w);console.log("Login successful");const S=document.getElementById("authModal");S&&document.body.removeChild(S),console.log("Login successful, auth state change listener will handle data loading"),window.boardie.postsRendered=!1}catch(T){c.textContent=T.message||"Failed to sign in. Please check your credentials.",c.classList.remove("hidden"),d.disabled=!1,d.textContent="Sign in"}}),r}function Or(){const r=document.createElement("div");r.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",r.id="authModal";const e=document.createElement("div");e.className="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4";const t=document.createElement("button");t.className="absolute top-4 right-4 text-gray-400 hover:text-gray-600",t.innerHTML=`
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  `,t.addEventListener("click",()=>{document.body.removeChild(r)});const n=pa();e.appendChild(t),e.appendChild(n),r.appendChild(e),document.body.appendChild(r),setTimeout(()=>{document.getElementById("email").focus()},100)}function wa(){const r=document.createElement("div");r.className="auth-form-container bg-white p-6 rounded-lg shadow-md max-w-md mx-auto";const e=document.createElement("form");e.className="space-y-4",e.id="registerForm";const t=document.createElement("h2");t.className="text-2xl font-bold text-center text-gray-800 mb-6",t.textContent="Create your account";const n=document.createElement("div"),s=document.createElement("label");s.htmlFor="registerEmail",s.className="block text-sm font-medium text-gray-700 mb-1",s.textContent="Email";const o=document.createElement("input");o.type="email",o.id="registerEmail",o.name="email",o.required=!0,o.className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",o.placeholder="you@example.com",n.appendChild(s),n.appendChild(o);const i=document.createElement("div"),a=document.createElement("label");a.htmlFor="registerPassword",a.className="block text-sm font-medium text-gray-700 mb-1",a.textContent="Password";const l=document.createElement("input");l.type="password",l.id="registerPassword",l.name="password",l.required=!0,l.minLength=8,l.className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",l.placeholder="Minimum 8 characters",i.appendChild(a),i.appendChild(l);const d=document.createElement("div"),c=document.createElement("label");c.htmlFor="confirmPassword",c.className="block text-sm font-medium text-gray-700 mb-1",c.textContent="Confirm Password";const u=document.createElement("input");u.type="password",u.id="confirmPassword",u.name="confirmPassword",u.required=!0,u.className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",u.placeholder="Confirm your password",d.appendChild(c),d.appendChild(u);const h=document.createElement("button");h.type="submit",h.className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200",h.textContent="Create Account";const f=document.createElement("div");f.className="text-red-600 text-sm hidden",f.id="registerError";const w=document.createElement("div");w.className="text-center mt-4 text-sm",w.innerHTML='Already have an account? <a href="#" id="showLoginForm" class="text-blue-600 hover:text-blue-800">Sign in</a>';const T=document.createElement("p");return T.className="text-xs text-gray-500 mt-4 text-center",T.innerHTML='By creating an account, you agree to our <a href="#" class="text-blue-600 hover:underline">Terms of Service</a> and <a href="#" class="text-blue-600 hover:underline">Privacy Policy</a>.',e.appendChild(t),e.appendChild(n),e.appendChild(i),e.appendChild(d),e.appendChild(f),e.appendChild(h),e.appendChild(w),e.appendChild(T),r.appendChild(e),e.addEventListener("submit",async S=>{S.preventDefault();const I=o.value,N=l.value,O=u.value;if(f.textContent="",f.classList.add("hidden"),N!==O){f.textContent="Passwords do not match.",f.classList.remove("hidden");return}h.disabled=!0,h.innerHTML='<span class="inline-block animate-spin mr-2">↻</span> Creating account...';try{await fa(I,N);const x=document.createElement("div");x.className="fixed bottom-4 right-4 px-6 py-3 rounded-md shadow-md z-50 bg-green-500 text-white",x.textContent="Account created successfully!",document.body.appendChild(x);const j=document.getElementById("authModal");j&&document.body.removeChild(j),setTimeout(()=>{x.parentNode&&document.body.removeChild(x)},3e3)}catch(x){f.textContent=x.message||"Failed to create account. Please try again.",f.classList.remove("hidden"),h.disabled=!1,h.textContent="Create Account"}}),r}function jr(){const r=document.createElement("div");r.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",r.id="authModal";const e=document.createElement("div");e.className="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4";const t=document.createElement("button");t.className="absolute top-4 right-4 text-gray-400 hover:text-gray-600",t.innerHTML=`
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  `,t.addEventListener("click",()=>{document.body.removeChild(r)});const n=wa();e.appendChild(t),e.appendChild(n),r.appendChild(e),document.body.appendChild(r),setTimeout(()=>{document.getElementById("registerEmail").focus()},100)}let st=null;function ya(){try{st=gt().user,Ht(),Cn(e=>{st=e.user,Ht()}),ba()}catch(r){console.error("Error initializing auth UI:",r)}}function ba(){document.addEventListener("click",r=>{if((r.target.id==="loginButton"||r.target.closest("#loginButton"))&&Or(),(r.target.id==="registerButton"||r.target.closest("#registerButton"))&&jr(),(r.target.id==="logoutButton"||r.target.closest("#logoutButton"))&&va(),r.target.id==="userMenuButton"||r.target.closest("#userMenuButton")){const e=document.getElementById("userMenu");e&&e.classList.toggle("hidden")}if(!r.target.closest("#userMenuButton")&&!r.target.closest("#userMenu")){const e=document.getElementById("userMenu");e&&!e.classList.contains("hidden")&&e.classList.add("hidden")}if(r.target.id==="showLoginForm"){r.preventDefault();const e=document.getElementById("authModal");e&&document.body.removeChild(e),Or()}if(r.target.id==="showRegisterForm"){r.preventDefault();const e=document.getElementById("authModal");e&&document.body.removeChild(e),jr()}})}async function va(){try{await ma(),Rr("You have been logged out successfully")}catch(r){console.error("Error logging out:",r),Rr("Failed to log out. Please try again.","error")}}function Ht(){const r=document.getElementById("authButtons");if(!r){_a();return}st?r.innerHTML=Ea(st):r.innerHTML=ka()}function _a(){const r=document.querySelector("header");if(r){const e=document.createElement("div");e.id="authButtons",e.className="ml-auto flex items-center",r.appendChild(e),Ht()}}function Ea(r){return`
    <div class="flex items-center">
      <span class="text-sm text-gray-700 mr-3 hidden sm:inline">
        ${r.email||"User"}
      </span>
      <div class="relative">
        <button
          id="userMenuButton"
          class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition-colors"
          aria-expanded="false"
        >
          <span class="sr-only">User menu</span>
          <span class="text-sm font-medium">${Sa(r)}</span>
        </button>
        <div
          id="userMenu"
          class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10 hidden"
        >
          <a
            href="#profile"
            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
          >
            Your Profile
          </a>
          <a
            href="#settings"
            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
          >
            Settings
          </a>
          <hr class="my-1 border-gray-200">
          <button
            id="logoutButton"
            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
          >
            Sign out
          </button>
        </div>
      </div>
    </div>
  `}function ka(){return`
    <div class="flex items-center space-x-2">
      <button
        id="loginButton"
        class="px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-800"
      >
        Log in
      </button>
      <button
        id="registerButton"
        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
      >
        Sign up
      </button>
    </div>
  `}function Sa(r){if(!r)return"?";if(r.user_metadata&&r.user_metadata.full_name){const e=r.user_metadata.full_name.split(" ");return e.length>=2?`${e[0][0]}${e[e.length-1][0]}`.toUpperCase():e[0][0].toUpperCase()}return r.email?r.email[0].toUpperCase():"?"}function Rr(r,e="success"){const t=document.createElement("div");t.className=`fixed bottom-4 right-4 px-6 py-3 rounded-md shadow-md z-50 ${e==="error"?"bg-red-500 text-white":"bg-green-500 text-white"}`,t.textContent=r,document.body.appendChild(t),setTimeout(()=>{t.classList.add("opacity-0","transition-opacity","duration-500"),setTimeout(()=>{t.parentNode&&document.body.removeChild(t)},500)},3e3)}async function Ur(){try{console.log("Initializing database...");const{error:r}=await g.from("profiles").select("id").limit(1),{error:e}=await g.from("posts").select("id").limit(1),{error:t}=await g.from("tags").select("id").limit(1),{error:n}=await g.from("post_tags").select("post_id").limit(1);return r&&console.warn("Profiles table check:",r.message),e&&console.warn("Posts table check:",e.message),t&&console.warn("Tags table check:",t.message),n&&console.warn("Post_tags table check:",n.message),{profilesExists:!r,postsExists:!e,tagsExists:!t,postTagsExists:!n}}catch(r){throw console.error("Error initializing database:",r),r}}async function nr(){try{const{data:{user:r}}=await g.auth.getUser();if(!r)throw new Error("No user logged in");const{data:e,error:t}=await g.from("posts").select(`
        *,
        tags:post_tags(
          tag:tags(*)
        )
      `).eq("user_id",r.id).order("created_at",{ascending:!1});if(t)throw t;return e.map(n=>({...n,tags:n.tags.map(s=>s.tag)}))}catch(r){throw console.error("Error getting posts:",r),r}}async function sr(r){try{const{data:{user:e}}=await g.auth.getUser();if(!e)throw new Error("No user logged in");if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(r)){console.log("Post ID is not in UUID format:",r);const{data:o,error:i}=await g.from("posts").select(`
          *,
          tags:post_tags(
            tag:tags(*)
          )
        `).eq("user_id",e.id);if(i)throw i;const a=o.find(l=>l.local_id===r||l.client_id===r);return a?(console.log("Found post by local_id or client_id:",a.id),{...a,tags:a.tags.map(l=>l.tag)}):(console.log("No post found with local_id or client_id:",r),null)}const{data:n,error:s}=await g.from("posts").select(`
        *,
        tags:post_tags(
          tag:tags(*)
        )
      `).eq("id",r).eq("user_id",e.id).single();if(s){if(s.code==="PGRST116")return console.log("Post not found with ID:",r),null;throw s}return{...n,tags:n.tags.map(o=>o.tag)}}catch(e){return console.error("Error getting post by ID:",e),null}}async function Pn(r){try{const{data:{user:e}}=await g.auth.getUser();if(!e)throw new Error("No user logged in");console.log("Creating post with data:",r),console.log("Tags received:",JSON.stringify(r.tags));let t=[];if(r.tags&&Array.isArray(r.tags)&&r.tags.length>0){console.log("Processing tags BEFORE creating post:",r.tags.length,"tags",JSON.stringify(r.tags));try{const a=JSON.parse(JSON.stringify(r.tags)).map(l=>typeof l=="object"&&l!==null&&l.name?{name:l.name,color:l.color||"#cccccc"}:typeof l=="string"?{name:l,color:"#cccccc"}:null).filter(l=>l!==null);console.log("Tag objects to create:",a.length,JSON.stringify(a)),a.length>0&&(t=await ir(a),console.log("Created tags with IDs:",t))}catch(i){console.error("Error processing tags before post creation:",i)}}const{data:n,error:s}=await g.from("posts").insert([{user_id:e.id,url:r.url,platform:r.platform,title:r.title||null,description:r.description||null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select();if(s)throw console.error("Error creating post:",s),s;if(!n||n.length===0)throw console.error("No post data returned after creation"),new Error("Failed to create post");const o=n[0];if(console.log("Post created successfully:",o.id),t.length>0){console.log("Associating tags with new post:",t);try{const i=t.map(d=>({post_id:o.id,tag_id:d}));console.log("Creating post_tags entries directly:",JSON.stringify(i));const{data:a,error:l}=await g.from("post_tags").upsert(i,{onConflict:"post_id,tag_id"}).select();l?console.error("Error creating post_tags:",l):console.log("Successfully created post_tags directly:",JSON.stringify(a))}catch(i){console.error("Error associating tags with post:",i)}}else console.log("No tags to associate with post");return o}catch(e){throw console.error("Error creating post:",e),e}}async function Ta(r){try{const{data:{user:e}}=await g.auth.getUser();if(!e)throw new Error("No user logged in");if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(r)){console.log("Post ID is not in UUID format for getPostTags:",r);const o=await sr(r);if(!o)return console.log("Could not find post with ID:",r),[];r=o.id,console.log("Using Supabase UUID instead:",r)}const{data:n,error:s}=await g.from("post_tags").select("*, tag:tags(*)").eq("post_id",r);if(s)throw s;return n||[]}catch(e){return console.error("Error getting post tags:",e),[]}}async function Nr(){try{const{data:{user:r}}=await g.auth.getUser();if(!r)throw new Error("No user logged in");const{data:e,error:t}=await g.from("posts").select("id").eq("user_id",r.id);if(t)throw t;if(!e||e.length===0)return[];const n=e.map(i=>i.id),{data:s,error:o}=await g.from("post_tags").select("*, tag:tags(*)").in("post_id",n);if(o)throw o;return s||[]}catch(r){return console.error("Error getting all post tags:",r),[]}}async function xn(r,e){try{const{data:{user:t}}=await g.auth.getUser();if(!t)throw new Error("No user logged in");if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(r)){console.log("Post ID is not in UUID format for addTagsToPost:",r);const c=await sr(r);if(!c)return console.log("Could not find post with ID:",r),!1;r=c.id,console.log("Using Supabase UUID instead:",r)}const{data:s,error:o}=await g.from("posts").select("id").eq("id",r).eq("user_id",t.id).single();if(o||!s)return console.error("Error verifying post ownership:",o),!1;const{data:i,error:a}=await g.from("post_tags").select("*").limit(1);console.log("Checking post_tags table structure");const l=e.map(c=>{const u={post_id:r,tag_id:c};return i&&i.length>0&&"user_id"in i[0]&&(u.user_id=t.id),u});console.log("Adding post tags:",JSON.stringify(l));const{error:d}=await g.from("post_tags").upsert(l,{onConflict:"post_id,tag_id",returning:"minimal"});return d?(console.error("Error adding tags to post:",d),!1):!0}catch(t){return console.error("Error adding tags to post:",t),!1}}async function Ca(r,e){try{const{data:{user:t}}=await g.auth.getUser();if(!t)throw new Error("No user logged in");if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(r)){console.log("Post ID is not in UUID format for removeTagsFromPost:",r);const a=await sr(r);if(!a)return console.log("Could not find post with ID:",r),!1;r=a.id,console.log("Using Supabase UUID instead:",r)}const{data:s,error:o}=await g.from("posts").select("id").eq("id",r).eq("user_id",t.id).single();if(o||!s)return console.error("Error verifying post ownership for tag removal:",o),!1;const{error:i}=await g.from("post_tags").delete().eq("post_id",r).in("tag_id",e);return i?(console.error("Error removing tags from post:",i),!1):(console.log("Successfully removed tags from post:",e.length,"tags"),!0)}catch(t){return console.error("Error removing tags from post:",t),!1}}async function Pa(r,e){try{const{data:{user:t}}=await g.auth.getUser();if(!t)throw new Error("No user logged in");const n={};e.url!==void 0&&(n.url=e.url),e.platform!==void 0&&(n.platform=e.platform),e.title!==void 0&&(n.title=e.title),e.description!==void 0&&(n.description=e.description),n.updated_at=new Date().toISOString();const{data:s,error:o}=await g.from("posts").update(n).eq("id",r).eq("user_id",t.id).select();if(o)throw o;if(e.tags)if(console.log("Updating tags for post:",r,"Tags count:",e.tags.length),Array.isArray(e.tags)&&e.tags.length>0)try{const i=[],a=[];e.tags.forEach(c=>{typeof c=="string"?a.push(c):typeof c=="object"&&(c.id?a.push(c.id):c.name&&i.push(c))}),console.log("Tag objects to create:",i.length),console.log("Existing tag IDs:",a.length);let l=[];i.length>0&&(l=await ir(i),console.log("Created new tags with IDs:",l));const d=[...a,...l].filter(c=>c!==null);d.length>0?(console.log("Associating tags with post:",d),await xa(r,d)?console.log("Successfully updated tags for post"):console.warn("Failed to update tags for post")):console.warn("No valid tag IDs to associate with post")}catch(i){console.error("Error updating tags for post:",i)}else try{const{error:i}=await g.from("post_tags").delete().eq("post_id",r);i?console.error("Error removing all tags from post:",i):console.log("Successfully removed all tags from post")}catch(i){console.error("Error removing all tags from post:",i)}return s[0]}catch(t){throw console.error("Error updating post:",t),t}}async function or(){try{const{data:{user:r}}=await g.auth.getUser();if(!r)throw new Error("No user logged in");const{data:e,error:t}=await g.from("tags").select("*").eq("user_id",r.id).order("name");if(t)throw t;return e}catch(r){throw console.error("Error getting tags:",r),r}}async function Ln(r){try{const{data:{user:e}}=await g.auth.getUser();if(!e)throw new Error("No user logged in");const{data:t,error:n}=await g.from("tags").insert([{user_id:e.id,name:r.name,color:r.color||null}]).select();if(n)throw n;return t[0]}catch(e){throw console.error("Error creating tag:",e),e}}async function ir(r){try{const{data:{user:e}}=await g.auth.getUser();if(!e)throw new Error("No user logged in");const t=(r||[]).filter(d=>d&&d.name);if(t.length===0)return console.log("No valid tags to create"),[];console.log("Creating tags:",t.map(d=>d.name).join(", "));const{data:n,error:s}=await g.from("tags").select("id, name").eq("user_id",e.id);if(s)throw console.error("Error fetching existing tags:",s),s;const o={};n&&n.length>0&&n.forEach(d=>{d.name&&(o[d.name.toLowerCase()]=d.id)});const i=t.filter(d=>!o[d.name.toLowerCase()]);let a=[];if(i.length>0){const d=i.map(h=>({user_id:e.id,name:h.name,color:h.color||"#cccccc"}));console.log("Inserting new tags:",d.length);const{data:c,error:u}=await g.from("tags").insert(d).select();if(u)throw console.error("Error creating tags:",u),u;c&&c.length>0&&(a=c.map(h=>h.id),console.log("Created tags with IDs:",a),c.forEach(h=>{h.name&&(o[h.name.toLowerCase()]=h.id)}))}const l=t.map(d=>{const c=o[d.name.toLowerCase()];return c||(console.warn("Could not find ID for tag:",d.name),null)}).filter(d=>d!==null);return console.log("All tag IDs:",l),l}catch(e){throw console.error("Error in createTags:",e),e}}async function xa(r,e){try{const{data:{user:t}}=await g.auth.getUser();if(!t)throw new Error("No user logged in");const n=(e||[]).filter(c=>c&&typeof c=="string");if(!r||n.length===0)return console.log("No valid post ID or tag IDs to associate"),!1;console.log("Associating tags with post:",r,"Tag IDs:",n);const{data:s,error:o}=await g.from("posts").select("id").eq("id",r).eq("user_id",t.id).single();if(o)throw console.error("Error verifying post ownership:",o),o;if(!s)return console.error("Post not found or does not belong to user"),!1;const i=n.map(c=>({post_id:r,tag_id:c})),{error:a}=await g.from("post_tags").delete().eq("post_id",r);if(a)throw console.error("Error removing existing post_tags:",a),a;const{data:l,error:d}=await g.from("post_tags").insert(i);if(d)throw console.error("Error inserting post_tags:",d),d;return console.log("Successfully associated tags with post"),!0}catch(t){throw console.error("Error in associateTagsWithPost:",t),t}}function ar(r){return typeof r=="object"&&r!==null&&r.name?{name:r.name,color:r.color||"#cccccc"}:typeof r=="string"?{name:r,color:"#cccccc"}:null}function In(r){if(!r||!Array.isArray(r))return[];console.log("Processing tags:",JSON.stringify(r)),console.log("Tags types:",r.map(t=>typeof t));const e=[];for(let t=0;t<r.length;t++){const n=r[t];console.log(`Processing tag ${t}:`,n,"Type:",typeof n);const s=ar(n);s&&e.push(s)}return console.log("Normalized tag objects:",e.length,JSON.stringify(e)),e}async function La(r){if(!r||r.length===0)return[];try{console.log("Creating tags in Supabase:",JSON.stringify(r));const e=await ir(r);return console.log("Created tags with IDs:",e),e}catch(e){return console.error("Error creating tags in Supabase:",e),[]}}async function Ia(r){try{console.log("Syncing tags to cloud, local tags count:",r.length);const e=await or();console.log("Cloud tags count:",e.length);const t={};e.forEach(s=>{s&&s.name&&(t[s.name.toLowerCase()]=s)});const n=[];if(r.forEach(s=>{if(s&&s.name){const o=ar(s);o&&!t[o.name.toLowerCase()]&&n.push(o)}}),n.length>0){console.log("Creating missing tags in cloud:",n.length);const s=await Promise.all(n.map(async o=>{try{const i=await Ln(o);return i&&i.id?(t[o.name.toLowerCase()]=i,i):null}catch(i){return console.error("Error creating tag:",i),null}}));console.log("Created tags count:",s.filter(o=>o!==null).length)}else console.log("No new tags to create in cloud");return console.log("Tags sync to cloud completed"),t}catch(e){throw console.error("Error syncing tags to cloud:",e),e}}async function An(r,e,t){try{if(console.log("syncPostTags called for post ID:",r),!e||!Array.isArray(e)||e.length===0){console.log("No local tags to sync for post:",r);return}console.log("Local tags count:",e.length);const n=In(e);if(n.length===0){console.log("No valid local tags to sync for post:",r);return}const s=await Ta(r);console.log("Existing post tags count:",s.length);const o=new Set(n.map(d=>d.name.toLowerCase())),i=new Set(s.map(d=>d.tag&&d.tag.name?d.tag.name.toLowerCase():null).filter(d=>d!==null));console.log("Local tag names:",Array.from(o)),console.log("Cloud tag names:",Array.from(i));const a=n.filter(d=>!i.has(d.name.toLowerCase())),l=s.filter(d=>d.tag&&d.tag.name&&!o.has(d.tag.name.toLowerCase()));if(console.log("Tags to add count:",a.length),console.log("Tags to remove count:",l.length),a.length>0){console.log("Processing tags to add:",JSON.stringify(a));const d=[];for(const u of a)if(t[u.name.toLowerCase()])console.log("Tag already exists in cloud:",u.name),d.push(t[u.name.toLowerCase()]);else try{console.log("Creating new tag in Supabase:",u.name);const h=await Ln(u);h&&h.id&&(console.log("Successfully created tag with ID:",h.id),t[u.name.toLowerCase()]=h,d.push(h))}catch(h){console.error("Error creating tag:",h)}const c=d.map(u=>u.id).filter(u=>u!==null);if(c.length>0){console.log("Adding tag IDs to post:",c);try{await xn(r,c)?console.log("Successfully added tags to post"):console.error("Failed to add tags to post")}catch(u){console.error("Error adding tags to post:",u)}}}if(l.length>0){const d=l.map(c=>c.tag_id).filter(c=>c!==null);d.length>0&&(console.log("Removing tag IDs from post:",d),await Ca(r,d))}console.log("Post tags sync completed for post ID:",r)}catch(n){console.error("Error syncing post tags:",n)}}let Aa=null;async function Dr(){try{console.log("Initializing smart sync with cloud priority...");const{data:{user:r}}=await g.auth.getUser();if(!r){console.log("No user logged in, cannot perform smart sync");return}console.log("Fetching cloud data...");const e=await nr();if(console.log(`Cloud posts: ${e.length}`),e.length>0)console.log("Using cloud data as source of truth"),console.log("Saving cloud data to localStorage"),Z(e),window.boardie.cloudPosts=e,window.boardie.cloudDataReady=!0,console.log("Cloud data ready for rendering by main.js"),document.dispatchEvent(new CustomEvent("cloudDataReady",{detail:{posts:e}}));else{console.log("No cloud data found, checking local data");const t=U(!0);t.length>0?(console.log("Local data found, syncing to cloud..."),await $a(),window.boardie.localPosts=t,window.boardie.localDataReady=!0,console.log("Local data ready for rendering by main.js"),document.dispatchEvent(new CustomEvent("localDataReady",{detail:{posts:t}}))):(console.log("No data found, showing empty state"),window.boardie.showEmptyState())}Aa=new Date}catch(r){console.error("Error in smart sync:",r),console.log("Sync failed, rendering local posts"),window.boardie.renderPosts(localPosts),window.boardie.postsRendered=!0}}async function $a(){try{console.log("Syncing local data to cloud...");const r=await U(!1),e=[];r.forEach(o=>{o.tags&&Array.isArray(o.tags)&&o.tags.forEach(i=>{const a=ar(i);a&&!e.some(l=>l.name.toLowerCase()===a.name.toLowerCase())&&e.push(a)})});const t=await Vt(),n=[...t];e.forEach(o=>{n.some(i=>i.name.toLowerCase()===o.name.toLowerCase())||n.push(o)}),console.log("Local posts count:",r.length),console.log("Combined tags count:",n.length),console.log("Tags from posts:",e.length),console.log("Tags from storage:",t.length);const s=await Ia(n);await Oa(r,s);try{console.log("Verifying post-tag associations...");const o=await Nr();if(console.log("Total post_tags associations after sync:",o.length),o.length===0){console.log("No post-tag associations found, attempting to fix...");const i=await nr(),a=await or(),l={};a.forEach(c=>{c&&c.name&&(l[c.name.toLowerCase()]=c)});for(const c of r)if(c.tags&&Array.isArray(c.tags)&&c.tags.length>0){const u=i.find(h=>h.url===c.url);u&&(console.log(`Fixing tags for post: ${u.id} (${c.url})`),await An(u.id,c.tags,l))}const d=await Nr();console.log("Post-tag associations after fix:",d.length)}}catch(o){console.error("Error verifying post-tag associations:",o)}console.log("Local to cloud sync completed")}catch(r){throw console.error("Error syncing local to cloud:",r),r}}async function Oa(r,e){try{console.log("Syncing posts to cloud, local posts count:",r.length);const t=await nr();console.log("Cloud posts count:",t.length);const n=await or();console.log("Cloud tags count:",n.length);const s={};t.forEach(o=>{o&&o.url&&(s[o.url]=o)});for(const o of r)if(console.log("Processing post:",o.url),s[o.url]){const i=s[o.url];console.log("Post exists in cloud with ID:",i.id),((o.title||null)!==(i.title||null)||(o.description||null)!==(i.description||null)||(o.platform||"")!==(i.platform||""))&&(console.log("Post needs update, updating properties"),await Pa(i.id,{title:o.title,description:o.description,platform:o.platform})),o.tags&&Array.isArray(o.tags)&&o.tags.length>0?(console.log("Post has tags, syncing tags for post"),await An(i.id,o.tags,e)):console.log("Post has no tags, skipping tag sync")}else if(console.log("Post does not exist in cloud, creating new post"),o.tags&&Array.isArray(o.tags)&&o.tags.length>0){console.log("New post has tags:",o.tags.length,JSON.stringify(o.tags));const i=In(o.tags);if(i.length>0){console.log("Processed tag objects for new post:",JSON.stringify(i));const a=await La(i);if(console.log("Created tags with IDs for post:",a),o&&o.url){console.log("Creating post in Supabase with tags:",o.url);try{const l={url:o.url,platform:o.platform||"",title:o.title||null,description:o.description||null,tags:i};console.log("Full post object being sent to createPost:",JSON.stringify(l));const d=await Pn(l);console.log("Successfully created post with ID:",d.id),a&&a.length>0&&(console.log("Ensuring tags are associated with post:",a),await xn(d.id,a))}catch(l){console.error("Error creating post with tags:",l)}}}else Br(o)}else console.log("New post has no tags"),Br(o);console.log("Posts sync to cloud completed")}catch(t){throw console.error("Error syncing posts to cloud:",t),t}}async function Br(r){if(r&&r.url){console.log("Creating post in Supabase without tags:",r.url);try{const e={url:r.url,platform:r.platform||"",title:r.title||null,description:r.description||null,tags:[]};console.log("Post object without tags:",JSON.stringify(e));const t=await Pn(e);console.log("Successfully created post without tags, ID:",t.id)}catch(e){console.error("Error creating post without tags:",e)}}else console.warn("Skipping post with missing URL:",r)}let xt=!1,Ke=null,Ye=null;async function ja(){if(xt){console.log("Auth module already initialized, skipping");return}try{console.log("Initializing auth module..."),await ha(),ya();const{user:r,isAuthenticated:e}=gt();window.boardie=window.boardie||{},window.boardie.isAuthenticated=e,window.boardie.currentUser=r,r?(console.log("User is logged in, initializing database and sync"),await Ur(),window.boardie.clearUI&&window.boardie.clearUI(),await Dr([])):(console.log("No user logged in, showing empty state"),window.boardie.showEmptyState&&window.boardie.showEmptyState()),Ke&&(console.log("Cleaning up previous auth subscription"),Ke(),Ke=null),Ke=Cn(t=>{var a,l,d;console.log("Auth state changed:",t.isAuthenticated?"authenticated":"unauthenticated");const n=Date.now(),s=((a=window.boardie)==null?void 0:a.lastVisibilityChangeTime)||0,o=n-s;if(Ye&&t.isAuthenticated===Ye.isAuthenticated&&((l=t.user)==null?void 0:l.id)===((d=Ye.user)==null?void 0:d.id)&&o<2e3){console.log("Ignoring duplicate auth state change after tab switch");return}window.boardie.isAuthenticated=t.isAuthenticated,window.boardie.currentUser=t.user,Ye={isAuthenticated:t.isAuthenticated,user:t.user?{id:t.user.id,email:t.user.email}:null},t.isAuthenticated&&t.user?(console.log("User signed in:",t.user.email),setTimeout(async()=>{var c;try{if(document.hidden&&window.boardie.postsRendered){console.log("Page is hidden and posts already rendered, skipping data load");return}const u=((c=window.boardie)==null?void 0:c.lastVisibilityChangeTime)||0,h=Date.now()-u;if(window.boardie.postsRendered&&h<2e3||window.boardie.justReturned){console.log("Posts already rendered and recent visibility change, skipping data load");return}await Ur(),window.boardie.clearUI&&(console.log("Clearing UI before loading cloud data"),window.boardie.clearUI()),console.log("Fetching cloud data for user"),await Dr([])}catch(u){console.error("Error handling auth state change:",u)}},0)):t.isAuthenticated||(console.log("User signed out, clearing data"),setTimeout(()=>{try{window.boardie.clearLocalStorage&&window.boardie.clearLocalStorage(),document.hidden?console.log("Page is hidden, skipping UI updates on sign out"):(window.boardie.clearUI&&window.boardie.clearUI(),window.boardie.showEmptyState&&window.boardie.showEmptyState())}catch(c){console.error("Error handling sign out:",c)}},0))}),xt=!0,console.log("Auth module initialized")}catch(r){console.error("Error initializing auth module:",r)}return xt}function Ra(){if(window.twttr){console.log("Twitter widgets already loaded");return}window.twttr=function(r,e,t){var n,s=r.getElementsByTagName(e)[0],o=window.twttr||{};return r.getElementById(t)||(n=r.createElement(e),n.id=t,n.src="https://platform.twitter.com/widgets.js",s.parentNode.insertBefore(n,s),o._e=[],o.ready=function(i){o._e.push(i)}),o}(document,"script","twitter-wjs"),window.twttr.ready(function(){console.log("Twitter widgets loaded and ready")})}let Lt=!1;document.addEventListener("visibilitychange",()=>{window.boardie=window.boardie||{},window.boardie.lastVisibilityChangeTime=Date.now(),document.hidden?(console.log("Page visibility: hidden"),Lt=!0):(console.log("Page visibility: visible"),Lt&&(console.log("Page visibility: visible after being hidden"),setTimeout(()=>{Gr(rr).then(r=>{r&&console.log("Found URL in clipboard when app became visible")}).catch(r=>{console.error("Error checking clipboard:",r)})},500),console.log("Returned to page, preventing automatic re-render"),window.boardie.justReturned=!0,setTimeout(()=>{window.boardie.justReturned=!1},2e3)),Lt=!1)});document.addEventListener("DOMContentLoaded",async()=>{if(console.log("DOM content loaded, initializing application"),window.boardie=window.boardie||{},window.boardie.showEmptyState=()=>{Ee()},window.boardie.safeRenderPosts=s=>{try{G(s)}catch(o){console.error("Error rendering posts:",o),Ee()}},/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream){console.log("iOS device detected, showing iOS sharing guide link");const s=document.getElementById("iosShareGuide");s&&s.classList.remove("hidden")}const e=new URLSearchParams(window.location.search),t=e.get("shared_url"),n=e.get("action");if(t){console.log("Found shared URL in parameters:",t);const s=window.location.pathname+window.location.hash;window.history.replaceState({},document.title,s),$n({url:t,title:e.get("shared_title")||"",text:e.get("shared_text")||""})}else if(n==="addLink"){console.log("Add Link shortcut triggered");const s=window.location.pathname+window.location.hash;window.history.replaceState({},document.title,s),setTimeout(()=>{const o=document.getElementById("addLinkBtn");o&&(console.log("Triggering Add Link button click"),o.click())},1e3)}Ra(),window.boardie.postsRendered=!1,window.boardie.isAuthenticated=!1,window.boardie.isRendering=!1,window.boardie.lastRenderTime=0,ua(),setTimeout(()=>{Gr(rr).then(s=>{s&&console.log("Found URL in clipboard on app initialization")}).catch(s=>{console.error("Error checking clipboard on initialization:",s)})},1e3),window.boardie.localDataReady=!1,window.boardie.renderPosts=G,window.boardie.safeRenderPosts=function(s){if(window.boardie.isRendering){console.log("Already rendering posts, skipping this render call");return}window.boardie.isRendering=!0,console.log("Safe rendering posts"),window.boardie.renderPosts(s),window.boardie.postsRendered=!0,setTimeout(()=>{window.boardie.isRendering=!1,console.log("Rendering complete, reset rendering flag")},500)},window.boardie.clearUI=function(){const s=document.getElementById("postsContainer");s&&(s.innerHTML="");const o=document.getElementById("tagFilterContainer");o&&(o.innerHTML=""),console.log("UI cleared")},window.boardie.showEmptyState=Ee,window.boardie.loadPosts=U,window.boardie.clearLocalStorage=_s,window.boardie.syncData=_e,window.boardie.isSyncing=qt,window.boardie.getLastSyncTime=zt,window.boardie.renderManager=da,document.addEventListener("cloudDataReady",s=>{if(console.log("Received cloudDataReady event"),document.hidden&&window.boardie.postsRendered){console.log("Page is hidden and posts already rendered, skipping render");return}if(window.boardie.justReturned&&window.boardie.postsRendered){console.log("Just returned from tab switch and posts already rendered, skipping render");return}s.detail&&s.detail.posts&&(window.boardie.safeRenderPosts(s.detail.posts),setTimeout(()=>{document.dispatchEvent(new CustomEvent("setupTagFilters"))},300))}),document.addEventListener("localDataReady",s=>{if(console.log("Received localDataReady event"),document.hidden&&window.boardie.postsRendered){console.log("Page is hidden and posts already rendered, skipping render");return}if(window.boardie.justReturned&&window.boardie.postsRendered){console.log("Just returned from tab switch and posts already rendered, skipping render");return}s.detail&&s.detail.posts&&(window.boardie.cloudDataReady?console.log("Cloud data already rendered, skipping local data render"):(window.boardie.safeRenderPosts(s.detail.posts),setTimeout(()=>{document.dispatchEvent(new CustomEvent("setupTagFilters"))},300)))});try{if(await ja(),console.log("Authentication initialized"),!window.boardie.isAuthenticated)console.log("Not authenticated, showing empty state"),window.boardie.showEmptyState();else{if(console.log("User is authenticated, checking if migration is needed"),await la()){console.log("Migration from old sync system needed");try{await aa()?console.log("Migration completed successfully, initializing smart sync"):console.warn("Migration failed, continuing with new sync system anyway")}catch(o){console.error("Error during migration:",o)}}try{await ia(),console.log("Smart sync completed")}catch(o){console.error("Error during smart sync:",o),console.log("Falling back to local data");const i=U(!1);i.length>0?(console.log("Found posts in local storage, rendering as fallback"),window.boardie.safeRenderPosts(i)):(console.log("No posts found in local storage, showing empty state"),window.boardie.showEmptyState())}}}catch(s){console.error("Error initializing authentication:",s),window.boardie.showEmptyState()}});window.boardie=window.boardie||{};window.boardie.inspectSchema=async()=>{try{const{logTableSchema:r,listTables:e}=await Q(()=>import("./schemaService-ffc02ce8.js"),[]);console.log("Available tables:");const t=await e();console.log(t),t.includes("posts")&&await r("posts"),t.includes("tags")&&await r("tags"),t.includes("post_tags")&&await r("post_tags")}catch(r){console.error("Error inspecting schema:",r)}};"serviceWorker"in navigator&&(window.addEventListener("load",()=>{navigator.serviceWorker.register("/service-worker.js").then(r=>{console.log("Service Worker registered with scope:",r.scope)}).catch(r=>{console.error("Service Worker registration failed:",r)})}),navigator.serviceWorker.addEventListener("message",r=>{r.data&&r.data.type==="share-target"&&(console.log("Received shared content:",r.data),$n(r.data))}));function $n(r){const{url:e,title:t,text:n}=r;if(!e){console.warn("No URL found in shared content");return}console.log("Processing shared URL:",e),De(e),Hr(e,[]).then(s=>{s?(console.log("Successfully added shared content to Boardie"),window.boardie&&window.boardie.isAuthenticated&&(console.log("Syncing with Supabase after adding shared content..."),_e().catch(o=>{console.error("Error syncing with Supabase after adding shared content:",o)}))):console.log("Duplicate URL detected, not adding shared content")}).catch(s=>{console.error("Error adding shared content to Boardie:",s)})}export{Ua as g,g as s};
